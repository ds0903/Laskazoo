{% extends 'zoosvit/core/base.html' %}
{% load static %}

{% block title %}{{ title }} – Ласка{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/catalog.css' %}">
  <link rel="stylesheet" href="{% static 'zoosvit/css/styles.css' %}">
{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumbs" aria-label="Breadcrumb">
  <a href="{% url 'home' %}">Головна</a>
  <span class="separator">›</span>
  <a href="{% url 'products:catalog' %}">Каталог</a>
  <span class="separator">›</span>
  <span class="current">{{ title }}</span>
</nav>
{% endblock %}

{% block content %}
<h1 class="catalog-page-heading">{{ title }}</h1>

<section class="catalog container catalog">
  <div class="catalog-wrapper">
    <aside class="filter-sidebar">
      <h3 class="fs-title">Фільтри</h3>

      <div class="fs-group">
        <p class="fs-group-title">Виробник</p>
        {% for b in brands %}
          <label>
            <input type="checkbox" name="brand" value="{{ b.slug }}"
                   {% if b.checked %}checked{% endif %}>
            {{ b.name }} <span>({{ b.count }})</span>
          </label>
        {% empty %}
          <p class="muted">Немає брендів у цій вибірці</p>
        {% endfor %}
      </div>

      <div class="fs-group">
        <p class="fs-group-title">Ціна, грн</p>
        <div class="range-inputs">
          <input type="number" name="price_min" placeholder="від" value="{{ price_min }}">
          <span>–</span>
          <input type="number" name="price_max" placeholder="до"  value="{{ price_max }}">
        </div>
        <label class="mt-8">
          <input type="checkbox" name="in_stock" {% if in_stock %}checked{% endif %}>
          В наявності
        </label>

        <button class="btn-secondary btn-filter-apply" onclick="applyFilters()">OK</button>
      </div>
    </aside>

    <main class="catalog-main">
      {% if products %}
      <div class="product-grid">
        {% for product in products %}
          <div class="prod-card">
            <!-- FRONT -->
            <div class="card-front">
              <a href="{{ product.get_absolute_url|default:'#' }}">
                {% if product.image %}
                  <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                  <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}">
                {% endif %}
              </a>
              <div class="card-article">Артикул: {{ product.sku|default:'—' }}</div>
              <h3 class="card-title">{{ product.name }}</h3>
              <div class="card-price">
                ₴ {{ product.variants_for_card.0.price|default:product.price }}
              </div>
            </div>

            <!-- BACK -->
            <div class="card-back">
              <a href="{{ product.get_absolute_url|default:'#' }}">
                {% if product.image %}
                  <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                  <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}">
                {% endif %}
                <div class="card-article">Артикул: {{ product.sku|default:'—' }}</div>
                <h3 class="card-title">{{ product.name }}</h3>
              </a>

              {% if product.variants_for_card %}
                <ul class="variants">
                  {% for v in product.variants_for_card|slice:":4" %}
                    <li class="variant-row">
                      <span class="v-meta">
                        {% if v.weight %}{{ v.weight }} г{% endif %}
                        {% if v.size %}{% if v.weight %} / {% endif %}{{ v.size }}{% endif %}
                        {% if v.color %} — {{ v.color }}{% endif %}
                        {% if not v.weight and not v.size and not v.color %}SKU: {{ v.sku }}{% endif %}
                      </span>
                      {% if v.stock|default:0 > 0 %}
                        <a class="btn add-to-cart" href="{% url 'orders:add' product.id %}">В кошик</a>
                      {% else %}
                        <button class="btn" disabled>Немає</button>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="no-variants">
                  <div class="card-price">₴ {{ product.price }}</div>
                </div>
              {% endif %}

              <div class="card-actions">
                <a class="btn add-to-cart" href="{% url 'orders:add' product.id %}">В кошик</a>

                <button
                  class="btn-fav js-fav {% if product.id in fav_ids %}active{% endif %}"
                  data-url="{% url 'favourites:toggle' product.id %}"
                  aria-label="В улюблені"
                  aria-pressed="{% if product.id in fav_ids %}true{% else %}false{% endif %}">
                  ❤️
                </button>
              </div>

              <div class="card-info">
                Виробник:
                {% if product.brand %}
                  <a class="info-link" href="{% url 'products:brand' product.brand.brand_slug %}">
                    {{ product.brand.name }}
                  </a>
                {% else %} — {% endif %}
              </div>

              <div class="card-info">
                Країна:
                {% if product.brand and product.brand.country_slug %}
                  <a class="info-link" href="{% url 'products:country' product.brand.country_slug %}">
                    {{ product.brand.country }}
                  </a>
                {% else %} — {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
    <div class="product-grid is-empty">
      <p class="no-favourites">У вас поки що немає обраних товарів. ;(</p>
    </div>
    {% endif %}
    </main>
  </div>
</section>

<script>
  // Збираємо чекбокси/поля і перезавантажуємо сторінку з query-параметрами
  function applyFilters() {
    const url = new URL(window.location.href);
    url.searchParams.delete('brand'); // очистити, потім додати вибрані

    document.querySelectorAll('input[name="brand"]:checked').forEach(cb => {
      url.searchParams.append('brand', cb.value);
    });

    const min = document.querySelector('input[name="price_min"]').value;
    const max = document.querySelector('input[name="price_max"]').value;
    const stock = document.querySelector('input[name="in_stock"]').checked;

    if (min) url.searchParams.set('price_min', min); else url.searchParams.delete('price_min');
    if (max) url.searchParams.set('price_max', max); else url.searchParams.delete('price_max');
    if (stock) url.searchParams.set('in_stock', '1'); else url.searchParams.delete('in_stock');

    window.location = url.toString();
  }
</script>

<script>
(function () {
  'use strict';

  /* ---------- УТИЛІТИ ---------- */
  const log = (...a) => console.debug('[card-height]', ...a);
  const $all = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  function debounce(fn, ms = 120){ let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} }
  const rerun = debounce(() => requestAnimationFrame(recomputeCardHeights), 60);

  /* ---------- СЛАЙДЕР ТОВАРІВ ---------- */
  function initProductSlider() {
    const w = document.querySelector('.product-slider');
    if (!w) return;
    const slider   = w.querySelector('.grid-slider');
    const leftBtn  = w.querySelector('.slide-btn.left');
    const rightBtn = w.querySelector('.slide-btn.right');

    const cs   = getComputedStyle(document.documentElement);
    const cardW= parseInt(cs.getPropertyValue('--prod-card-width'),10);
    const gap  = parseInt(cs.getPropertyValue('--prod-gap'),10);
    const perV = parseInt(cs.getPropertyValue('--prod-per-page'),10);
    const perS = parseInt(cs.getPropertyValue('--prod-scroll'),10);
    const total= w.querySelectorAll('.prod-card').length;

    const maxPage = Math.max(0, Math.ceil((total - perV) / perS));
    let page = 0;

    function go(delta){
      page = Math.min(maxPage, Math.max(0, page + delta));
      slider.style.transform = `translateX(-${page * perS * (cardW + gap)}px)`;
      leftBtn.style.display  = page === 0 ? 'none' : 'block';
      rightBtn.style.display = page >= maxPage ? 'none' : 'block';
      requestAnimationFrame(recomputeCardHeights); // після зсуву — перерахувати
    }
    leftBtn?.addEventListener('click',  ()=>go(-1));
    rightBtn?.addEventListener('click', ()=>go(+1));
    // первинний стан
    leftBtn && (leftBtn.style.display = 'none');
    rightBtn && (rightBtn.style.display = maxPage ? 'block':'none');
  }

/* ---------- ВИМІР ВИСОТИ КАРТКИ ---------- */
function measureBack(back){
  // тимчасово робимо видимим для правильного виміру
  const keep = {
    display: back.style.display,
    position: back.style.position,
    opacity: back.style.opacity,
    pointerEvents: back.style.pointerEvents,
    visibility: back.style.visibility,
    height: back.style.height,
    maxHeight: back.style.maxHeight
  };
  back.style.display       = 'block';
  back.style.position      = 'static';
  back.style.opacity       = '0';
  back.style.pointerEvents = 'none';
  back.style.visibility    = 'hidden';
  back.style.height        = 'auto';
  back.style.maxHeight     = 'none';

  // scrollHeight зазвичай стабільніший на прихованих елементах
  const h = Math.ceil(back.scrollHeight);

  Object.assign(back.style, keep);
  return h;
}

function recomputeCardHeights(){
  const cs  = getComputedStyle(document.documentElement);
  const MIN = parseInt(cs.getPropertyValue('--prod-min-height')) || 320;
  const MAX = parseInt(cs.getPropertyValue('--prod-max-height')) || 520;

  document.querySelectorAll('.prod-card').forEach((card, idx) => {
    const back = card.querySelector('.card-back');
    if (!back) return;

    const desired  = measureBack(back);
    const adjusted = Math.max(0, desired - 30);   // мінус 10px
    const clamped  = Math.min(MAX, Math.max(MIN, adjusted));

    card.style.setProperty('--hover-height', clamped + 'px');
    // console.log(`card #${idx}: desired=${desired} → adjusted=${adjusted} → ${clamped}`);
  });
}

  /* ---------- ТРИГЕРИ ПЕРЕРАХУНКУ ---------- */
  function initCardHeightAutofit(){
    // 1) коли все завантажилось (включно з картинками)
    if (document.readyState === 'complete') rerun();
    else window.addEventListener('load', rerun, {once:true});

    // 2) коли підтягнуться шрифти (змінюється перенесення рядків)
    if (document.fonts?.ready) document.fonts.ready.then(rerun);

    // 3) коли дозавантажиться будь-яка картинка у картках
    $all('.prod-card img').forEach(img=>{
      if (!img.complete) {
        img.addEventListener('load',  rerun, {once:true});
        img.addEventListener('error', rerun, {once:true});
      }
    });

    // 4) на зміну розміру/орієнтації
    window.addEventListener('resize', rerun);
    window.addEventListener('orientationchange', rerun);

    // 5) реагуємо на пізні зміни контенту всередині .card-back
    if ('ResizeObserver' in window) {
      const ro = new ResizeObserver(rerun);
      $all('.prod-card .card-back').forEach(el => ro.observe(el));
    }

    // 6) перший прохід + невелика страховка
    rerun();
    setTimeout(rerun, 800);
  }

  /* ---------- ТОЧКА ВХОДУ ---------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    initProductSlider();
    initCardHeightAutofit();
  });
})();
</script>

{% endblock %}

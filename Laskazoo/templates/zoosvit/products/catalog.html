{# templates/zoosvit/products/catalog.html - ОПТИМІЗОВАНА ВЕРСІЯ #}
{% extends 'zoosvit/core/base.html' %}
{% load static %}

{% block title %}Каталог – Ласка{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/catalog.css' %}">
  <link rel="stylesheet" href="{% static 'zoosvit/css/styles.css' %}">
  <script defer src="{% static 'zoosvit/js/fav.js' %}"></script>
  <script defer src="{% static 'zoosvit/js/product_cards.js' %}"></script>
  <script defer src="{% static 'zoosvit/js/filters.js' %}"></script>

  <style>
    /* ── горизонтальна стрічка кнопок категорій під шапкою ───────────── */
    .top-cats-bar{
      position: relative;
      z-index: 3;
      display:flex; flex-wrap:wrap; gap:10px;
      margin: 8px auto 18px; padding: 0 16px;
      max-width: 1200px;
    }
    .top-cats-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--color-primary);
      color:var(--color-primary); background:#fff; border-radius:999px;
      text-decoration:none; font-weight:600; font-size:.95rem;
      transition: background .2s, color .2s, transform .15s;
    }
    .top-cats-btn:hover{ background:rgba(9,94,86,.08); transform:translateY(-1px);}
    .top-cats-btn img{ width:20px; height:20px; object-fit:contain; }

    /* Оптимізовані стилі для карток товарів */
    .catalog.container { position: relative; z-index: 2; }
    .catalog-wrapper { display: flex;  align-items: flex-start; }
    .filter-sidebar { width: 260px; min-width: 240px; }


    /* Покращена система карток з кешованою висотою */
    .catalog .product-grid { 
      overflow: visible; 
      position: relative;
      contain: layout; /* CSS containment для кращої продуктивності */
    }
    
    .catalog .prod-card { 
      height: var(--prod-min-height, 320px); 
      overflow: visible; 
      position: relative; 
      background: transparent; 
      box-shadow: none;
      transform: translateZ(0); /* Створюємо композитний слой */
      will-change: z-index; /* Оптимізація для анімацій */
    }
    
    .catalog .prod-card::before {
      content: "";
      position: absolute;
      inset: 0 auto auto 0;
      right: 0;
      height: var(--prod-min-height, 320px);
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      transition: height .25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow .25s ease;
      z-index: 0;
      will-change: height, box-shadow;
    }
    
    .catalog .prod-card:hover { 
      z-index: 30; 
    }
    
    .catalog .prod-card:hover::before {
      height: clamp(
        var(--prod-min-height, 320px),
        var(--hover-height, var(--prod-min-height, 320px)),
        var(--prod-max-height, 820px)
      );
      box-shadow: 0 12px 24px rgba(0,0,0,.18);
    }
    
    .catalog .prod-card .card-front,
    .catalog .prod-card .card-back { 
      position: absolute; 
      inset: 0; 
      z-index: 1;
      backface-visibility: hidden; /* Оптимізація для перемикання */
    }
    
    /* Стилі для неактивних товарів */
    .prod-card.out-of-stock::before {
      background: #f5f5f5;
    }
    
    .prod-card.out-of-stock {
      opacity: 0.65;
    }
    
    .prod-card.out-of-stock img {
      filter: grayscale(100%);
    }
    
    .prod-card.out-of-stock .card-title,
    .prod-card.out-of-stock .card-price,
    .prod-card.out-of-stock .card-article {
      color: #999;
    }
    
    .prod-card.out-of-stock .add-to-cart {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .prod-card.out-of-stock .variant-pill {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Напис "Очікується поставка" */
    .prod-card.out-of-stock::after {
      content: 'Очікується \A поставка';
      white-space: pre;
      position: absolute;
      top: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      color: #666;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      z-index: 15;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      pointer-events: none;
    }

  </style>
{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumbs" aria-label="Breadcrumb">
  <a href="{% url 'home' %}">Головна</a>
  <span class="separator">›</span>
  <span class="current">Каталог</span>
</nav>
{% endblock %}

{% block content %}
<h1 class="catalog-page-heading">Каталог</h1>

{# ── Кнопки головних категорій під шапкою ── #}
<div class="top-cats-bar">
  {% for m in mains %}
    <a class="top-cats-btn" href="{% url 'products:subcategory_list' m.slug %}">
      {% if m.image %}
        <img src="{{ m.image.url }}" alt="{{ m.name }}" loading="lazy">
      {% endif %}
      {{ m.name }}
    </a>
  {% empty %}
    <span class="muted">Категорій поки немає</span>
  {% endfor %}
</div>

<section class="catalog container">
  <div class="catalog-wrapper">

    {# ── ЛІВИЙ ФІЛЬТР ── #}
    <aside class="filter-sidebar">
      <h3 class="fs-title">Фільтри</h3>

      <div class="fs-group">
        <p class="fs-group-title">Виробник</p>
        {% for b in brands %}
          <label>
            <input type="checkbox" name="brand" value="{{ b.slug }}"
                   {% if b.checked %}checked{% endif %}>
            {{ b.name }} <span>({{ b.count }})</span>
          </label>
        {% empty %}
          <p class="muted">Немає брендів у цій вибірці</p>
        {% endfor %}
      </div>

      <div class="fs-group">
        <p class="fs-group-title">Ціна, грн</p>
        <div class="range-inputs">
          <input type="number" name="price_min" placeholder="від" value="{{ price_min }}">
          <span>–</span>
          <input type="number" name="price_max" placeholder="до" value="{{ price_max }}">
        </div>
        <label class="stock-filter">
          <input type="checkbox" name="in_stock" {% if in_stock %}checked{% endif %}>
          <span>В наявності</span>
        </label>
      </div>
    </aside>

    {# ── ПРАВА ЧАСТИНА: УСІ ТОВАРИ ── #}
    <main class="catalog-main">
      {% if products %}
        {# Контроль кількості товарів на сторінці #}
        <div class="catalog-controls">
          <div class="results-info">
            Показано {{ products.start_index }}-{{ products.end_index }} з {{ products.paginator.count }} товарів
          </div>
          <div class="per-page-control">
            <label for="per-page-select">Товарів на сторінці:</label>
            <select id="per-page-select" onchange="changePerPage(this.value)">
              <option value="20" {% if current_per_page == 20 %}selected{% endif %}>20</option>
              <option value="40" {% if current_per_page == 40 %}selected{% endif %}>40</option>
              <option value="60" {% if current_per_page == 60 %}selected{% endif %}>60</option>
              <option value="100" {% if current_per_page == 100 %}selected{% endif %}>100</option>
            </select>
          </div>
        </div>
        
        <div class="product-grid">
          {% for product in products %}
  {% with v0=product.variants_for_card.0 %}
  <div class="prod-card {% if not product.is_active or product.warehouse_quantity == 0 or v0 and not v0.is_active or v0 and v0.warehouse_quantity == 0 %}out-of-stock{% endif %}" data-product-id="{{ product.id }}">
  {% endwith %}
    {# ---- FRONT ---- #}
    <div class="card-front">
      {% with v0=product.variants_for_card.0 %}
        <a href="{{ product.get_absolute_url|default:'#' }}">
          {% if v0 and v0.image %}
            <img src="{{ v0.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% elif product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% else %}
            <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% endif %}
        </a>
        <div class="card-article">Артикул: {{ product.sku|default:'—' }}</div>

        <h3 class="card-title" data-base-title="{{ product.name }}">
      {{ product.name }}
      {% if v0 %}
  {% if v0.weight or v0.size %}
    <span class="variant-suffix">
      {% if v0.weight %} — {{ v0.weight|floatformat:0 }} кг
      {% elif v0.size %} — {{ v0.size }}{% endif %}
    </span>
  {% endif %}
{% endif %}
    </h3>

        <div class="card-price">₴ {{ v0.retail_price|default:product.retail_price }}</div>
      {% endwith %}
    </div>

    {# ---- BACK ---- #}
    <div class="card-back">
      {% with v0=product.variants_for_card.0 %}
        <a href="{{ product.get_absolute_url|default:'#' }}">
          {% if v0 and v0.image %}
            <img src="{{ v0.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% elif product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% else %}
            <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% endif %}
          <div class="card-article">Артикул: {{ product.sku|default:'—' }}</div>
          <h3 class="card-title" data-base-title="{{ product.name }}">
      {{ product.name }}
      {% if v0 %}
  {% if v0.weight or v0.size %}
    <span class="variant-suffix">
      {% if v0.weight %} — {{ v0.weight|floatformat:0 }} кг
      {% elif v0.size %} — {{ v0.size }}{% endif %}
    </span>
  {% endif %}
{% endif %}
    </h3>
        </a>

        <div class="card-price">₴ {{ v0.retail_price|default:product.retail_price }}</div>

        {# Пігулки варіантів (як на головній) #}
        {% if product.variants_for_card|length > 1 %}
          {% with vfirst=product.variants_for_card.0 %}
            <div class="variant-group">
              <div class="variant-label">
                {% if vfirst.weight %}Фасування{% elif vfirst.size %}Розмір{% else %}Варіанти{% endif %}
              </div>
              <div class="variant-pills" role="group" aria-label="Варіанти">
                {% for v in product.variants_for_card|slice:":3" %}
                  <button
                    type="button"
                    class="variant-pill {% if forloop.first %}active{% endif %}"
                    data-vid="{{ v.id }}"
                    data-price="{{ v.retail_price }}"
                    data-sku="{{ v.sku }}"
                    data-weight="{{ v.weight|default:'' }}"
                    data-size="{{ v.size|default:'' }}"
                    data-image="{% if v.image %}{{ v.image.url }}{% elif product.image %}{{ product.image.url }}{% else %}{% static 'zoosvit/img/food1.jpg' %}{% endif %}">
                    {% if v.weight %}{{ v.weight|floatformat:0 }} кг
                    {% elif v.size %}{{ v.size }}
                    {% else %}SKU {{ v.sku }}{% endif %}
                  </button>
                {% endfor %}
              </div>
            </div>
          {% endwith %}
        {% endif %}

        <div class="card-actions">
    {% with v0=product.variants_for_card.0 %}
  <a class="btn add-to-cart"
     href="{% url 'orders:add' product.id %}{% if v0 %}?variant={{ v0.id }}{% endif %}"
     data-add-base="{% url 'orders:add' product.id %}">
    В кошик
  </a>

  {# Підсвічуємо лише якщо поточний варіант у вибраному #}
  <button
    class="btn-fav js-fav {% if v0 and v0.id in fav_variant_ids %}is-on{% endif %}"
    data-url="{% url 'favourites:toggle' product.id %}"
    data-variant="{% if v0 %}{{ v0.id }}{% endif %}"
    aria-pressed="{% if v0 and v0.id in fav_variant_ids %}true{% else %}false{% endif %}">
    ❤️
  </button>
{% endwith %}

  </div>

        <div class="card-info">
          Виробник:
          {% if product.brand %}
            <a class="info-link" href="{% url 'products:brand' product.brand.brand_slug %}">{{ product.brand.name }}</a>
          {% else %} — {% endif %}
        </div>
      {% endwith %}
    </div>
  </div>
{% endfor %}

        </div>
        
        {# Пагінація #}
        {% if products.has_other_pages %}
          <div class="pagination-wrapper">
            <nav class="pagination" aria-label="Пагінація">
              {% if products.has_previous %}
                <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ products.previous_page_number }}" class="page prev" aria-label="Попередня сторінка">« Назад</a>
              {% endif %}
              
              {% for num in products.paginator.page_range %}
                {% if num == products.number %}
                  <span class="page active" aria-current="page">{{ num }}</span>
                {% elif num > products.number|add:"-3" and num < products.number|add:"3" %}
                  <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}" class="page">{{ num }}</a>
                {% elif num == 1 or num == products.paginator.num_pages %}
                  <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}" class="page">{{ num }}</a>
                {% elif num == products.number|add:"-4" or num == products.number|add:"4" %}
                  <span class="page ellipsis">…</span>
                {% endif %}
              {% endfor %}
              
              {% if products.has_next %}
                <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ products.next_page_number }}" class="page next" aria-label="Наступна сторінка">Далі »</a>
              {% endif %}
            </nav>
          </div>
        {% endif %}
      {% else %}
        <div class="product-grid is-empty">
          <p class="no-favourites">Немає товарів за обраними фільтрами ;(</p>
        </div>
      {% endif %}
    </main>
  </div>
</section>

<script>
// Функція для зміни кількості товарів на сторінці
function changePerPage(perPage) {
  const url = new URL(window.location);
  url.searchParams.set('per_page', perPage);
  url.searchParams.delete('page'); // скидаємо номер сторінки, щоб почати з першої
  window.location.href = url.toString();
}

// Оптимізація: Повідомляємо product_cards.js що сторінка завантажена
document.addEventListener('DOMContentLoaded', function() {
  console.log('[CATALOG] Page loaded, product cards optimization active');
  
  // Якщо є callback для завершення preload - можна додати індикатор
  window.onCardPreloadComplete = function() {
    console.log('[CATALOG] All product cards optimized');
    // Можна додати візуальний індикатор що завантаження завершено
  };
});
</script>
{% endblock %}

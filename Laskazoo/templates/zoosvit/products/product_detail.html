{% extends 'zoosvit/core/base.html' %}
{% load static %}

{% block title %}{{ product.name }} ‚Äì –õ–∞—Å–∫–∞{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/catalog.css' %}">
  <link rel="stylesheet" href="{% static 'zoosvit/css/styles.css' %}">
  <script defer src="{% static 'zoosvit/js/fav.js' %}"></script>
  <style>
    /* === –û–ù–û–í–õ–ï–ù–ê –°–¢–û–†–Ü–ù–ö–ê –¢–û–í–ê–†–£ –ó–ê –ó–†–ê–ó–ö–û–ú –ö–û–ù–ö–£–†–ï–ù–¢–Ü–í === */
    
    /* –ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É –Ω–∞–¥ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—î—é */
    .product-page-title {
      background: #f8f9fa;
      padding: 15px 0;
      margin-bottom: 20px;
      border-bottom: 2px solid #e9ecef;
    }
    
    .product-page-title .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .product-page-title h1 {
      font-size: 1.8rem;
      color: var(--color-primary);
      margin: 0;
      font-weight: 700;
    }
    
    .product-detail {
      margin: 0 auto;
      max-width: 1200px;
      padding: 0 20px;
    }
    
    .detail-wrapper {
      display: grid;
      grid-template-columns: 400px 300px 1fr;
      gap: 40px;
      align-items: start;
      margin-bottom: 40px;
    }
    
    /* –õ–Ü–í–ê –ö–û–õ–û–ù–ö–ê - –§–û–¢–û */
    .image-section {
      position: sticky;
      top: 20px;
    }
    
    .main-image {
      width: 100%;
      height: 400px;
      background: #fff;
      border-radius: 16px;
      border: 2px solid #f0f0f0;
      overflow: hidden;
      margin-bottom: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      position: relative;
    }
    
    .main-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 15px;
      background: #fff;
    }
    
    .thumbnail-gallery {
      display: flex;
      gap: 8px;
      justify-content: flex-start;
      flex-wrap: wrap;
    }
    
    .thumbnail {
      width: 60px;
      height: 60px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: border-color 0.3s;
      background: #fff;
    }
    
    .thumbnail:hover,
    .thumbnail.active {
      border-color: var(--color-primary);
    }
    
    .thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 5px;
    }
    
    /* –¶–ï–ù–¢–†–ê–õ–¨–ù–ê –ö–û–õ–û–ù–ö–ê - –Ü–ù–§–û–†–ú–ê–¶–Ü–Ø */
    .product-info-section {
      padding: 10px 0;
    }
    
    .product-sku {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 16px;
      font-weight: 500;
    }
    
    .product-actions {
      margin-bottom: 20px;
    }
    
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .btn-favorite {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #fff;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      color: #666;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      width: 100%;
      justify-content: flex-start;
    }
    
    .btn-favorite:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }
    
    /* –ê–ö–¢–ò–í–ù–ò–ô —Å—Ç–∞–Ω –æ–±—Ä–∞–Ω–æ–≥–æ - —Å–∞–ª–∞—Ç–æ–≤–∏–π –∫–æ–ª—ñ—Ä */
    .btn-favorite.is-on {
      background: var(--badge-green, #27ae60);
      border-color: var(--badge-green, #27ae60);
      color: #fff;
    }
    
    .btn-favorite.is-on:hover {
      background: var(--badge-green, #27ae60);
      border-color: var(--badge-green, #27ae60);
      color: #fff;
      opacity: 0.9;
    }
    
    .btn-compare {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #fff;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      text-decoration: none;
      color: #666;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .btn-compare:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }
    
    .product-meta {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .meta-row:last-child {
      border-bottom: none;
    }
    
    .meta-label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
    }
    
    .meta-value {
      color: #333;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .meta-value a {
      color: var(--color-primary);
      text-decoration: none;
    }
    
    .meta-value a:hover {
      text-decoration: underline;
    }
    
    /* –ü–†–ê–í–ê –ö–û–õ–û–ù–ö–ê - –ö–£–ü–Ü–í–õ–Ø */
    .purchase-section {
      padding: 20px;
      background: #fff;
      border: 2px solid #f0f0f0;
      border-radius: 16px;
      position: sticky;
      top: 20px;
    }
    
    /* –í–∞—Ä—ñ–∞–Ω—Ç–∏ —Ñ–∞—Å—É–≤–∞–Ω–Ω—è */
    .variants-section {
      margin-bottom: 20px;
    }
    
    .variants-title {
      font-size: 1rem;
      color: var(--color-primary);
      margin-bottom: 12px;
      font-weight: 600;
    }
    
    .variants-grid {
      display: grid;
      gap: 8px;
    }
    
    .variant-card {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
      text-align: left;
    }
    
    .variant-card:hover {
      border-color: var(--color-primary);
      background: rgba(9,94,86,0.05);
    }
    
    .variant-card.selected {
      border-color: var(--color-primary);
      background: rgba(9,94,86,0.1);
    }
    
    .variant-weight {
      font-weight: 600;
      color: var(--color-primary);
      font-size: 0.95rem;
      margin-bottom: 4px;
    }
    
    .variant-price {
      font-size: 1.1rem;
      font-weight: 700;
      color: #333;
    }
    
    /* –¶—ñ–Ω–∏ */
    .price-section {
      margin-bottom: 20px;
      text-align: center;
    }
    
    .price-wrapper {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .price-old {
      font-size: 1.2rem;
      color: #999;
      text-decoration: line-through;
    }
    
    .price-current {
      font-size: 2rem;
      color: var(--color-primary);
      font-weight: 800;
    }
    
    .price-discount {
      background: #dc3545;
      color: #fff;
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    /* –ö–Ω–æ–ø–∫–∞ –∫—É–ø–∏—Ç–∏ */
    .buy-button {
      width: 100%;
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--color-primary) 0%, #0a6b61 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(9,94,86,0.3);
      margin-bottom: 20px;
    }
    
    .buy-button:hover {
      background: linear-gradient(135deg, #0a6b61 0%, var(--color-primary) 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(9,94,86,0.4);
      color: #fff;
    }
    
    /* –°—Ç–∏–ª—ñ –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤ */
    .product-detail.out-of-stock .main-image img {
      filter: grayscale(100%);
      opacity: 0.6;
    }
    
    .product-detail.out-of-stock .buy-button {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
      pointer-events: none;
      box-shadow: none;
    }
    
    .variant-card.out-of-stock {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .variant-card.out-of-stock::after {
      content: '–ù–µ–º–∞—î';
      display: block;
      font-size: 0.8rem;
      color: #e74c3c;
      font-weight: 600;
      margin-top: 4px;
    }
    
    /* –ù–∞–ø–∏—Å "–û—á—ñ–∫—É—î—Ç—å—Å—è –ø–æ—Å—Ç–∞–≤–∫–∞" –Ω–∞ —Ñ–æ—Ç–æ */
    .product-detail.out-of-stock .main-image::after {
      content: '–û—á—ñ–∫—É—î—Ç—å—Å—è \A –ø–æ—Å—Ç–∞–≤–∫–∞';
      white-space: pre;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      color: #666;
      padding: 16px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      text-align: center;
      z-index: 10;
      box-shadow: 0 2px 12px rgba(0,0,0,0.2);
      pointer-events: none;
    }
    
    /* –û–ø–ª–∞—Ç–∞ —Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ */
    .payment-delivery {
      font-size: 0.9rem;
      color: #666;
    }
    
    .payment-section,
    .delivery-section {
      margin-bottom: 16px;
    }
    
    .section-title {
      font-weight: 600;
      color: var(--color-primary);
      margin-bottom: 6px;
    }
    
    .payment-methods,
    .delivery-methods {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .payment-method,
    .delivery-method {
      background: #f8f9fa;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      border: 1px solid #e0e0e0;
    }
    
    /* –û–ü–ò–° –¢–û–í–ê–†–£ */
    .description-section {
      margin-top: 40px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .description-title {
      font-size: 1.5rem;
      color: var(--color-primary);
      margin-bottom: 20px;
      font-weight: 600;
      padding-left: 20px;
    }
    
    .description-content {
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      border: 2px solid #f0f0f0;
      line-height: 1.7;
      color: #555;
      font-size: 1rem;
    }
    
    .description-placeholder {
      color: #888;
      font-style: italic;
      background: #f8f9fa;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
    }
    
    /* –ú–û–ë–Ü–õ–¨–ù–ê –ê–î–ê–ü–¢–ê–¶–Ü–Ø */
    @media (max-width: 992px) {
      .detail-wrapper {
        grid-template-columns: 1fr;
        gap: 30px;
      }
      
      .purchase-section {
        position: static;
      }
      
      .main-image {
        height: 300px;
      }
    }
    
    @media (max-width: 768px) {
      .product-page-title h1 {
        font-size: 1.4rem;
      }
      
      .main-image {
        height: 250px;
      }
      
      .price-current {
        font-size: 1.6rem;
      }
      
      .variants-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumbs" aria-label="Breadcrumb">
  <div class="container">
    <a href="{% url 'home' %}">–ì–æ–ª–æ–≤–Ω–∞</a>
    <span class="separator">‚Ä∫</span>

    <a href="{% url 'products:catalog' %}">–ö–∞—Ç–∞–ª–æ–≥</a>
    <span class="separator">‚Ä∫</span>

    <a href="{% url 'products:subcategory_list' main_slug %}">
      {{ category.main_category.name }}
    </a>
    <span class="separator">‚Ä∫</span>

    <a href="{% url 'products:category_products' main_slug category.slug %}">
      {{ category.name }}
    </a>
    <span class="separator">‚Ä∫</span>

    <span class="current">{{ product.name }}</span>
  </div>
</nav>
{% endblock %}

{% block content %}
<!-- –ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É –Ω–∞–¥ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—î—é -->
<div class="product-page-title">
  <div class="container">
    <h1>{{ product.name }}</h1>
  </div>
</div>

<section class="product-detail {% if not product.is_active or product.warehouse_quantity == 0 %}out-of-stock{% endif %}">
  <div class="detail-wrapper">
    {# --- –õ–Ü–í–ê –ö–û–õ–û–ù–ö–ê: –§–û–¢–û --- #}
    <div class="image-section">
      <div class="main-image">
        {% if product.image %}
          <img src="{{ product.image.url }}" alt="{{ product.name }}" id="main-product-image">
        {% else %}
          <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}" id="main-product-image">
        {% endif %}
      </div>
      
      <div class="thumbnail-gallery">
        <div class="thumbnail active">
          {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
          {% else %}
            <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}">
          {% endif %}
        </div>
        
        {# –í–∞—Ä—ñ–∞–Ω—Ç–∏ —Ñ–æ—Ç–æ –∑ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ —Ç–æ–≤–∞—Ä—É #}
        {% for variant in variants %}
          {% if variant.image %}
            <div class="thumbnail">
              <img src="{{ variant.image.url }}" alt="{{ variant.name|default:product.name }}">
            </div>
          {% endif %}
        {% endfor %}
        
        {# –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∏ –¥–ª—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —Ñ–æ—Ç–æ #}
        {% if variants|length < 3 %}
          <div class="thumbnail" style="opacity: 0.3; border-style: dashed;">
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ccc; font-size: 16px;">+</div>
          </div>
          <div class="thumbnail" style="opacity: 0.3; border-style: dashed;">
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ccc; font-size: 16px;">+</div>
          </div>
        {% endif %}
      </div>
    </div>

    {# --- –¶–ï–ù–¢–†–ê–õ–¨–ù–ê –ö–û–õ–û–ù–ö–ê: –Ü–ù–§–û–†–ú–ê–¶–Ü–Ø --- #}
    <div class="product-info-section">
      {% if product.sku %}
        <p class="product-sku">–ê—Ä—Ç–∏–∫—É–ª: {{ product.sku }}</p>
      {% endif %}
      
      {# –ö–Ω–æ–ø–∫–∏ –¥—ñ–π #}
      <div class="product-actions">
        <div class="action-buttons">
          <button class="btn-favorite js-fav{% if variants.0 and variants.0.id in fav_variant_ids %} is-on{% elif product.id in fav_product_ids %} is-on{% endif %}" 
                  data-url="{% url 'favourites:toggle' product.id %}" 
                  data-variant="{% if variants.0 %}{{ variants.0.id }}{% endif %}"
                  data-product="{{ product.id }}"
                  aria-pressed="{% if variants.0 and variants.0.id in fav_variant_ids %}true{% elif product.id in fav_product_ids %}true{% else %}false{% endif %}"
                  type="button"
                  id="favorite-btn">
            <span>‚ô•</span>
            <span id="favorite-text">{% if variants.0 and variants.0.id in fav_variant_ids %}–í–∏–¥–∞–ª–∏—Ç–∏ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ{% elif product.id in fav_product_ids %}–í–∏–¥–∞–ª–∏—Ç–∏ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ{% else %}–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ{% endif %}</span>
          </button>
          <!-- –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø–æ–∫–∏ —â–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ, –±–æ —É –Ω–∞—Å –π–æ–≥–æ –Ω–µ–º–∞—î
          <a href="#" class="btn-compare">
            <span>‚öñ</span>
            –ü–æ—Ä—ñ–≤–Ω—è—Ç–∏
          </a>
          -->
        </div>
      </div>
      
      {# –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä—É #}
      <div class="product-meta">
        {% if product.brand %}
          <div class="meta-row">
            <span class="meta-label">–í–∏—Ä–æ–±–Ω–∏–∫:</span>
            <span class="meta-value">
              <a href="{% url 'products:brand' product.brand.brand_slug %}">{{ product.brand.name }}</a>
            </span>
          </div>
        {% endif %}
        
        {% if product.brand.country %}
          <div class="meta-row">
            <span class="meta-label">–ö—Ä–∞—ó–Ω–∞-–≤–∏—Ä–æ–±–Ω–∏–∫:</span>
            <span class="meta-value">
              <a href="{% url 'products:country' product.brand.country_slug %}">{{ product.brand.country }}</a>
            </span>
          </div>
        {% endif %}
        
        <div class="meta-row">
          <span class="meta-label">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</span>
          <span class="meta-value">
            <a href="{% url 'products:category_products' main_slug category.slug %}">{{ product.category.name }}</a>
          </span>
        </div>
        
        <div class="meta-row">
          <span class="meta-label">–ù–∞—è–≤–Ω—ñ—Å—Ç—å:</span>
          <span class="meta-value">
            {% if product.warehouse_quantity > 0 %}
              <span style="color: #27ae60; font-weight: 600;">‚úì –í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
            {% else %}
              <span style="color: #e74c3c; font-weight: 600;">‚ö† –ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
            {% endif %}
          </span>
        </div>
      </div>
    </div>

    {# --- –ü–†–ê–í–ê –ö–û–õ–û–ù–ö–ê: –ö–£–ü–Ü–í–õ–Ø --- #}
    <div class="purchase-section">
      {# –í–∞—Ä—ñ–∞–Ω—Ç–∏ —Ñ–∞—Å—É–≤–∞–Ω–Ω—è #}
      {% if variants %}
        <div class="variants-section">
          <h3 class="variants-title">–§–∞—Å—É–≤–∞–Ω–Ω—è:</h3>
          <div class="variants-grid">
            {% for v in variants %}
              <div class="variant-card {% if not v.is_active or v.warehouse_quantity == 0 %}out-of-stock{% endif %}" data-variant-id="{{ v.id }}" data-price="{{ v.retail_price }}" data-discount-price="{{ v.retail_price_with_discount }}">
                <div class="variant-weight">
                  {% if v.weight %}{{ v.weight }} –≥{% endif %}
                  {% if v.size %}{{ v.size }}{% endif %}
                  {% if not v.weight and not v.size %}–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π{% endif %}
                </div>
                <div class="variant-price">‚Ç¥ {{ v.retail_price }}</div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {# –¶—ñ–Ω–∞ #}
      <div class="price-section">
        <div class="price-wrapper">
          <div class="price-current" id="current-price">
            ‚Ç¥ {{ product.retail_price }}
          </div>
          {% if product.retail_price_with_discount and product.retail_price_with_discount > 0 and product.retail_price_with_discount < product.retail_price %}
            <div class="price-old">‚Ç¥ {{ product.retail_price }}</div>
            <div class="price-discount">-{{ product.retail_price|floatformat:0|add:"-"|add:product.retail_price_with_discount|floatformat:0 }} –≥—Ä–Ω</div>
          {% endif %}
        </div>
      </div>

      {# –ö–Ω–æ–ø–∫–∞ –∫—É–ø–∏—Ç–∏ #}
      <a class="buy-button add-to-cart" href="{% url 'orders:add' product.id %}" id="add-to-cart-link">
        <span>üõí</span>
        –ö—É–ø–∏—Ç–∏
      </a>

      {# –û–ø–ª–∞—Ç–∞ #}
      <div class="payment-delivery">
        <div class="payment-section">
          <div class="section-title">üí≥ –û–ø–ª–∞—Ç–∞:</div>
          <div class="payment-methods">
            <span class="payment-method">Visa/Mastercard</span>
            <span class="payment-method">Apple Pay</span>
            <span class="payment-method">Google Pay</span>
          </div>
        </div>

        {# –î–æ—Å—Ç–∞–≤–∫–∞ #}
        <div class="delivery-section">
          <div class="section-title">üöö –î–æ—Å—Ç–∞–≤–∫–∞:</div>
          <div class="delivery-methods">
            <span class="delivery-method">–ù–æ–≤–∞ –ø–æ—à—Ç–∞</span>
            <span class="delivery-method">–£–∫—Ä–ø–æ—à—Ç–∞</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{# –û–ü–ò–° –¢–û–í–ê–†–£ #}
<section class="description-section">
  <h3 class="description-title">–û–ø–∏—Å</h3>
  {% if product.description %}
    <div class="description-content">
      {{ product.description|linebreaks }}
    </div>
  {% else %}
    <div class="description-content">
      <div class="description-placeholder">
        üìÑ –û–ø–∏—Å —Ç–æ–≤–∞—Ä—É –±—É–¥–µ –¥–æ–¥–∞–Ω–æ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º.
        <br><small>–ü–æ –≤—Å—ñ—Ö –ø–∏—Ç–∞–Ω–Ω—è—Ö –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—å –¥–æ –Ω–∞—à–∏—Ö –º–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤.</small>
      </div>
    </div>
  {% endif %}
</section>

<script>
  // –ü–µ—Ä–µ–¥–∞—î–º–æ –¥–∞–Ω—ñ –ø—Ä–æ –æ–±—Ä–∞–Ω—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –≤ JavaScript
  const favVariantIds = [{% for vid in fav_variant_ids %}{{ vid }}{% if not forloop.last %},{% endif %}{% endfor %}];
  const favProductIds = [{% for pid in fav_product_ids %}{{ pid }}{% if not forloop.last %},{% endif %}{% endfor %}];
  const productId = {{ product.id }};
  
  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞–Ω–æ–≥–æ
  function updateFavoriteButton(variantId) {
    const favBtn = document.getElementById('favorite-btn');
    const favText = document.getElementById('favorite-text');
    
    if (!favBtn || !favText) return;
    
    let isInFavorites = false;
    
    if (variantId) {
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤–∞—Ä—ñ–∞–Ω—Ç –≤ –æ–±—Ä–∞–Ω–æ–º—É
      isInFavorites = favVariantIds.includes(parseInt(variantId));
      favBtn.setAttribute('data-variant', variantId);
    } else {
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –ø—Ä–æ–¥—É–∫—Ç –≤ –æ–±—Ä–∞–Ω–æ–º—É (–±–µ–∑ –≤–∞—Ä—ñ–∞–Ω—Ç–∞)
      isInFavorites = favProductIds.includes(productId);
      favBtn.removeAttribute('data-variant');
    }
    
    if (isInFavorites) {
      favBtn.classList.add('is-on');
      favBtn.setAttribute('aria-pressed', 'true');
      favText.textContent = '–í–∏–¥–∞–ª–∏—Ç–∏ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ';
    } else {
      favBtn.classList.remove('is-on');
      favBtn.setAttribute('aria-pressed', 'false');
      favText.textContent = '–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ';
    }
  }
  
  // –°–ª—É—Ö–∞—á –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∫–ª—ñ–∫—É –ø–æ –∫–Ω–æ–ø—Ü—ñ –æ–±—Ä–∞–Ω–æ–≥–æ —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É
  document.addEventListener('click', function(e) {
    const favBtn = e.target.closest('#favorite-btn');
    if (!favBtn) return;
    
    e.preventDefault();
    
    // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π ID –≤–∞—Ä—ñ–∞–Ω—Ç–∞
    const currentVariantId = favBtn.getAttribute('data-variant');
    const variantIdNum = currentVariantId ? parseInt(currentVariantId) : null;
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω—ñ –º–∞—Å–∏–≤–∏
    const currentlyInFavorites = variantIdNum 
      ? favVariantIds.includes(variantIdNum)
      : favProductIds.includes(productId);
    
    if (currentlyInFavorites) {
      // –í–∏–¥–∞–ª—è—î–º–æ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ
      if (variantIdNum) {
        const idx = favVariantIds.indexOf(variantIdNum);
        if (idx > -1) favVariantIds.splice(idx, 1);
      } else {
        const idx = favProductIds.indexOf(productId);
        if (idx > -1) favProductIds.splice(idx, 1);
      }
    } else {
      // –î–æ–¥–∞—î–º–æ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ
      if (variantIdNum) {
        if (!favVariantIds.includes(variantIdNum)) {
          favVariantIds.push(variantIdNum);
        }
      } else {
        if (!favProductIds.includes(productId)) {
          favProductIds.push(productId);
        }
      }
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –≤–∏–≥–ª—è–¥ –∫–Ω–æ–ø–∫–∏
    updateFavoriteButton(currentVariantId);
  });
  
  // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –º—ñ–∂ –≤–∞—Ä—ñ–∞–Ω—Ç–∞–º–∏
  document.querySelectorAll('.variant-card').forEach(card => {
    card.addEventListener('click', () => {
      // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –∑ —É—Å—ñ—Ö –∫–∞—Ä—Ç–æ–∫
      document.querySelectorAll('.variant-card').forEach(c => c.classList.remove('selected'));
      
      // –í—ñ–¥–∑–Ω–∞—á–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—É –∫–∞—Ä—Ç–∫—É
      card.classList.add('selected');
      
      // –û–Ω–æ–≤–ª—é—î–º–æ —Ü—ñ–Ω—É
      const price = card.dataset.price;
      const discountPrice = card.dataset.discountPrice;
      const priceElement = document.getElementById('current-price');
      
      if (priceElement) {
        // –Ø–∫—â–æ —î —Ü—ñ–Ω–∞ –∑—ñ –∑–Ω–∏–∂–∫–æ—é —ñ –≤–æ–Ω–∞ –º–µ–Ω—à–∞ –∑–∞ –∑–≤–∏—á–∞–π–Ω—É —Ü—ñ–Ω—É
        if (discountPrice && parseFloat(discountPrice) > 0 && parseFloat(discountPrice) < parseFloat(price)) {
          priceElement.innerHTML = '‚Ç¥ ' + discountPrice;
          // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –ø–æ–∫–∞–∑—É —Å—Ç–∞—Ä–æ—ó —Ü—ñ–Ω–∏
        } else {
          priceElement.innerHTML = '‚Ç¥ ' + price;
        }
      }
      
      // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫–æ—à–∏–∫
      const variantId = card.dataset.variantId;
      const addToCartLink = document.getElementById('add-to-cart-link');
      if (addToCartLink && variantId) {
        const baseUrl = '{% url "orders:add" product.id %}';
        addToCartLink.href = baseUrl + '?variant=' + variantId;
      }
      
      // –û–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É –æ–±—Ä–∞–Ω–æ–≥–æ
      updateFavoriteButton(variantId);
    });
  });
  
  // –í–∏–±–∏—Ä–∞—î–º–æ –ø–µ—Ä—à–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
  const firstVariant = document.querySelector('.variant-card');
  if (firstVariant) {
    firstVariant.click();
  } else {
    // –Ø–∫—â–æ –Ω–µ–º–∞—î –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤, –æ–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç—É
    updateFavoriteButton(null);
  }
  
  // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ñ–æ—Ç–æ –≤ –≥–∞–ª–µ—Ä–µ—ó
  document.querySelectorAll('.thumbnail').forEach(thumb => {
    thumb.addEventListener('click', () => {
      const img = thumb.querySelector('img');
      if (img && img.src) {
        // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π –∫–ª–∞—Å –∑ —É—Å—ñ—Ö –º—ñ–Ω—ñ–∞—Ç—é—Ä
        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
        // –î–æ–¥–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π –∫–ª–∞—Å –¥–æ –ø–æ—Ç–æ—á–Ω–æ—ó
        thumb.classList.add('active');
        // –ó–º—ñ–Ω—é—î–º–æ –æ—Å–Ω–æ–≤–Ω–µ —Ñ–æ—Ç–æ
        const mainImg = document.getElementById('main-product-image');
        if (mainImg) {
          mainImg.src = img.src;
          mainImg.alt = img.alt;
        }
      }
    });
  });
</script>
{% endblock %}
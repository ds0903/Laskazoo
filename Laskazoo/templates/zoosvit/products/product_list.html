{% extends 'zoosvit/core/base.html' %}
{% load static %}

{% block title %}{{ title }} – Ласка{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/catalog.css' %}">
  <link rel="stylesheet" href="{% static 'zoosvit/css/styles.css' %}">
  <script defer src="{% static 'zoosvit/js/fav.js' %}"></script>
  <script defer src="{% static 'zoosvit/js/product_cards.js' %}"></script>
  <script defer src="{% static 'zoosvit/js/filters.js' %}"></script>
{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumbs" aria-label="Breadcrumb">
  <a href="{% url 'home' %}">Головна</a>
  <span class="separator">›</span>
  <a href="{% url 'products:catalog' %}">Каталог</a>
  <span class="separator">›</span>
  <span class="current">{{ title }}</span>
</nav>
{% endblock %}

{% block content %}
<h1 class="catalog-page-heading">{{ title }}</h1>

<section class="catalog container catalog">
  <div class="catalog-wrapper">
    <aside class="filter-sidebar">
      <h3 class="fs-title">Фільтри</h3>

      <div class="fs-group">
        <p class="fs-group-title">Виробник</p>
        {% for b in brands %}
          <label>
            <input type="checkbox" name="brand" value="{{ b.slug }}"
                   {% if b.checked %}checked{% endif %}>
            {{ b.name }} <span>({{ b.count }})</span>
          </label>
        {% empty %}
          <p class="muted">Немає брендів у цій вибірці</p>
        {% endfor %}
      </div>

      <div class="fs-group">
        <p class="fs-group-title">Ціна, грн</p>
        <div class="range-inputs">
          <input type="number" name="price_min" placeholder="від" value="{{ price_min }}">
          <span>–</span>
          <input type="number" name="price_max" placeholder="до"  value="{{ price_max }}">
        </div>
        <label class="mt-8">
          <input type="checkbox" name="in_stock" {% if in_stock %}checked{% endif %}>
          В наявності
        </label>

        <button class="btn-secondary btn-filter-apply" onclick="applyFilters()">OK</button>
      </div>
    </aside>

    <main class="catalog-main">
      {% if products %}
      <div class="product-grid">
        {% for product in products %}
          <div class="prod-card">
            <!-- FRONT -->
            <div class="card-front">
              <a href="{{ product.get_absolute_url|default:'#' }}">
                {% if product.image %}
                  <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                  <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}">
                {% endif %}
              </a>
                <div class="card-article">Артикул: {{ product.sku|default:'—' }}</div>
              <h3 class="card-title">{{ product.name }}</h3>
              <div class="card-price">
                ₴ {{ product.variants_for_card.0.retail_price|default:product.retail_price }}
              </div>
            </div>

            <!-- BACK -->
            <div class="card-back">
              <a href="{{ product.get_absolute_url|default:'#' }}">
                {% if product.image %}
                  <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                  <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}">
                {% endif %}
                  <div class="card-article">Артикул: {{ product.sku|default:'—' }}</div>
                <h3 class="card-title">{{ product.name }}</h3>
              </a>

              {% if product.variants_for_card %}
                <ul class="variants">
                  {% for v in product.variants_for_card|slice:":4" %}
                    <li class="variant-row">
                      <span class="v-meta">
                        {% if v.weight %}{{ v.weight }} г{% endif %}
                        {% if v.size %}{% if v.weight %} / {% endif %}{{ v.size }}{% endif %}
                        {% if v.color %} — {{ v.color }}{% endif %}
                        {% if not v.weight and not v.size and not v.color %}SKU: {{ v.sku }}{% endif %}
                      </span>
                      {% if v.warehouse_quantity|default:0 > 0 %}
                        <a class="btn add-to-cart" href="{% url 'orders:add' product.id %}">В кошик</a>
                      {% else %}
                        <button class="btn" disabled>Немає</button>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="no-variants">
                  <div class="card-price">₴ {{ product.retail_price }}</div>
                </div>
              {% endif %}

              <div class="card-actions">
                <a class="btn add-to-cart" href="{% url 'orders:add' product.id %}">В кошик</a>

                <button
                  class="btn-fav js-fav {% if product.id in fav_ids %}active{% endif %}"
                  data-url="{% url 'favourites:toggle' product.id %}"
                  aria-label="В улюблені"
                  aria-pressed="{% if product.id in fav_ids %}true{% else %}false{% endif %}">
                  ❤️
                </button>
              </div>

              <div class="card-info">
                Виробник:
                {% if product.brand %}
                  <a class="info-link" href="{% url 'products:brand' product.brand.brand_slug %}">
                    {{ product.brand.name }}
                  </a>
                {% else %} — {% endif %}
              </div>

<!--              <div class="card-info">-->
<!--                Країна:-->
<!--                {% if product.brand and product.brand.country_slug %}-->
<!--                  <a class="info-link" href="{% url 'products:country' product.brand.country_slug %}">-->
<!--                    {{ product.brand.country }}-->
<!--                  </a>-->
<!--                {% else %} — {% endif %}-->
<!--              </div>-->
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
    <div class="product-grid is-empty">
      <p class="no-favourites">У вас поки що немає обраних товарів. ;(</p>
    </div>
    {% endif %}
    </main>
  </div>
</section>

<script>
  // Збираємо чекбокси/поля і перезавантажуємо сторінку з query-параметрами
  function applyFilters() {
    const url = new URL(window.location.href);
    url.searchParams.delete('brand'); // очистити, потім додати вибрані

    document.querySelectorAll('input[name="brand"]:checked').forEach(cb => {
      url.searchParams.append('brand', cb.value);
    });

    const min = document.querySelector('input[name="price_min"]').value;
    const max = document.querySelector('input[name="price_max"]').value;
    const stock = document.querySelector('input[name="in_stock"]').checked;

    if (min) url.searchParams.set('price_min', min); else url.searchParams.delete('price_min');
    if (max) url.searchParams.set('price_max', max); else url.searchParams.delete('price_max');
    if (stock) url.searchParams.set('in_stock', '1'); else url.searchParams.delete('in_stock');

    window.location = url.toString();
  }
</script>



{% endblock %}

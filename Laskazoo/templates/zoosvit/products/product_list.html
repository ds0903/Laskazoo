{% extends 'zoosvit/core/base.html' %}
{% load static %}

{% block title %}{{ title }} – Ласка{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/catalog.css' %}">
  <link rel="stylesheet" href="{% static 'zoosvit/css/styles.css' %}">
  <script defer src="{% static 'zoosvit/js/fav.js' %}"></script>
  <script defer src="{% static 'zoosvit/js/product_cards.js' %}"></script>
  <script defer src="{% static 'zoosvit/js/filters.js' %}"></script>
  
  <style>
    /* Оптимізовані стилі для карток товарів в списках продуктів */
    .catalog .product-grid { 
      overflow: visible; 
      position: relative;
      contain: layout; 
    }
    
    .catalog .prod-card { 
      height: var(--prod-min-height, 320px); 
      overflow: visible; 
      position: relative; 
      background: transparent; 
      box-shadow: none;
      transform: translateZ(0);
      will-change: z-index;
    }
    
    .catalog .prod-card::before {
      content: "";
      position: absolute;
      inset: 0 auto auto 0;
      right: 0;
      height: var(--prod-min-height, 320px);
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      transition: height .25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow .25s ease;
      z-index: 0;
      will-change: height, box-shadow;
    }
    
    .catalog .prod-card:hover { 
      z-index: 30; 
    }
    
    .catalog .prod-card:hover::before {
      height: clamp(
        var(--prod-min-height, 320px),
        var(--hover-height, var(--prod-min-height, 320px)),
        var(--prod-max-height, 820px)
      );
      box-shadow: 0 12px 24px rgba(0,0,0,.18);
    }
    
    .catalog .prod-card .card-front,
    .catalog .prod-card .card-back { 
      position: absolute; 
      inset: 0; 
      z-index: 1;
      backface-visibility: hidden;
    }
    
    /* Стилі для неактивних товарів */
    .prod-card.out-of-stock::before { background: #f5f5f5; }
    .prod-card.out-of-stock { opacity: 0.65; }
    .prod-card.out-of-stock img { filter: grayscale(100%); }
    .prod-card.out-of-stock .card-title,
    .prod-card.out-of-stock .card-price,
    .prod-card.out-of-stock .card-article { color: #999; }
    .prod-card.out-of-stock .add-to-cart {
      background: #ccc; color: #666; cursor: not-allowed; pointer-events: none;
    }
    .prod-card.out-of-stock .variant-pill { opacity: 0.6; pointer-events: none; }
  </style>
{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumbs" aria-label="Breadcrumb">
  <a href="{% url 'home' %}">Головна</a>
  <span class="separator">›</span>
  <a href="{% url 'products:catalog' %}">Каталог</a>
  <span class="separator">›</span>
  <span class="current">{{ title }}</span>
</nav>
{% endblock %}

{% block content %}
<h1 class="catalog-page-heading">{{ title }}</h1>

<section class="catalog container catalog">
  <div class="catalog-wrapper">
    <aside class="filter-sidebar">
      <h3 class="fs-title">Фільтри</h3>

      <div class="fs-group">
        <p class="fs-group-title">Виробник</p>
        {% for b in brands %}
          <label>
            <input type="checkbox" name="brand" value="{{ b.slug }}"
                   {% if b.checked %}checked{% endif %}>
            {{ b.name }} <span>({{ b.count }})</span>
          </label>
        {% empty %}
          <p class="muted">Немає брендів у цій вибірці</p>
        {% endfor %}
      </div>

      <div class="fs-group">
        <p class="fs-group-title">Ціна, грн</p>
        <div class="range-inputs">
          <input type="number" name="price_min" placeholder="від" value="{{ price_min }}">
          <span>–</span>
          <input type="number" name="price_max" placeholder="до"  value="{{ price_max }}">
        </div>
        <label class="stock-filter">
          <input type="checkbox" name="in_stock" {% if in_stock %}checked{% endif %}>
          <span>В наявності</span>
        </label>

        <button class="btn-secondary btn-filter-apply" onclick="applyFilters()">OK</button>
      </div>
    </aside>

    <main class="catalog-main">
      {% if products %}
        {# Контроль кількості товарів на сторінці #}
        <div class="catalog-controls">
          <div class="results-info">
            Показано {{ products.start_index }}-{{ products.end_index }} з {{ products.paginator.count }} товарів
          </div>
          <div class="per-page-control">
            <label for="per-page-select">Товарів на сторінці:</label>
            <select id="per-page-select" onchange="changePerPage(this.value)">
              <option value="20" {% if current_per_page == 20 %}selected{% endif %}>20</option>
              <option value="40" {% if current_per_page == 40 %}selected{% endif %}>40</option>
              <option value="60" {% if current_per_page == 60 %}selected{% endif %}>60</option>
              <option value="100" {% if current_per_page == 100 %}selected{% endif %}>100</option>
            </select>
          </div>
        </div>
        
      <div class="product-grid">
        {% for product in products %}
          {% with v0=product.variants_for_card.0 %}
          <div class="prod-card {% if not product.is_active or product.warehouse_quantity == 0 or v0 and not v0.is_active or v0 and v0.warehouse_quantity == 0 %}out-of-stock{% endif %}" data-product-id="{{ product.id }}">
          {% endwith %}
            <!-- FRONT -->
            <div class="card-front">
              <a href="{{ product.get_absolute_url|default:'#' }}">
                {% if product.image %}
                  <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
                {% else %}
                  <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
                {% endif %}
              </a>
                <div class="card-article">Артикул: {{ product.sku|default:'—' }}</div>
              <h3 class="card-title">{{ product.name }}</h3>
              <div class="card-price">
                ₴ {{ product.variants_for_card.0.retail_price|default:product.retail_price }}
              </div>
            </div>

            <!-- BACK -->
            <div class="card-back">
              <a href="{{ product.get_absolute_url|default:'#' }}">
                {% if product.image %}
                  <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
                {% else %}
                  <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
                {% endif %}
                  <div class="card-article">Артикул: {{ product.sku|default:'—' }}</div>
                <h3 class="card-title">{{ product.name }}</h3>
              </a>

              {% if product.variants_for_card %}
                <ul class="variants">
                  {% for v in product.variants_for_card|slice:":4" %}
                    <li class="variant-row">
                      <span class="v-meta">
                        {% if v.weight %}{{ v.weight }} г{% endif %}
                        {% if v.size %}{% if v.weight %} / {% endif %}{{ v.size }}{% endif %}
                        {% if v.color %} — {{ v.color }}{% endif %}
                        {% if not v.weight and not v.size and not v.color %}SKU: {{ v.sku }}{% endif %}
                      </span>
                      {% if v.warehouse_quantity|default:0 > 0 %}
                        <a class="btn add-to-cart" href="{% url 'orders:add' product.id %}">В кошик</a>
                      {% else %}
                        <button class="btn" disabled>Немає</button>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="no-variants">
                  <div class="card-price">₴ {{ product.retail_price }}</div>
                </div>
              {% endif %}

              <div class="card-actions">
                <a class="btn add-to-cart" href="{% url 'orders:add' product.id %}">В кошик</a>

                <button
                  class="btn-fav js-fav {% if product.id in fav_ids %}active{% endif %}"
                  data-url="{% url 'favourites:toggle' product.id %}"
                  aria-label="В улюблені"
                  aria-pressed="{% if product.id in fav_ids %}true{% else %}false{% endif %}">
                  ❤️
                </button>
              </div>

              <div class="card-info">
                Виробник:
                {% if product.brand %}
                  <a class="info-link" href="{% url 'products:brand' product.brand.brand_slug %}">
                    {{ product.brand.name }}
                  </a>
                {% else %} — {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      
      {# Пагінація #}
      {% if products.has_other_pages %}
        <div class="pagination-wrapper">
          <nav class="pagination" aria-label="Пагінація">
            {% if products.has_previous %}
              <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ products.previous_page_number }}" class="page prev" aria-label="Попередня сторінка">« Назад</a>
            {% endif %}
            
            {% for num in products.paginator.page_range %}
              {% if num == products.number %}
                <span class="page active" aria-current="page">{{ num }}</span>
              {% elif num > products.number|add:"-3" and num < products.number|add:"3" %}
                <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}" class="page">{{ num }}</a>
              {% elif num == 1 or num == products.paginator.num_pages %}
                <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}" class="page">{{ num }}</a>
              {% elif num == products.number|add:"-4" or num == products.number|add:"4" %}
                <span class="page ellipsis">…</span>
              {% endif %}
            {% endfor %}
            
            {% if products.has_next %}
              <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ products.next_page_number }}" class="page next" aria-label="Наступна сторінка">Далі »</a>
            {% endif %}
          </nav>
        </div>
      {% endif %}
    {% else %}
    <div class="product-grid is-empty">
      <p class="no-favourites">Немає товарів у цій категорії. ;(</p>
    </div>
    {% endif %}
    </main>
  </div>
</section>

<script>
  // Збираємо чекбокси/поля і перезавантажуємо сторінку з query-параметрами
  function applyFilters() {
    const url = new URL(window.location.href);
    url.searchParams.delete('brand'); // очистити, потім додати вибрані

    document.querySelectorAll('input[name="brand"]:checked').forEach(cb => {
      url.searchParams.append('brand', cb.value);
    });

    const min = document.querySelector('input[name="price_min"]').value;
    const max = document.querySelector('input[name="price_max"]').value;
    const stock = document.querySelector('input[name="in_stock"]').checked;

    if (min) url.searchParams.set('price_min', min); else url.searchParams.delete('price_min');
    if (max) url.searchParams.set('price_max', max); else url.searchParams.delete('price_max');
    if (stock) url.searchParams.set('in_stock', '1'); else url.searchParams.delete('in_stock');

    window.location = url.toString();
  }
  
  // Функція для зміни кількості товарів на сторінці
  function changePerPage(perPage) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    url.searchParams.delete('page'); // скидаємо номер сторінки, щоб почати з першої
    window.location.href = url.toString();
  }

  // Оптимізація для product_list
  document.addEventListener('DOMContentLoaded', function() {
    console.log('[PRODUCT_LIST] Page loaded, product cards optimization active');
    
    window.onCardPreloadComplete = function() {
      console.log('[PRODUCT_LIST] All product cards optimized');
    };
  });
</script>

{% endblock %}
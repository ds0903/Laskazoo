{% extends 'zoosvit/core/base.html' %}
{% load static %}
{% block title %}Особисті дані{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/styles.css' %}">
  <link rel="stylesheet" href="{% static 'zoosvit/css/users/profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-wrapper">

  <!-- Сайдбар -->
  <aside class="profile-sidebar">
    <ul class="profile-nav">
      <li class="active">
        <a href="{% url 'users:profile' %}">Особисті дані</a>
      </li>
      <li>
        <a href="{% url 'orders:list' %}">Замовлення</a>
      </li>
      <li>
        <a href="{% url 'favourites:list' %}">Обране</a>
      </li>
    </ul>
  </aside>

  <!-- Головний контент -->
  <section class="profile-main">
    <h1 class="profile-title">Особисті дані</h1>

    {% if messages %}
      <div class="messages">
        {% for msg in messages %}
          <div class="message {{ msg.tags }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="profile-card">
      <p class="profile-note">
        Якщо у вас є запитання будь ласка, зверніться до нас в соціальних мережах.
        Детальніше про наші контакти за <a href="{% url 'info_page' 'contacts' %}">посиланням</a>.
      </p>

      <form method="post" class="profile-form" id="profile-form">
        {% csrf_token %}
        
        <div class="form-group">
          <label for="{{ form.username.id_for_label }}">ПІБ</label>
          {{ form.username }}
          {% if form.username.errors %}
            <div class="error-message">
              {% for error in form.username.errors %}
                {{ error }}
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" 
                 value="{{ user.email }}" 
                 readonly 
                 class="profile-input readonly-input"
                 title="Email не можна змінювати">
          <small class="field-hint">Email не можна змінювати</small>
        </div>

        <div class="form-group">
          <label for="{{ form.phone_number.id_for_label }}">Телефон</label>
          {{ form.phone_number }}
          {% if form.phone_number.errors %}
            <div class="error-message">
              {% for error in form.phone_number.errors %}
                {{ error }}
              {% endfor %}
            </div>
          {% endif %}
          <small class="field-hint">Введіть номер у форматі +380XXXXXXXXX</small>
        </div>

        <button type="submit" class="btn-save">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
          </svg>
          Зберегти зміни
        </button>
      </form>
    </div>

    <!-- Google акаунт -->
    <div class="profile-card" style="margin-top: 2rem;">
      <h2 style="margin: 0 0 1.5rem 0; color: #333; font-size: 1.5rem;">Підключення акаунтів</h2>
      
      <div class="social-connection">
        <div class="social-provider">
          <svg width="40" height="40" viewBox="0 0 40 40">
            <path fill="#4285F4" d="M37.6 20.42c0-1.3-.12-2.55-.33-3.75H20v7.09h9.87c-.42 2.29-1.72 4.23-3.66 5.53v4.6h5.92c3.47-3.19 5.47-7.89 5.47-13.47z"/>
            <path fill="#34A853" d="M20 38.33c4.95 0 9.1-1.64 12.13-4.44l-5.92-4.6c-1.64 1.1-3.74 1.75-6.21 1.75-4.78 0-8.82-3.22-10.26-7.56H3.62v4.75C6.63 34.23 12.83 38.33 20 38.33z"/>
            <path fill="#FBBC05" d="M9.74 23.48c-.37-1.1-.58-2.27-.58-3.48s.21-2.38.58-3.48V11.77H3.62C2.4 14.24 1.67 17.02 1.67 20s.73 5.76 1.95 8.23l6.12-4.75z"/>
            <path fill="#EA4335" d="M20 7.92c2.69 0 5.11.92 7.01 2.74l5.26-5.26C29.09 2.41 24.94.67 20 .67 12.83.67 6.63 4.77 3.62 11.77l6.12 4.75C11.18 11.14 15.22 7.92 20 7.92z"/>
          </svg>
          <div class="provider-info">
            <strong>Google</strong>
            {% if has_google %}
              <span class="status connected">Підключено</span>
            {% else %}
              <span class="status not-connected">Не підключено</span>
            {% endif %}
          </div>
        </div>
        
        {% if has_google %}
          <p class="connection-description">Ви можете входити в систему за допомогою Google акаунту</p>
        {% else %}
          <p class="connection-description">Підключіть Google для швидкого входу</p>
          {% load socialaccount %}
          <a href="#" onclick="openGooglePopup('{% provider_login_url 'google' process='connect' %}'); return false;" class="btn-connect-google">
            <svg width="20" height="20" viewBox="0 0 20 20">
              <path fill="#4285F4" d="M18.8 10.21c0-.65-.06-1.28-.17-1.88H10v3.55h4.94c-.21 1.15-.86 2.12-1.83 2.77v2.3h2.96c1.74-1.6 2.73-3.95 2.73-6.74z"/>
              <path fill="#34A853" d="M10 19.17c2.48 0 4.55-.82 6.07-2.22l-2.96-2.3c-.82.55-1.87.88-3.11.88-2.39 0-4.41-1.61-5.13-3.78H1.81v2.37C3.32 17.12 6.42 19.17 10 19.17z"/>
              <path fill="#FBBC05" d="M4.87 11.74c-.19-.55-.29-1.14-.29-1.74s.1-1.19.29-1.74V5.89H1.81C1.2 7.09.83 8.51.83 10s.37 2.91.98 4.11l3.06-2.37z"/>
              <path fill="#EA4335" d="M10 3.96c1.35 0 2.56.46 3.51 1.37l2.63-2.63C14.55 1.2 12.48.83 10 .83 6.42.83 3.32 2.88 1.81 5.89l3.06 2.37C5.59 5.57 7.61 3.96 10 3.96z"/>
            </svg>
            Підключити Google
          </a>
        {% endif %}
      </div>
    </div>
  </section>
</div>

<style>
.social-connection {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.social-provider {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #e0e0e0;
}

.provider-info {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.provider-info strong {
  font-size: 1.1rem;
  color: #333;
}

.status {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}

.status.connected {
  background: #d4edda;
  color: #155724;
}

.status.not-connected {
  background: #f8d7da;
  color: #721c24;
}

.connection-description {
  color: #666;
  font-size: 0.95rem;
  margin: 0;
  line-height: 1.5;
}

.btn-connect-google {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 12px 24px;
  background: white;
  color: #333;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  text-decoration: none;
  font-weight: 600;
  font-size: 1rem;
  transition: all 0.3s ease;
  margin-top: 0.5rem;
}

.btn-connect-google:hover {
  background: #f8f9fa;
  border-color: #d0d0d0;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
</style>

<script>
// Функція для відкриття Google OAuth в popup
function openGooglePopup(url) {
  const width = 500;
  const height = 600;
  const left = (screen.width - width) / 2;
  const top = (screen.height - height) / 2;
  
  const popup = window.open(
    url,
    'Google Sign In',
    `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
  );
  
  if (popup) {
    // Перевіряємо кожну секунду чи користувач увійшов
    const checkAuth = setInterval(() => {
      // Перевіряємо чи popup закрито
      if (popup.closed) {
        clearInterval(checkAuth);
        // Перевіряємо чи користувач увійшов (робимо запит на сервер)
        fetch('/users/check-auth/', {
          credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
          if (data.authenticated) {
            // Перезавантажуємо сторінку
            window.location.reload();
          }
        })
        .catch(() => {
          // Якщо помилка - просто перезавантажуємо
          window.location.reload();
        });
      }
    }, 1000);
  } else {
    // Якщо popup заблоковано браузером
    alert('Будь ласка, дозвольте popup вікна для цього сайту');
    window.location.href = url;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const phoneInput = document.querySelector('.phone-input');
  
  if (phoneInput) {
    // Автоматична підстановка +38 при фокусі на порожнє поле
    phoneInput.addEventListener('focus', function() {
      if (!this.value || this.value.trim() === '') {
        this.value = '+38';
      }
    });
    
    // Форматування номера при введенні
    phoneInput.addEventListener('input', function(e) {
      let value = this.value;
      
      // Дозволяємо тільки цифри після +38
      if (value.startsWith('+38')) {
        let numbers = value.substring(3).replace(/\D/g, '');
        this.value = '+38' + numbers;
      } else if (value.startsWith('+')) {
        // Якщо користувач видалив 38, додаємо назад
        this.value = '+38';
      } else {
        // Якщо немає +, додаємо +38
        let numbers = value.replace(/\D/g, '');
        this.value = '+38' + numbers;
      }
      
      // Обмежуємо довжину до 13 символів (+380XXXXXXXXX)
      if (this.value.length > 13) {
        this.value = this.value.substring(0, 13);
      }
    });
    
    // Не дозволяємо видалити +38
    phoneInput.addEventListener('keydown', function(e) {
      if (this.value === '+38' && (e.key === 'Backspace' || e.key === 'Delete')) {
        e.preventDefault();
      }
    });
  }
  
  // Анімація для кнопки збереження
  const form = document.getElementById('profile-form');
  const submitBtn = form?.querySelector('.btn-save');
  
  if (form && submitBtn) {
    form.addEventListener('submit', function() {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span> Збереження...';
    });
  }
});
</script>
{% endblock %}

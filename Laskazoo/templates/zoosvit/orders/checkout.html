{% extends 'zoosvit/core/base.html' %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/orders/checkout.css' %}">
  <style>
    /* –®–∏—Ä–æ–∫–∏–π –ª–µ–π–∞—É—Ç –±–µ–∑ —Å–∞–π–¥–±–∞—Ä—É */
    .checkout-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 1.2fr; /* –¢–æ–≤–∞—Ä–∏ —Ç—Ä–æ—Ö–∏ –≤—É–∂—á–µ, —Ñ–æ—Ä–º–∞ —à–∏—Ä—à–∞ */
      gap: 40px;
      align-items: start;
    }
    
    .checkout-title {
      text-align: center;
      color: #0f6b38;
      font-size: 2rem;
      margin: 20px 0 30px 0;
      font-weight: 600;
    }
    
    /* –ë–ª–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤ */
    .order-summary {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      position: sticky;
      top: 20px;
    }
    
    .order-summary h2 {
      color: #0f6b38;
      font-size: 1.4rem;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    /* –ë–ª–æ–∫ —Ñ–æ—Ä–º–∏ - —à–∏—Ä—à–∏–π */
    .checkout-form-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .checkout-form-container h2 {
      color: #0f6b38;
      font-size: 1.4rem;
      margin-bottom: 25px;
      font-weight: 600;
    }
    
    /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–æ–ª—ñ–≤ */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: border-color 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #0f6b38;
      box-shadow: 0 0 0 3px rgba(15, 107, 56, 0.1);
    }
    
    .form-control:disabled {
      background-color: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #333;
      font-size: 0.95rem;
    }
    
    /* –ê–≤—Ç–æ–∫–æ–º–ø–ª–µ—Ç –º—ñ—Å—Ç */
    .city-autocomplete-container {
      position: relative;
    }
    
    .city-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .city-suggestion {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .city-suggestion:hover {
      background-color: #f8f9fa;
    }
    
    .city-suggestion:last-child {
      border-bottom: none;
    }

    /* –ü–û–ö–†–ê–©–ï–ù–Ü –°–¢–ò–õ–Ü –î–õ–Ø –°–ü–ò–°–ö–£ –í–Ü–î–î–Ü–õ–ï–ù–¨ - –í–ò–ü–ê–î–ê–Æ–¢–¨ –ó–ù–ò–ó–£ */
    .branches-container {
      position: relative;
    }

    .branches-select-custom {
      position: relative;
      width: 100%;
    }

    .branches-current {
      width: 100%;
      padding: 12px 40px 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.95rem;
      transition: border-color 0.3s ease;
      min-height: 50px;
    }

    .branches-current[disabled] {
      background-color: #f5f5f5;
      color: #999;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .branches-current:not([disabled]):hover {
      border-color: #0f6b38;
    }

    .branches-current.open {
      border-color: #0f6b38;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }

    .branches-text {
      flex: 1;
      text-align: left;
    }

    .branches-arrow {
      font-size: 0.8rem;
      color: #666;
      transition: transform 0.3s ease;
    }

    .branches-current.open .branches-arrow {
      transform: rotate(180deg);
    }

    /* DROPDOWN –°–¢–ò–õ–Ü - –í–ê–ñ–õ–ò–í–û: –í–ò–ü–†–ê–í–õ–ï–ù–û –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø */
    .branches-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #0f6b38;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none; /* –ü–æ—á–∞—Ç–∫–æ–≤–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π */
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ö–æ–ª–∏ dropdown –≤—ñ–¥–∫—Ä–∏—Ç–æ */
    .branches-dropdown.show {
      display: block !important; /* !important —â–æ–± –ø–µ—Ä–µ–ø–∏—Å–∞—Ç–∏ display: none */
    }

    /* –°–ü–†–û–©–ï–ù–Ü –û–ü–¶–Ü–á –í–Ü–î–î–Ü–õ–ï–ù–¨ - –¢–Ü–õ–¨–ö–ò –ù–û–ú–ï–† –Ü –ê–î–†–ï–°–ê */
    .branch-option {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }

    .branch-option:hover {
      background-color: #f8f9fa;
    }

    .branch-option:last-child {
      border-bottom: none;
    }

    .branch-number {
      font-weight: 600;
      color: #0f6b38;
      min-width: 35px;
      flex-shrink: 0;
    }

    .branch-address {
      color: #333;
      flex: 1;
    }

    /* –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –°–¢–ò–õ–Ü–í –î–õ–Ø RADIO –ö–ù–û–ü–û–ö */
    .delivery-type-options {
      display: flex;
      gap: 16px;
      margin: 16px 0;
    }
    
    .delivery-type-option {
      flex: 1;
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      background-color: white;
      position: relative;
    }
    
    .delivery-type-option:hover {
      border-color: #0f6b38;
      background-color: #f8fdf9;
    }
    
    .delivery-type-option.selected {
      border-color: #0f6b38;
      background-color: #f0f8f0;
    }
    
    .delivery-type-option input[type="radio"] {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      accent-color: #0f6b38;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    /* –î–û–î–ê–¢–ö–û–í–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –ö–í–ê–î–†–ê–¢–ò–ö–ê */
    .delivery-type-option input[type="radio"]:checked {
      background-color: #0f6b38;
      border: 2px solid #0f6b38;
    }
    
    .delivery-type-option label {
      flex: 1;
      cursor: pointer;
      margin: 0;
      font-size: 0.95rem;
      color: #333;
      font-weight: 500;
      display: block;
    }
    
    /* –°–µ–∫—Ü—ñ—ó —Ñ–æ—Ä–º–∏ */
    .form-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .form-section:last-of-type {
      border-bottom: none;
    }
    
    .form-section h3 {
      color: #0f6b38;
      font-size: 1.2rem;
      margin-bottom: 16px;
      font-weight: 600;
    }
    
    /* –ü–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ */
    .delivery-section.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    /* –ü–æ–º–∏–ª–∫–∏ */
    .form-errors {
      margin-top: 5px;
    }
    
    .form-errors .error {
      color: #d32f2f;
      font-size: 0.875rem;
      display: block;
    }
    
    .form-help {
      font-size: 0.875rem;
      color: #666;
      margin-top: 4px;
    }
    
    /* –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–∞–Ω–Ω—è */
    .form-actions {
      text-align: center;
      margin-top: 30px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #0f6b38 0%, #1a8f4a 100%);
      color: white;
      border: none;
      padding: 16px 40px;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 280px;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #0d5a2f 0%, #168040 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(15, 107, 56, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Loading —Å–ø–∏–Ω–Ω–µ—Ä */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
    @media (max-width: 768px) {
      .checkout-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .order-summary {
        position: static;
      }

      .delivery-type-options {
        flex-direction: column;
        gap: 12px;
      }
    }

    /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ CSS –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è debug */
    .debug-dropdown {
      background: yellow !important;
      border: 3px solid red !important;
    }
  </style>
{% endblock %}

{% block content %}
<h1 class="checkout-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

{% if messages %}
  <div class="messages">
    {% for msg in messages %}
      <div class="message {{ msg.tags }}">{{ msg }}</div>
    {% endfor %}
  </div>
{% endif %}

<div class="checkout-container">
  <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –¢–æ–≤–∞—Ä–∏ –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ -->
  <div class="order-summary">
    <h2>–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
    
    {% if order.items.all %}
      <div class="order-items">
        {% for item in order.items.all %}
          <div class="order-item">
            <div class="item-image">
              {% if item.variant and item.variant.image %}
                <img src="{{ item.variant.image.url }}" alt="{{ item.product.name }}">
              {% elif item.product.image %}
                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
              {% else %}
                <img src="{% static 'zoosvit/img/placeholder.jpg' %}" alt="{{ item.product.name }}">
              {% endif %}
            </div>
            
            <div class="item-details">
              <h3>{{ item.product.name }}</h3>
              {% if item.variant %}
                <div class="item-variant">
                  {% if item.variant.sku %}–ê—Ä—Ç–∏–∫—É–ª: {{ item.variant.sku }}{% endif %}
                  {% if item.variant.weight %} ¬∑ {{ item.variant.weight }} –∫–≥{% endif %}
                  {% if item.variant.size %} ¬∑ {{ item.variant.size }}{% endif %}
                </div>
              {% endif %}
              <div class="item-price">{{ item.retail_price }} –≥—Ä–Ω √ó {{ item.quantity }} —à—Ç</div>
            </div>
            
            <div class="item-total">
              <strong>{{ item.line_total }} –≥—Ä–Ω</strong>
            </div>
          </div>
        {% endfor %}
      </div>
      
      <div class="order-total">
        <div class="total-row">
          <span>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</span>
          <strong>
            {% if order.total_amount %}
              {{ order.total_amount }} –≥—Ä–Ω
            {% else %}
              {% load custom_tags %}
              {{ order|calculate_total }} –≥—Ä–Ω
            {% endif %}
          </strong>
        </div>
      </div>
    {% else %}
      <p class="empty-order">–í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. <a href="{% url 'products:catalog' %}">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É</a></p>
    {% endif %}
  </div>

  <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è (—à–∏—Ä—à–∞) -->
  <div class="checkout-form-container">
    <h2>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ</h2>
    
    <form method="post" class="checkout-form" id="checkout-form">
      {% csrf_token %}
      
      <!-- –û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ -->
      <div class="form-section">
        <h3>–û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ</h3>
        
        <div class="form-row">
          <!-- –ü–Ü–ë -->
          <div class="form-group">
            {{ form.full_name.label_tag }}
            {{ form.full_name }}
            {% if form.full_name.errors %}
              <div class="form-errors">
                {% for error in form.full_name.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
          <div class="form-group">
            {{ form.phone.label_tag }}
            {{ form.phone }}
            {% if form.phone.errors %}
              <div class="form-errors">
                {% for error in form.phone.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </div>
            {% endif %}
            <small class="form-help">–ù–∞–ø—Ä–∏–∫–ª–∞–¥: +380671234567</small>
          </div>
        </div>

        <div class="form-row">
          <!-- Email -->
          <div class="form-group">
            {{ form.email.label_tag }}
            {{ form.email }}
            {% if form.email.errors %}
              <div class="form-errors">
                {% for error in form.email.errors %}
                  <span class="error">{{ error }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- –ú—ñ—Å—Ç–æ –∑ –∞–≤—Ç–æ–∫–æ–º–ø–ª–µ—Ç–æ–º -->
          <div class="form-group">
            <div class="city-autocomplete-container">
              {{ form.city.label_tag }}
              {{ form.city }}
              <div class="city-suggestions" id="city-suggestions"></div>
              {% if form.city.errors %}
                <div class="form-errors">
                  {% for error in form.city.errors %}
                    <span class="error">{{ error }}</span>
                {% endfor %}
              </div>
            {% endif %}
            <small class="form-help">–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞</small>
          </div>
        </div>
      </div>
    </div>

    <!-- –î–æ—Å—Ç–∞–≤–∫–∞ (–¥–µ–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞ –ø–æ–∫–∏ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –º—ñ—Å—Ç–æ) -->
    <div class="form-section delivery-section" id="delivery-section">
      <h3>–°–ø–æ—Å—ñ–± –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
      
      <div class="form-group">
        <div class="delivery-type-options">
          {% for radio in form.delivery_type %}
            <div class="delivery-type-option" data-value="{{ radio.choice_value }}">
              {{ radio.tag }}
              <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
            </div>
          {% endfor %}
        </div>
        {% if form.delivery_type.errors %}
          <div class="form-errors">
            {% for error in form.delivery_type.errors %}
              <span class="error">{{ error }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- –ü–û–ö–†–ê–©–ï–ù–ï –ü–û–õ–ï –í–Ü–î–î–Ü–õ–ï–ù–ù–Ø - –ö–ê–°–¢–û–ú–ù–ò–ô –°–ï–õ–ï–ö–¢ -->
      <div class="form-group full-width">
        <label for="branches-current">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
        <div class="branches-container" id="branches-container">
          
          <!-- –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π input –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º–∏ -->
          <input type="hidden" name="delivery_address" id="delivery_address_input" required>
          
          <!-- –ö–∞—Å—Ç–æ–º–Ω–∏–π —Å–µ–ª–µ–∫—Ç -->
          <div class="branches-select-custom">
            <div class="branches-current" id="branches-current" disabled>
              <span class="branches-text">–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ —Ç–∞ —Ç–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏</span>
              <span class="branches-arrow">‚ñº</span>
            </div>
            
            <div class="branches-dropdown" id="branches-dropdown">
              <!-- –û–ø—Ü—ñ—ó –¥–æ–¥–∞—é—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ JavaScript -->
            </div>
          </div>
        </div>
        {% if form.delivery_address.errors %}
          <div class="form-errors">
            {% for error in form.delivery_address.errors %}
              <span class="error">{{ error }}</span>
            {% endfor %}
          </div>
        {% endif %}
        <small class="form-help" id="delivery-address-help">–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</small>
      </div>
    </div>

    <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä -->
    <div class="form-section">
      <h3>–ö–æ–º–µ–Ω—Ç–∞—Ä</h3>
      
      <div class="form-group full-width">
        {{ form.comment.label_tag }}
        {{ form.comment }}
        <small class="form-help">–ó–∞ –±–∞–∂–∞–Ω–Ω—è–º</small>
      </div>
    </div>

    {% if form.non_field_errors %}
      <div class="form-errors">
        {% for error in form.non_field_errors %}
          <span class="error">{{ error }}</span>
        {% endfor %}
      </div>
    {% endif %}

    <div class="form-actions">
      <button type="submit" class="btn-primary" id="submit-btn">
        <span>üì¶</span>
        <span id="submit-text">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</span>
      </button>
    </div>
  </form>

  <div class="checkout-info">
    <h3>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É</h3>
    <p>üìû <strong>–ó–≤'—è–∑–æ–∫ –∑ –≤–∞–º–∏</strong> ‚Äî –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É—î –ø—Ä–æ—Ç—è–≥–æ–º 30 —Ö–≤–∏–ª–∏–Ω –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</p>
  </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// *** –°–ü–ò–°–û–ö –£–ö–†–ê–á–ù–°–¨–ö–ò–• –ú–Ü–°–¢ (–æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –¥–ª—è —à–≤–∏–¥–∫–æ—ó —Ä–æ–±–æ—Ç–∏) ***
const UKRAINIAN_CITIES = [
  // –û–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏
  '–ö–∏—ó–≤', '–•–∞—Ä–∫—ñ–≤', '–î–Ω—ñ–ø—Ä–æ', '–û–¥–µ—Å–∞', '–ó–∞–ø–æ—Ä—ñ–∂–∂—è', '–õ—å–≤—ñ–≤', '–ö—Ä–∏–≤–∏–π –†—ñ–≥',
  '–ú–∏–∫–æ–ª–∞—ó–≤', '–í—ñ–Ω–Ω–∏—Ü—è', '–ü–æ–ª—Ç–∞–≤–∞', '–ß–µ—Ä–Ω—ñ–≥—ñ–≤', '–ß–µ—Ä–∫–∞—Å–∏', '–ñ–∏—Ç–æ–º–∏—Ä', 
  '–°—É–º–∏', '–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π', '–ß–µ—Ä–Ω—ñ–≤—Ü—ñ', '–†—ñ–≤–Ω–µ', '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å', '–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫',
  '–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π', '–õ—É—Ü—å–∫', '–£–∂–≥–æ—Ä–æ–¥', '–•–µ—Ä—Å–æ–Ω',

  // –ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ë—ñ–ª–∞ –¶–µ—Ä–∫–≤–∞', '–ë—Ä–æ–≤–∞—Ä–∏', '–Ü—Ä–ø—ñ–Ω—å', '–§–∞—Å—Ç—ñ–≤', '–ë–æ—Ä–∏—Å–ø—ñ–ª—å', '–ë–æ—è—Ä–∫–∞', 
  '–í–∞—Å–∏–ª—å–∫—ñ–≤', '–û–±—É—Ö—ñ–≤', '–£–∫—Ä–∞—ó–Ω–∫–∞', '–ö–∞–≥–∞—Ä–ª–∏–∫', '–°–∫–≤–∏—Ä–∞', '–ë–æ–≥—É—Å–ª–∞–≤', 
  '–Ø–≥–æ—Ç–∏–Ω', '–ü\'—è—Ç–∏—Ö–∞—Ç–∫–∏', '–ó–≥—É—Ä—ñ–≤–∫–∞', '–¢–∞—Ä–∞—â–∞', '–í–æ–ª–æ–¥–∞—Ä–∫–∞', '–°—Ç–∞–≤–∏—â–µ', 
  '–†–æ–∫–∏—Ç–Ω–µ', '–ú–∏—Ä–æ–Ω—ñ–≤–∫–∞', '–¢–µ—Ç—ñ—ó–≤', '–£–∑–∏–Ω', '–ú–∞–∫–∞—Ä—ñ–≤', '–í–∏—à–Ω–µ–≤–µ', 
  '–ì–æ—Å—Ç–æ–º–µ–ª—å', '–ö–æ—Ü—é–±–∏–Ω—Å—å–∫–µ', '–ë—É—á–∞', '–í–æ—Ä–∑–µ–ª—å', '–ü–µ—Ä–µ—è—Å–ª–∞–≤', '–†–∂–∏—â—ñ–≤',
  '–ì–ª–µ–≤–∞—Ö–∞', '–í–∏—à–≥–æ—Ä–æ–¥', '–ö–Ω—è–∂–∏—á—ñ', '–ü—É—â–∞-–í–æ–¥–∏—Ü—è', '–ö–æ–∑–∏–Ω', '–ë–æ—Ä—â–∞–≥—ñ–≤–∫–∞',

  // –õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–î—Ä–æ–≥–æ–±–∏—á', '–°—Ç—Ä–∏–π', '–ß–µ—Ä–≤–æ–Ω–æ–≥—Ä–∞–¥', '–°–∞–º–±—ñ—Ä', '–ö–∞–ª—É—à', '–¢—Ä—É—Å–∫–∞–≤–µ—Ü—å',
  '–ë–æ—Ä–∏—Å–ª–∞–≤', '–ú–æ—Ä—à–∏–Ω', '–ù–æ–≤–∏–π –†–æ–∑–¥—ñ–ª', '–ñ–æ–≤–∫–≤–∞', '–ì–æ—Ä–æ–¥–æ–∫', '–ü—É—Å—Ç–æ–º–∏—Ç–∏',
  '–í–∏–Ω–Ω–∏–∫–∏', '–Ø–≤–æ—Ä—ñ–≤', '–ë—Ä–æ–¥–∏', '–ó–æ–ª–æ—á—ñ–≤', '–°–∫–æ–ª–µ', '–¢—É—Ä–∫–∞',

  // –•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–Ü–∑—é–º', '–õ–æ–∑–æ–≤–∞', '–õ—é–±–æ—Ç–∏–Ω', '–ú–µ—Ä–µ—Ñ–∞', '–ß—É–≥—É—ó–≤', '–ë–∞–ª–∞–∫–ª–µ—è', '–ö—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥',
  '–ö—É–ø\'—è–Ω—Å—å–∫', '–ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫–∏–π', '–í–æ–≤—á–∞–Ω—Å—å–∫', '–î–µ—Ä–≥–∞—á—ñ', '–ó–º—ñ—ó–≤',

  // –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ö–∞–º\'—è–Ω—Å—å–∫–µ', '–ù—ñ–∫–æ–ø–æ–ª—å', '–ù–æ–≤–æ–º–æ—Å–∫–æ–≤—Å—å–∫', '–ö—Ä–µ–º–µ–Ω—á—É–∫', '–ü–∞–≤–ª–æ–≥—Ä–∞–¥', 
  '–ü–µ—Ä—à–æ—Ç—Ä–∞–≤–µ–Ω—Å—å–∫', '–°–∏–Ω–µ–ª—å–Ω–∏–∫–æ–≤–µ', '–ñ–æ–≤—Ç—ñ –í–æ–¥–∏', '–ú–∞—Ä–≥–∞–Ω–µ—Ü—å', '–ü–æ–∫—Ä–æ–≤',

  // –û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–Ü–∑–º–∞—ó–ª', '–ß–æ—Ä–Ω–æ–º–æ—Ä—Å—å–∫', '–ë—ñ–ª–≥–æ—Ä–æ–¥-–î–Ω—ñ—Å—Ç—Ä–æ–≤—Å—å–∫–∏–π', '–ü–æ–¥—ñ–ª—å—Å—å–∫', '–Æ–∂–Ω–µ',
  '–ë–∞–ª—Ç–∞', '–ö–æ—Ç–æ–≤—Å—å–∫', '–†–æ–∑–¥—ñ–ª—å–Ω–∞', '–ê—Ä—Ü–∏–∑', '–ë–æ–ª–≥—Ä–∞–¥', '–ë–µ—Ä–µ–∑—ñ–≤–∫–∞',

  // –ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ú–µ–ª—ñ—Ç–æ–ø–æ–ª—å', '–ë–µ—Ä–¥—è–Ω—Å—å–∫', '–ï–Ω–µ—Ä–≥–æ–¥–∞—Ä', '–¢–æ–∫–º–∞–∫', '–í–∞—Å–∏–ª—ñ–≤–∫–∞',
  '–î–Ω—ñ–ø—Ä–æ—Ä—É–¥–Ω–µ', '–ú–æ–ª–æ—á–∞–Ω—Å—å–∫', '–ü–æ–ª–æ–≥–∏', '–ü—Ä–∏–º–æ—Ä—Å—å–∫', '–í—ñ–ª—å–Ω—è–Ω—Å—å–∫',

  // –í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–•–º—ñ–ª—å–Ω–∏–∫', '–ñ–º–µ—Ä–∏–Ω–∫–∞', '–ú–æ–≥–∏–ª—ñ–≤-–ü–æ–¥—ñ–ª—å—Å—å–∫–∏–π', '–ö–æ–∑—è—Ç–∏–Ω', '–ì–∞–π—Å–∏–Ω',
  '–¢—É–ª—å—á–∏–Ω', '–ö–∞–ª–∏–Ω—ñ–≤–∫–∞', '–õ—ñ—Ç–∏–Ω', '–ù–µ–º–∏—Ä—ñ–≤', '–®–∞—Ä–≥–æ—Ä–æ–¥', '–ë–∞—Ä',

  // –ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ú–∏—Ä–≥–æ—Ä–æ–¥', '–õ—É–±–Ω–∏', '–ì–æ—Ä—ñ—à–Ω—ñ –ü–ª–∞–≤–Ω—ñ', '–ì–∞–¥—è—á', '–ó—ñ–Ω—å–∫—ñ–≤', '–ö–∞—Ä–ª—ñ–≤–∫–∞',
  '–ö–æ–±–µ–ª—è–∫–∏', '–õ–æ—Ö–≤–∏—Ü—è', '–ü–∏—Ä—è—Ç–∏–Ω', '–†–µ—à–µ—Ç–∏–ª—ñ–≤–∫–∞', '–ì–ª–æ–±–∏–Ω–µ',

  // –ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–°–º—ñ–ª–∞', '–ó–æ–ª–æ—Ç–æ–Ω–æ—à–∞', '–ö–∞–Ω—ñ–≤', '–•—Ä–∏—Å—Ç–∏–Ω—ñ–≤–∫–∞', '–í–∞—Ç—É—Ç—ñ–Ω–µ', '–ì–æ—Ä–æ–¥–∏—â–µ',
  '–î—Ä–∞–±—ñ–≤', '–ñ–∞—à–∫—ñ–≤', '–ó–≤–µ–Ω–∏–≥–æ—Ä–æ–¥–∫–∞', '–ö–æ—Ä—Å—É–Ω—å-–®–µ–≤—á–µ–Ω–∫—ñ–≤—Å—å–∫–∏–π', '–¢–∞–ª—å–Ω–µ',
  '–®–ø–æ–ª–∞', '–ß–∏–≥–∏—Ä–∏–Ω', '–ß–æ—Ä–Ω–æ–±–∞–π', '–£–º–∞–Ω—å',

  // –ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ù—ñ–∂–∏–Ω', '–ü—Ä–∏–ª—É–∫–∏', '–ù–æ–≤–≥–æ—Ä–æ–¥-–°—ñ–≤–µ—Ä—Å—å–∫–∏–π', '–ë–∞—Ö–º–∞—á', '–ë–æ–±—Ä–æ–≤–∏—Ü—è',
  '–ë–æ—Ä–∑–Ω–∞', '–ì–æ—Ä–æ–¥–Ω—è', '–ö–æ–∑–µ–ª–µ—Ü—å', '–ö–æ—Ä—é–∫—ñ–≤–∫–∞', '–ú–µ–Ω–∞', '–û—Å—Ç–µ—Ä',

  // –ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ë–µ—Ä–¥–∏—á—ñ–≤', '–ù–æ–≤–æ–≥—Ä–∞–¥-–í–æ–ª–∏–Ω—Å—å–∫–∏–π', '–ö–æ—Ä–æ—Å—Ç–∏—à—ñ–≤', '–ú–∞–ª–∏–Ω', '–†–∞–¥–æ–º–∏—à–ª—å',
  '–ê–Ω–¥—Ä—É—à—ñ–≤–∫–∞', '–ë–∞—Ä–∞–Ω—ñ–≤–∫–∞', '–ë—Ä—É—Å–∏–ª—ñ–≤', '–ö–æ—Ä–æ—Å—Ç–µ–Ω—å', '–û–≤—Ä—É—á',

  // –°—É–º—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–®–æ—Å—Ç–∫–∞', '–û—Ö—Ç–∏—Ä–∫–∞', '–†–æ–º–Ω–∏', '–ì–ª—É—Ö—ñ–≤', '–õ–µ–±–µ–¥–∏–Ω', '–ë—ñ–ª–æ–ø—ñ–ª–ª—è',
  '–ö–æ–Ω–æ—Ç–æ–ø', '–¢—Ä–æ—Å—Ç—è–Ω–µ—Ü—å', '–ü—É—Ç–∏–≤–ª—å',

  // –•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–®–µ–ø–µ—Ç—ñ–≤–∫–∞', '–ù–µ—Ç—ñ—à–∏–Ω', '–°–ª–∞–≤—É—Ç–∞', '–°—Ç–∞—Ä–æ–∫–æ—Å—Ç—è–Ω—Ç–∏–Ω—ñ–≤', '–í–æ–ª–æ—á–∏—Å—å–∫',
  '–î–µ—Ä–∞–∂–Ω—è', '–î—É–Ω–∞—ó–≤—Ü—ñ', '–Ü–∑—è—Å–ª–∞–≤', '–ö—Ä–∞—Å–∏–ª—ñ–≤', '–õ–µ—Ç–∏—á—ñ–≤',
  '–ö–∞–º\'—è–Ω–µ—Ü—å-–ü–æ–¥—ñ–ª—å—Å—å–∫–∏–π', '–ü–æ–ª–æ–Ω–Ω–µ',

  // –ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ù–æ–≤–æ–¥–Ω—ñ—Å—Ç—Ä–æ–≤—Å—å–∫', '–°—Ç–æ—Ä–æ–∂–∏–Ω–µ—Ü—å', '–•–æ—Ç–∏–Ω', '–í–∞—à–∫—ñ–≤—Ü—ñ', '–ó–∞—Å—Ç–∞–≤–Ω–∞',
  '–ö–µ–ª—å–º–µ–Ω—Ü—ñ', '–ö—ñ—Ü–º–∞–Ω—å', '–ù–æ–≤–æ—Å–µ–ª–∏—Ü—è', '–í–∏–∂–Ω–∏—Ü—è',

  // –†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–î—É–±–Ω–æ', '–í–∞—Ä–∞—à', '–ë–µ—Ä–µ–∑–Ω–µ', '–ö–æ—Å—Ç–æ–ø—ñ–ª—å', '–û—Å—Ç—Ä–æ–≥', '–°–∞—Ä–Ω–∏', '–ó–¥–æ–ª–±—É–Ω—ñ–≤',
  '–†–∞–¥–∏–≤–∏–ª—ñ–≤', '–†–æ–∫–∏—Ç–Ω–µ',

  // –¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ß–æ—Ä—Ç–∫—ñ–≤', '–¢–µ—Ä–µ–±–æ–≤–ª—è', '–ó–±–∞—Ä–∞–∂', '–ë–æ—Ä—â—ñ–≤', '–ë—É—á–∞—á', '–ö—Ä–µ–º–µ–Ω–µ—Ü—å',
  '–õ–∞–Ω–æ–≤—Ü—ñ', '–ü—ñ–¥–≥–∞–π—Ü—ñ', '–°–∫–∞–ª–∞—Ç',

  // –Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ö–æ–ª–æ–º–∏—è', '–ö–∞–ª—É—à', '–ë—É—Ä—à—Ç–∏–Ω', '–ë–æ–ª–µ—Ö—ñ–≤', '–ì–∞–ª–∏—á', '–î–æ–ª–∏–Ω–∞',
  '–ö–æ—Å—ñ–≤', '–ù–∞–¥–≤—ñ—Ä–Ω–∞', '–†–æ–≥–∞—Ç–∏–Ω', '–°–Ω—è—Ç–∏–Ω', '–¢–∏—Å–º–µ–Ω–∏—Ü—è',
  '–¢–ª—É–º–∞—á', '–Ø—Ä–µ–º—á–µ', '–í–µ—Ä—Ö–æ–≤–∏–Ω–∞',

  // –í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ù–æ–≤–æ–≤–æ–ª–∏–Ω—Å—å–∫', '–ö—ñ–≤–µ—Ä—Ü—ñ', '–ö–∞–º—ñ–Ω—å-–ö–∞—à–∏—Ä—Å—å–∫–∏–π', '–ì–æ—Ä–æ—Ö—ñ–≤',
  '–í–æ–ª–æ–¥–∏–º–∏—Ä-–í–æ–ª–∏–Ω—Å—å–∫–∏–π', '–õ—é–±–æ–º–ª—å',

  // –ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ú—É–∫–∞—á–µ–≤–æ', '–ë–µ—Ä–µ–≥–æ–≤–µ', '–í–∏–Ω–æ–≥—Ä–∞–¥—ñ–≤', '–•—É—Å—Ç', '–†–∞—Ö—ñ–≤', '–¢—è—á—ñ–≤',
  '–Ü—Ä—à–∞–≤–∞', '–ü–µ—Ä–µ—á–∏–Ω', '–°–≤–∞–ª—è–≤–∞', '–ß–æ–ø',

  // –ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫', '–Æ–∂–Ω–æ—É–∫—Ä–∞—ó–Ω—Å—å–∫', '–í–æ–∑–Ω–µ—Å–µ–Ω—Å—å–∫', '–û—á–∞–∫—ñ–≤', '–ù–æ–≤–∏–π –ë—É–≥',
  '–ë–∞—à—Ç–∞–Ω–∫–∞', '–°–Ω—ñ–≥—É—Ä—ñ–≤–∫–∞',

  // –ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
  '–û–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ—è', '–°–≤—ñ—Ç–ª–æ–≤–æ–¥—Å—å–∫', '–ó–Ω–∞–º\'—è–Ω–∫–∞', '–ú–∞–ª–∞ –í–∏—Å–∫–∞', '–ù–æ–≤–æ–º–∏—Ä–≥–æ—Ä–æ–¥',
  '–ë–æ–±—Ä–∏–Ω–µ—Ü—å', '–ì–∞–π–≤–æ—Ä–æ–Ω', '–î–æ–ª–∏–Ω—Å—å–∫–∞', '–ù–æ–≤–æ—É–∫—Ä–∞—ó–Ω–∫–∞'
];

// API ENDPOINTS –î–õ–Ø –û–¢–†–ò–ú–ê–ù–ù–Ø –°–ü–†–ê–í–ñ–ù–Ü–• –í–Ü–î–î–Ü–õ–ï–ù–¨
const DELIVERY_API = {
  nova_poshta: {
    url: 'https://api.novaposhta.ua/v2.0/json/',
    method: 'POST'
  },
  ukrposhta: {
    url: 'https://www.ukrposhta.ua/api/postoffice_ca/',
    method: 'GET'
  }
};

// –ö–ï–® –î–õ–Ø –í–Ü–î–î–Ü–õ–ï–ù–¨ (—â–æ–± –Ω–µ —Ä–æ–±–∏—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ñ –∑–∞–ø–∏—Ç–∏)
const branchesCache = new Map();

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –í–ò–ü–†–ê–í–õ–ï–ù–ê –≤–µ—Ä—Å—ñ—è checkout form —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞');
    console.log(`üìä –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${UKRAINIAN_CITIES.length} —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –º—ñ—Å—Ç`);
    
    // –ó–ê–ë–û–†–û–ù–ê –ö–û–®–ò–ö–ê –ù–ê –°–¢–û–†–Ü–ù–¶–Ü CHECKOUT
    const cartBtn = document.getElementById('cart-btn');
    if (cartBtn) {
        cartBtn.style.pointerEvents = 'none';
        cartBtn.style.opacity = '0.5';
        cartBtn.setAttribute('title', '–ù–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∫–æ—à–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π');
    }
    
    const cityInput = document.querySelector('input[name="city"]');
    const citySuggestions = document.getElementById('city-suggestions');
    const deliverySection = document.getElementById('delivery-section');
    const deliveryTypeInputs = document.querySelectorAll('input[name="delivery_type"]');
    
    // –ï–ª–µ–º–µ–Ω—Ç–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–µ–ª–µ–∫—Ç—É –≤—ñ–¥–¥—ñ–ª–µ–Ω—å
    const branchesContainer = document.getElementById('branches-container');
    const branchesCurrent = document.getElementById('branches-current');
    const branchesDropdown = document.getElementById('branches-dropdown');
    const deliveryAddressInput = document.getElementById('delivery_address_input');
    
    // DEBUG: –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –µ–ª–µ–º–µ–Ω—Ç–∏ –∑–Ω–∞–π–¥–µ–Ω—ñ
    console.log('üîç –ï–ª–µ–º–µ–Ω—Ç–∏ dropdown:', {
        branchesCurrent: !!branchesCurrent,
        branchesDropdown: !!branchesDropdown,
        deliveryAddressInput: !!deliveryAddressInput
    });
    
    // –ü–æ—á–∞—Ç–∫–æ–≤–æ –¥–µ–∞–∫—Ç–∏–≤—É—î–º–æ —Å–µ–∫—Ü—ñ—é –¥–æ—Å—Ç–∞–≤–∫–∏
    deliverySection.classList.add('disabled');
    
    // *** –ê–í–¢–û–ö–û–ú–ü–õ–ï–¢ –ú–Ü–°–¢ ***
    if (cityInput) {
        cityInput.addEventListener('input', function(e) {
            const value = e.target.value.toLowerCase().trim();
            
            if (value.length < 1) {
                citySuggestions.style.display = 'none';
                disableDeliverySection();
                return;
            }
            
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –∑–±—ñ–≥–∏: —Å–ø–æ—á–∞—Ç–∫—É —Ç—ñ —â–æ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –∑ –≤–≤–µ–¥–µ–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É, –ø–æ—Ç—ñ–º —Ç—ñ —â–æ –º—ñ—Å—Ç—è—Ç—å
            const startsWithMatches = UKRAINIAN_CITIES.filter(city => 
                city.toLowerCase().startsWith(value)
            );
            
            const containsMatches = UKRAINIAN_CITIES.filter(city => 
                city.toLowerCase().includes(value) && !startsWithMatches.includes(city)
            );
            
            const matches = [...startsWithMatches, ...containsMatches].slice(0, 10); // –ü–æ–∫–∞–∑—É—î–º–æ –¥–æ 10 –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤
            
            if (matches.length > 0) {
                // –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ –∑–±—ñ–≥—ñ–≤
                citySuggestions.innerHTML = matches.map(city => {
                    const regex = new RegExp(`(${value})`, 'gi');
                    const highlightedCity = city.replace(regex, '<strong>$1</strong>');
                    return `<div class="city-suggestion" data-city="${city}">${highlightedCity}</div>`;
                }).join('');
                citySuggestions.style.display = 'block';
            } else {
                // –Ø–∫—â–æ —Ç–æ—á–Ω–∏—Ö –∑–±—ñ–≥—ñ–≤ –Ω–µ–º–∞—î, –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                citySuggestions.innerHTML = `<div class="city-suggestion" style="opacity: 0.7; pointer-events: none;">–ù–∞—Å–µ–ª–µ–Ω–∏–π –ø—É–Ω–∫—Ç "${e.target.value}" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>`;
                citySuggestions.style.display = 'block';
            }
        });
        
        // –í–∏–±—ñ—Ä –º—ñ—Å—Ç–∞ –∑—ñ —Å–ø–∏—Å–∫—É
        citySuggestions.addEventListener('click', function(e) {
            if (e.target.classList.contains('city-suggestion') && e.target.dataset.city) {
                const selectedCity = e.target.dataset.city;
                cityInput.value = selectedCity;
                citySuggestions.style.display = 'none';
                
                // –ê–∫—Ç–∏–≤—É—î–º–æ –ø–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏
                enableDeliverySection(selectedCity);
            }
        });
        
        // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ —Ñ–æ–∫—É—Å—É
        document.addEventListener('click', function(e) {
            if (!cityInput.contains(e.target) && !citySuggestions.contains(e.target)) {
                citySuggestions.style.display = 'none';
            }
        });
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ —Ñ–æ–∫—É—Å—É –ø–æ–ª—è –º—ñ—Å—Ç–∞
        cityInput.addEventListener('blur', function() {
            setTimeout(() => {
                const cityValue = cityInput.value.trim();
                if (cityValue && UKRAINIAN_CITIES.includes(cityValue)) {
                    enableDeliverySection(cityValue);
                } else if (cityValue) {
                    // –Ø–∫—â–æ –º—ñ—Å—Ç–æ –≤–≤–µ–¥–µ–Ω–æ, –∞–ª–µ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ —Å–ø–∏—Å–∫—É, –≤—Å–µ –æ–¥–Ω–æ –∞–∫—Ç–∏–≤—É—î–º–æ
                    console.log('‚úÖ –ê–∫—Ç–∏–≤—É—î–º–æ –¥–æ—Å—Ç–∞–≤–∫—É –¥–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –º—ñ—Å—Ç–∞:', cityValue);
                    enableDeliverySection(cityValue);
                } else {
                    disableDeliverySection();
                }
            }, 200);
        });
        
        // ENTER –¥–ª—è –≤–∏–±–æ—Ä—É –ø–µ—Ä—à–æ–≥–æ –≤–∞—Ä—ñ–∞–Ω—Ç—É
        cityInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && citySuggestions.style.display === 'block') {
                const firstSuggestion = citySuggestions.querySelector('.city-suggestion[data-city]');
                if (firstSuggestion) {
                    e.preventDefault();
                    const selectedCity = firstSuggestion.dataset.city;
                    cityInput.value = selectedCity;
                    citySuggestions.style.display = 'none';
                    enableDeliverySection(selectedCity);
                }
            }
        });
    }
    
    // *** –§–£–ù–ö–¶–Ü–á –ê–ö–¢–ò–í–ê–¶–Ü–á/–î–ï–ê–ö–¢–ò–í–ê–¶–Ü–á –î–û–°–¢–ê–í–ö–ò ***
    function enableDeliverySection(cityName) {
        console.log('‚úÖ –ê–∫—Ç–∏–≤—É—î–º–æ –¥–æ—Å—Ç–∞–≤–∫—É –¥–ª—è –º—ñ—Å—Ç–∞:', cityName);
        deliverySection.classList.remove('disabled');
        
        const helpText = document.getElementById('delivery-address-help');
        if (helpText) {
            helpText.textContent = '–í–∏–±–µ—Ä—ñ—Ç—å —Å–ø–æ—Å—ñ–± –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–¥—ñ–ª–µ–Ω—å';
        }
        
        // –Ø–∫—â–æ –≤–∂–µ –≤–∏–±—Ä–∞–Ω–æ —Ç–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏ - –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è
        const selectedDeliveryType = document.querySelector('input[name="delivery_type"]:checked');
        if (selectedDeliveryType) {
            loadBranches(cityName, selectedDeliveryType.value);
        }
    }
    
    function disableDeliverySection() {
        console.log('‚ùå –î–µ–∞–∫—Ç–∏–≤—É—î–º–æ –¥–æ—Å—Ç–∞–≤–∫—É');
        deliverySection.classList.add('disabled');
        
        // –°–∫–∏–¥–∞—î–º–æ –∫–∞—Å—Ç–æ–º–Ω–∏–π —Å–µ–ª–µ–∫—Ç
        resetBranchesSelect();
        
        const helpText = document.getElementById('delivery-address-help');
        if (helpText) {
            helpText.textContent = '–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ';
        }
    }
    
    // *** –§–£–ù–ö–¶–Ü–á –î–õ–Ø –ö–ê–°–¢–û–ú–ù–û–ì–û –°–ï–õ–ï–ö–¢–£ –í–Ü–î–î–Ü–õ–ï–ù–¨ ***
    function resetBranchesSelect() {
        console.log('üîÑ –°–∫–∏–¥–∞—î–º–æ —Å–µ–ª–µ–∫—Ç –≤—ñ–¥–¥—ñ–ª–µ–Ω—å');
        if (branchesCurrent) {
            branchesCurrent.setAttribute('disabled', 'true');
            branchesCurrent.querySelector('.branches-text').textContent = '–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ —Ç–∞ —Ç–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏';
            branchesCurrent.classList.remove('open');
        }
        if (branchesDropdown) {
            branchesDropdown.style.display = 'none';
            branchesDropdown.classList.remove('show'); // –¢–∞–∫–æ–∂ –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –∫–ª–∞—Å
            branchesDropdown.innerHTML = '';
        }
        if (deliveryAddressInput) {
            deliveryAddressInput.value = '';
        }
    }
    
    function setupBranchesSelect(branches, deliveryType) {
        console.log('üèóÔ∏è –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —Å–µ–ª–µ–∫—Ç –≤—ñ–¥–¥—ñ–ª–µ–Ω—å:', branches.length, '–µ–ª–µ–º–µ–Ω—Ç—ñ–≤');
        
        if (!branchesCurrent || !branchesDropdown) {
            console.error('‚ùå –ï–ª–µ–º–µ–Ω—Ç–∏ —Å–µ–ª–µ–∫—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ!');
            return;
        }
        
        const providerName = deliveryType === 'nova_poshta' ? '–ù–æ–≤–æ—ó –ü–æ—à—Ç–∏' : '–£–∫—Ä–ø–æ—à—Ç–∏';
        
        if (branches.length === 0) {
            branchesCurrent.setAttribute('disabled', 'true');
            branchesCurrent.querySelector('.branches-text').textContent = `‚ùå –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ${providerName} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ`;
            branchesDropdown.innerHTML = '';
            return;
        }
        
        // –ê–∫—Ç–∏–≤—É—î–º–æ —Å–µ–ª–µ–∫—Ç
        branchesCurrent.removeAttribute('disabled');
        branchesCurrent.querySelector('.branches-text').textContent = `üìç –û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ${providerName} (${branches.length})`;
        
        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –æ–ø—Ü—ñ—ó (–°–ü–†–û–©–ï–ù–ò–ô –§–û–†–ú–ê–¢ - –¢–Ü–õ–¨–ö–ò –ù–û–ú–ï–† –Ü –ê–î–†–ï–°–ê)
        branchesDropdown.innerHTML = branches.map(branch => {
            // –í–∏—Ç—è–≥—É—î–º–æ –Ω–æ–º–µ—Ä –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –∑ –Ω–∞–∑–≤–∏
            const numberMatch = branch.name.match(/#?(\d+)/);
            const branchNumber = numberMatch ? numberMatch[1] : '‚Äî';
            
            // –°–∫–æ—Ä–æ—á—É—î–º–æ –∞–¥—Ä–µ—Å—É, –ø—Ä–∏–±–∏—Ä–∞—é—á–∏ –∑–∞–π–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
            let shortAddress = branch.address || branch.name;
            shortAddress = shortAddress.replace(/–≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è|–≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ\d+/gi, '').replace(/\s+/g, ' ').trim();
            
            return `
                <div class="branch-option" data-value="${branch.name}" data-id="${branch.id}">
                    <span class="branch-number">#${branchNumber}</span>
                    <span class="branch-address">${shortAddress}</span>
                </div>
            `;
        }).join('');
        
        console.log('‚úÖ –°–µ–ª–µ–∫—Ç –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π, HTML –¥–æ–¥–∞–Ω–æ:', branchesDropdown.innerHTML.length, '—Å–∏–º–≤–æ–ª—ñ–≤');
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –¥–æ–ø–æ–º—ñ–∂–Ω–∏–π —Ç–µ–∫—Å—Ç
        const helpText = document.getElementById('delivery-address-help');
        if (helpText) {
            helpText.textContent = `–ó–Ω–∞–π–¥–µ–Ω–æ ${branches.length} –≤—ñ–¥–¥—ñ–ª–µ–Ω—å ${providerName}`;
        }
    }
    
    // –í–ò–ü–†–ê–í–õ–ï–ù–ò–ô –û–ë–†–û–ë–ù–ò–ö –ü–û–î–Ü–ô –î–õ–Ø –ö–ê–°–¢–û–ú–ù–û–ì–û –°–ï–õ–ï–ö–¢–£
    if (branchesCurrent) {
        branchesCurrent.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è –ö–ª—ñ–∫ –ø–æ —Å–µ–ª–µ–∫—Ç—É –≤—ñ–¥–¥—ñ–ª–µ–Ω—å');
            
            if (this.hasAttribute('disabled')) {
                console.log('‚ùå –°–µ–ª–µ–∫—Ç –≤—ñ–¥–∫–ª—é—á–µ–Ω–∏–π');
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            const isOpen = this.classList.contains('open');
            console.log('üìÇ –°—Ç–∞–Ω —Å–µ–ª–µ–∫—Ç—É (–¥–æ):', isOpen ? '–≤—ñ–¥–∫—Ä–∏—Ç–∏–π' : '–∑–∞–∫—Ä–∏—Ç–∏–π');
            
            if (isOpen) {
                // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ
                this.classList.remove('open');
                branchesDropdown.style.display = 'none';
                branchesDropdown.classList.remove('show');
                console.log('üìê –ó–∞–∫—Ä–∏–≤–∞—î–º–æ dropdown');
            } else {
                // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ
                this.classList.add('open');
                branchesDropdown.style.display = 'block';
                branchesDropdown.classList.add('show');
                console.log('üìÇ –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ dropdown');
                
                // –î–æ–¥–∞—Ç–∫–æ–≤–∏–π DEBUG
                console.log('üîç –°—Ç–∏–ª—ñ dropdown –ø—ñ—Å–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è:', {
                    display: branchesDropdown.style.display,
                    hasShowClass: branchesDropdown.classList.contains('show'),
                    offsetHeight: branchesDropdown.offsetHeight,
                    innerHTML: branchesDropdown.innerHTML.slice(0, 100) + '...'
                });
            }
        });
    }
    
    // –ö–ª—ñ–∫ –Ω–∞ –æ–ø—Ü—ñ—é –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è
    if (branchesDropdown) {
        branchesDropdown.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è –ö–ª—ñ–∫ –ø–æ –æ–ø—Ü—ñ—ó –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è');
            const option = e.target.closest('.branch-option');
            if (option) {
                const value = option.getAttribute('data-value');
                const number = option.querySelector('.branch-number').textContent;
                const address = option.querySelector('.branch-address').textContent;
                
                console.log('‚úÖ –í–∏–±—Ä–∞–Ω–æ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è:', { value, number, address });
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                branchesCurrent.querySelector('.branches-text').textContent = `${number} ${address}`;
                
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è —Ñ–æ—Ä–º–∏
                deliveryAddressInput.value = value;
                
                // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ dropdown
                branchesCurrent.classList.remove('open');
                branchesDropdown.style.display = 'none';
                branchesDropdown.classList.remove('show');
                
                console.log('‚úÖ –í–∏–±—Ä–∞–Ω–æ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è:', value);
            }
        });
    }
    
    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ dropdown –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
    document.addEventListener('click', function(e) {
        if (branchesContainer && !branchesContainer.contains(e.target)) {
            if (branchesCurrent && branchesDropdown) {
                branchesCurrent.classList.remove('open');
                branchesDropdown.style.display = 'none';
                branchesDropdown.classList.remove('show');
            }
        }
    });
    
    // *** –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –í–Ü–î–î–Ü–õ–ï–ù–¨ ***
    async function loadBranches(cityName, deliveryType) {
        console.log('üì¶ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è:', cityName, deliveryType);
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–µ—à
        const cacheKey = `${cityName}_${deliveryType}`;
        if (branchesCache.has(cacheKey)) {
            console.log('üíæ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–µ—à –¥–ª—è', cacheKey);
            setupBranchesSelect(branchesCache.get(cacheKey), deliveryType);
            return;
        }
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        if (branchesCurrent) {
            branchesCurrent.removeAttribute('disabled');
            branchesCurrent.querySelector('.branches-text').textContent = 'üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è...';
        }
        
        try {
            let branches = [];
            
            if (deliveryType === 'nova_poshta') {
                branches = await fetchNovaPoshtaBranches(cityName);
            } else if (deliveryType === 'ukrposhta') {
                branches = await fetchUkrPoshtaBranches(cityName);
            }
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ –∫–µ—à
            branchesCache.set(cacheKey, branches);
            
            setupBranchesSelect(branches, deliveryType);
            
        } catch (error) {
            console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–¥—ñ–ª–µ–Ω—å:', error);
            // Fallback –¥–æ –º–æ–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
            const fallbackBranches = getFallbackBranches(cityName, deliveryType);
            setupBranchesSelect(fallbackBranches, deliveryType);
        }
    }
    
    // API –ù–û–í–û–á –ü–û–®–¢–ò
    async function fetchNovaPoshtaBranches(cityName) {
        const requestData = {
            "modelName": "AddressGeneral",
            "calledMethod": "getWarehouses",
            "methodProperties": {
                "CityName": cityName,
                "Language": "UA"
            }
        };
        
        const response = await fetch(DELIVERY_API.nova_poshta.url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        
        if (data.success && data.data && data.data.length > 0) {
            return data.data.map(item => ({
                id: item.Ref,
                name: `–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ${item.Number}`,
                address: item.ShortAddress || item.SiteKey
            }));
        }
        
        return [];
    }
    
    // API –£–ö–†–ü–û–®–¢–ò  
    async function fetchUkrPoshtaBranches(cityName) {
        // –¶–µ –ø—Ä–∏–∫–ª–∞–¥ - –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Å–ª—ñ–¥–∏—Ç–∏ —Ä–µ–∞–ª—å–Ω–∏–π API –£–∫—Ä–ø–æ—à—Ç–∏
        const response = await fetch(`${DELIVERY_API.ukrposhta.url}?city=${encodeURIComponent(cityName)}`);
        const data = await response.json();
        
        if (data && Array.isArray(data)) {
            return data.map(item => ({
                id: item.id,
                name: `–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ${item.number || item.id}`,
                address: item.address
            }));
        }
        
        return [];
    }
    
    // FALLBACK –î–ê–ù–Ü (—è–∫—â–æ API –Ω–µ –ø—Ä–∞—Ü—é—î)
    function getFallbackBranches(cityName, deliveryType) {
        const fallbackData = {
            'nova_poshta': {
                '–ö–∏—ó–≤': [
                    {id: 1, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ1', address: '–≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫, 15'},
                    {id: 2, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ2', address: '–≤—É–ª. –°–∞–∫—Å–∞–≥–∞–Ω—Å—å–∫–æ–≥–æ, 33'},
                    {id: 5, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ5', address: '–≤—É–ª. –û–±–æ–ª–æ–Ω—Å—å–∫–∞, 1'},
                    {id: 7, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ7', address: '–ø—Ä–æ—Å–ø. –ü–µ—Ä–µ–º–æ–≥–∏, 67'},
                    {id: 12, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ12', address: '–≤—É–ª. –ê–Ω—Ç–æ–Ω–æ–≤–∏—á–∞, 44'}
                ],
                '–ë–æ—è—Ä–∫–∞': [
                    {id: 101, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ1', address: '–≤—É–ª. –®–µ–≤—á–µ–Ω–∫–∞, 45'},
                    {id: 102, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ2', address: '–≤—É–ª. –ë—ñ–ª–æ–≥–æ—Ä–æ–¥—Å—å–∫–∞, 12'},
                    {id: 103, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ3', address: '–≤—É–ª. –ú–æ–ª–æ–¥—ñ–∂–Ω–∞, 8'}
                ],
                '–•–∞—Ä–∫—ñ–≤': [
                    {id: 201, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ1', address: '–≤—É–ª. –°—É–º—Å—å–∫–∞, 12'},
                    {id: 203, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ3', address: '–ø—Ä–æ—Å–ø. –ù–∞—É–∫–∏, 45'},
                    {id: 208, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ8', address: '–≤—É–ª. –ü—É—à–∫—ñ–Ω—Å—å–∫–∞, 67'}
                ]
            },
            'ukrposhta': {
                '–ö–∏—ó–≤': [
                    {id: 1001, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ1', address: '–≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫, 22'},
                    {id: 1004, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ4', address: '–≤—É–ª. –í–æ–ª–æ–¥–∏–º–∏—Ä—Å—å–∫–∞, 8'},
                    {id: 1033, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ33', address: '–ø—Ä–æ—Å–ø. –ü–µ—Ä–µ–º–æ–≥–∏, 15'}
                ],
                '–ë–æ—è—Ä–∫–∞': [
                    {id: 2001, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ1', address: '–≤—É–ª. –®–µ–≤—á–µ–Ω–∫–∞, 50'},
                    {id: 2002, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ2', address: '–≤—É–ª. –ë—ñ–ª–æ–≥–æ—Ä–æ–¥—Å—å–∫–∞, 25'}
                ],
                '–•–∞—Ä–∫—ñ–≤': [
                    {id: 3001, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ1', address: '–≤—É–ª. –°—É–º—Å—å–∫–∞, 45'},
                    {id: 3002, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ2', address: '–ø—Ä–æ—Å–ø. –õ–µ–Ω—ñ–Ω–∞, 12'}
                ]
            }
        };
        
        return fallbackData[deliveryType] && fallbackData[deliveryType][cityName] || 
               generateDefaultBranches(cityName, deliveryType);
    }
    
    function generateDefaultBranches(cityName, deliveryType) {
        return [
            {id: 1, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ1', address: '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ –º—ñ—Å—Ç–∞'},
            {id: 2, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ2', address: '–ó–∞–ª—ñ–∑–Ω–∏—á–Ω–∏–π –≤–æ–∫–∑–∞–ª'},
            {id: 3, name: '–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ3', address: '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π —Ä–∏–Ω–æ–∫'}
        ];
    }
    
    // *** –û–ë–†–û–ë–ù–ò–ö–ò –ü–û–î–Ü–ô –î–õ–Ø –¢–ò–ü–£ –î–û–°–¢–ê–í–ö–ò ***
    deliveryTypeInputs.forEach(input => {
        input.addEventListener('change', function() {
            const cityName = cityInput.value.trim();
            if (cityName && this.checked) {
                loadBranches(cityName, this.value);
            }
            
            // –í–Ü–ó–£–ê–õ–¨–ù–ï –û–ù–û–í–õ–ï–ù–ù–Ø –ö–ù–û–ü–û–ö
            updateDeliveryTypeVisual();
        });
    });
    
    // –†–æ–±–∏–º–æ delivery option –∫–Ω–æ–ø–∫–∏ –∫–ª—ñ–∫–∞–±–µ–ª—å–Ω–∏–º–∏
    const deliveryOptions = document.querySelectorAll('.delivery-type-option');
    deliveryOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
                const radio = this.querySelector('input[type="radio"]');
                if (radio && !radio.disabled) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
        });
    });
    
    // –§–£–ù–ö–¶–Ü–Ø –í–Ü–ó–£–ê–õ–¨–ù–û–ì–û –û–ù–û–í–õ–ï–ù–ù–Ø –¢–ò–ü–£ –î–û–°–¢–ê–í–ö–ò
    function updateDeliveryTypeVisual() {
        deliveryOptions.forEach(option => {
            const radio = option.querySelector('input[type="radio"]');
            if (radio && radio.checked) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
    }
    
    // –ü–æ—á–∞—Ç–∫–æ–≤–µ –≤—ñ–∑—É–∞–ª—å–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
    updateDeliveryTypeVisual();
    
    // *** –ú–ê–°–ö–ê –î–õ–Ø –¢–ï–õ–ï–§–û–ù–£ ***
    const phoneInput = document.querySelector('input[name="phone"]');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è +380
            if (value.startsWith('380')) {
                value = '+' + value;
            } else if (value.startsWith('0')) {
                value = '+38' + value;
            } else if (value && !value.startsWith('+')) {
                value = '+380' + value;
            }
            
            // –û–±–º–µ–∂–µ–Ω–Ω—è –¥–æ–≤–∂–∏–Ω–∏
            if (value.length > 13) {
                value = value.slice(0, 13);
            }
            
            e.target.value = value;
        });
        
        // Placeholder –∑ –ø—Ä–∏–∫–ª–∞–¥–æ–º
        phoneInput.placeholder = '+380671234567';
    }
    
    // *** –í–ê–õ–Ü–î–ê–¶–Ü–Ø –§–û–†–ú–ò –ü–†–ò –ù–ê–î–°–ò–õ–ê–ù–ù–Ü ***
    const form = document.getElementById('checkout-form');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    
    if (form) {
        form.addEventListener('submit', function(e) {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤–∏–±—Ä–∞–Ω–æ –º—ñ—Å—Ç–æ
            const cityValue = cityInput.value.trim();
            if (!cityValue) {
                alert('‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ');
                e.preventDefault();
                return;
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤–∏–±—Ä–∞–Ω–æ —Å–ø–æ—Å—ñ–± –¥–æ—Å—Ç–∞–≤–∫–∏
            const selectedDelivery = document.querySelector('input[name="delivery_type"]:checked');
            if (!selectedDelivery) {
                alert('‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å —Å–ø–æ—Å—ñ–± –¥–æ—Å—Ç–∞–≤–∫–∏');
                e.preventDefault();
                return;
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤–∏–±—Ä–∞–Ω–æ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è
            const selectedBranch = deliveryAddressInput.value;
            if (!selectedBranch) {
                alert('‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏');
                e.preventDefault();
                return;
            }
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            submitBtn.disabled = true;
            submitText.textContent = '–û–±—Ä–æ–±–∫–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è...';
            submitBtn.insertAdjacentHTML('afterbegin', '<span class="loading-spinner"></span>');
        });
    }
    
    console.log('‚ú® –í–ò–ü–†–ê–í–õ–ï–ù–ò–ô checkout form –≥–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏!');
    console.log(`üìä –ë–æ—è—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫: ${UKRAINIAN_CITIES.includes('–ë–æ—è—Ä–∫–∞')}`);
});
</script>
{% endblock %}

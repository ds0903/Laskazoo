{% extends 'zoosvit/core/base.html' %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/users/profile.css' %}">
  <link rel="stylesheet" href="{% static 'zoosvit/css/orders/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="profile-wrapper">

  <!-- –°–∞–π–¥–±–∞—Ä -->
  <aside class="profile-sidebar">
    <ul class="profile-nav">
      {% if user.is_authenticated %}
        <li><a href="{% url 'users:profile' %}">–û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ</a></li>
        <li><a href="{% url 'orders:list' %}">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</a></li>
        <li><a href="{% url 'favourites:list' %}">–û–±—Ä–∞–Ω–µ</a></li>
      {% endif %}
      <li class="active"><a href="{% url 'orders:checkout' %}">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</a></li>
    </ul>
  </aside>

  <!-- –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <section class="profile-main">
    <h1 class="profile-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

    {% if messages %}
      <div class="messages">
        {% for msg in messages %}
          <div class="message {{ msg.tags }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="checkout-container">
      <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –¢–æ–≤–∞—Ä–∏ –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ -->
      <div class="order-summary">
        <h2>–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
        
        {% if order.items.all %}
          <div class="order-items">
            {% for item in order.items.all %}
              <div class="order-item">
                <div class="item-image">
                  {% if item.variant and item.variant.image %}
                    <img src="{{ item.variant.image.url }}" alt="{{ item.product.name }}">
                  {% elif item.product.image %}
                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                  {% else %}
                    <img src="{% static 'zoosvit/img/placeholder.jpg' %}" alt="{{ item.product.name }}">
                  {% endif %}
                </div>
                
                <div class="item-details">
                  <h3>{{ item.product.name }}</h3>
                  {% if item.variant %}
                    <div class="item-variant">
                      {% if item.variant.sku %}–ê—Ä—Ç–∏–∫—É–ª: {{ item.variant.sku }}{% endif %}
                      {% if item.variant.weight %} ¬∑ {{ item.variant.weight }} –∫–≥{% endif %}
                      {% if item.variant.size %} ¬∑ {{ item.variant.size }}{% endif %}
                    </div>
                  {% endif %}
                  <div class="item-price">{{ item.retail_price }} –≥—Ä–Ω √ó {{ item.quantity }} —à—Ç</div>
                </div>
                
                <div class="item-total">
                  <strong>{{ item.line_total }} –≥—Ä–Ω</strong>
                </div>
              </div>
            {% endfor %}
          </div>
          
          <div class="order-total">
            <div class="total-row">
              <span>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</span>
              <strong>{{ total }} –≥—Ä–Ω</strong>
            </div>
          </div>
        {% else %}
          <p class="empty-order">–í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. <a href="{% url 'products:catalog' %}">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É</a></p>
        {% endif %}
      </div>

      <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è -->
      <div class="checkout-form-container">
        <h2>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ</h2>
        
        <form method="post" class="checkout-form">
          {% csrf_token %}
          
          <div class="form-section">
            <h3>–û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ</h3>
            
            <div class="form-group">
              <label for="{{ form.first_name.id_for_label }}">–Ü–º'—è *</label>
              {{ form.first_name }}
              {% if form.first_name.errors %}
                <div class="form-errors">
                  {% for error in form.first_name.errors %}
                    <span class="error">{{ error }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.phone.id_for_label }}">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
              {{ form.phone }}
              {% if form.phone.errors %}
                <div class="form-errors">
                  {% for error in form.phone.errors %}
                    <span class="error">{{ error }}</span>
                  {% endfor %}
                </div>
              {% endif %}
              <small class="form-help">–ù–∞–ø—Ä–∏–∫–ª–∞–¥: +380671234567</small>
            </div>
          </div>

          <div class="form-section">
            <h3>–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
            
            <div class="form-group">
              <label for="{{ form.city.id_for_label }}">–ú—ñ—Å—Ç–æ *</label>
              {{ form.city }}
              {% if form.city.errors %}
                <div class="form-errors">
                  {% for error in form.city.errors %}
                    <span class="error">{{ error }}</span>
                  {% endfor %}
                </div>
              {% endif %}
              <small class="form-help">–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≤–∞—à–æ–≥–æ –º—ñ—Å—Ç–∞ –∞–±–æ —ñ–Ω–¥–µ–∫—Å</small>
            </div>
          </div>

          {% if form.non_field_errors %}
            <div class="form-errors">
              {% for error in form.non_field_errors %}
                <span class="error">{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}

          <div class="form-actions">
            <button type="submit" class="btn-primary">
              <span class="btn-icon">üì¶</span>
              –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
            </button>
            <a href="{% url 'orders:cart' %}" class="btn-secondary">
              ‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –∫–æ—à–∏–∫–∞
            </a>
          </div>
        </form>

        <div class="checkout-info">
          <h3>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É</h3>
          <ul>
            <li>üìû <strong>–ó–≤'—è–∑–æ–∫ –∑ –≤–∞–º–∏</strong> ‚Äî –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É—î –ø—Ä–æ—Ç—è–≥–æ–º 30 —Ö–≤–∏–ª–∏–Ω –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</li>
            <li>üöö <strong>–î–æ—Å—Ç–∞–≤–∫–∞</strong> ‚Äî –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è –ø—Ä–æ—Ç—è–≥–æ–º 1-3 —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –≤–∞—à–æ–≥–æ –º—ñ—Å—Ç–∞</li>
            <li>üí≥ <strong>–û–ø–ª–∞—Ç–∞</strong> ‚Äî –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É –∞–±–æ –∑–∞ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∞–º–∏ (–Ω–∞ –≤–∏–±—ñ—Ä)</li>
            <li>üìù <strong>–î–æ–∫—É–º–µ–Ω—Ç–∏</strong> ‚Äî –¥–æ —Ç–æ–≤–∞—Ä—É –¥–æ–¥–∞—î—Ç—å—Å—è —á–µ–∫ —Ç–∞ –≥–∞—Ä–∞–Ω—Ç—ñ–π–Ω–∏–π —Ç–∞–ª–æ–Ω</li>
          </ul>
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ú–∞—Å–∫–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
    const phoneInput = document.querySelector('input[name=\"phone\"]');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.startsWith('380')) {
                value = '+' + value;
            } else if (value.startsWith('0')) {
                value = '+38' + value;
            } else if (value && !value.startsWith('+')) {
                value = '+380' + value;
            }
            
            // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è: +380 67 123 45 67
            if (value.length > 4) {
                value = value.slice(0, 4) + ' ' + value.slice(4);
            }
            if (value.length > 7) {
                value = value.slice(0, 7) + ' ' + value.slice(7);
            }
            if (value.length > 11) {
                value = value.slice(0, 11) + ' ' + value.slice(11);
            }
            if (value.length > 14) {
                value = value.slice(0, 14) + ' ' + value.slice(14, 16);
            }
            
            e.target.value = value;
        });
    }

    // –ê–Ω—ñ–º–∞—Ü—ñ—è –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º–∏
    const form = document.querySelector('.checkout-form');
    if (form) {
        form.addEventListener('submit', function() {
            const submitBtn = form.querySelector('button[type=\"submit\"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<span class=\"btn-icon\">‚è≥</span> –û–±—Ä–æ–±–∫–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è...';
                submitBtn.disabled = true;
            }
        });
    }
});
</script>
{% endblock %}

{% extends 'zoosvit/core/base.html' %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/users/profile.css' %}">
  <link rel="stylesheet" href="{% static 'zoosvit/css/orders/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="profile-wrapper">

  <!-- –°–∞–π–¥–±–∞—Ä -->
  <aside class="profile-sidebar">
    <ul class="profile-nav">
      {% if user.is_authenticated %}
        <li><a href="{% url 'users:profile' %}">–û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ</a></li>
        <li><a href="{% url 'orders:list' %}">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</a></li>
        <li><a href="{% url 'favourites:list' %}">–û–±—Ä–∞–Ω–µ</a></li>
      {% endif %}
      <li class="active"><a href="{% url 'orders:checkout' %}">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</a></li>
    </ul>
  </aside>

  <!-- –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <section class="profile-main">
    <h1 class="profile-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

    {% if messages %}
      <div class="messages">
        {% for msg in messages %}
          <div class="message {{ msg.tags }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="checkout-container">
      <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –¢–æ–≤–∞—Ä–∏ –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ -->
      <div class="order-summary">
        <h2>–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
        
        {% if order.items.all %}
          <div class="order-items">
            {% for item in order.items.all %}
              <div class="order-item">
                <div class="item-image">
                  {% if item.variant and item.variant.image %}
                    <img src="{{ item.variant.image.url }}" alt="{{ item.product.name }}">
                  {% elif item.product.image %}
                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                  {% else %}
                    <img src="{% static 'zoosvit/img/placeholder.jpg' %}" alt="{{ item.product.name }}">
                  {% endif %}
                </div>
                
                <div class="item-details">
                  <h3>{{ item.product.name }}</h3>
                  {% if item.variant %}
                    <div class="item-variant">
                      {% if item.variant.sku %}–ê—Ä—Ç–∏–∫—É–ª: {{ item.variant.sku }}{% endif %}
                      {% if item.variant.weight %} ¬∑ {{ item.variant.weight }} –∫–≥{% endif %}
                      {% if item.variant.size %} ¬∑ {{ item.variant.size }}{% endif %}
                    </div>
                  {% endif %}
                  <div class="item-price">{{ item.retail_price }} –≥—Ä–Ω √ó {{ item.quantity }} —à—Ç</div>
                </div>
                
                <div class="item-total">
                  <strong>{{ item.line_total }} –≥—Ä–Ω</strong>
                </div>
              </div>
            {% endfor %}
          </div>
          
          <div class="order-total">
            <div class="total-row">
              <span>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</span>
              <strong>
                {% if order.total_amount %}
                  {{ order.total_amount }} –≥—Ä–Ω
                {% else %}
                  {% load custom_tags %}
                  {{ order|calculate_total }} –≥—Ä–Ω
                {% endif %}
              </strong>
            </div>
          </div>
        {% else %}
          <p class="empty-order">–í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. <a href="{% url 'products:catalog' %}">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É</a></p>
        {% endif %}
      </div>

      <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è -->
      <div class="checkout-form-container">
        <h2>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ</h2>
        
        <form method="post" class="checkout-form" id="checkout-form">
          {% csrf_token %}
          
          <!-- –û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ -->
          <div class="form-section">
            <h3>–û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ</h3>
            
            <!-- –ü–Ü–ë -->
            <div class="form-group">
              {{ form.full_name.label_tag }}
              {{ form.full_name }}
              {% if form.full_name.errors %}
                <div class="form-errors">
                  {% for error in form.full_name.errors %}
                    <span class="error">{{ error }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
            <div class="form-group">
              {{ form.phone.label_tag }}
              {{ form.phone }}
              {% if form.phone.errors %}
                <div class="form-errors">
                  {% for error in form.phone.errors %}
                    <span class="error">{{ error }}</span>
                  {% endfor %}
                </div>
              {% endif %}
              <small class="form-help">–ù–∞–ø—Ä–∏–∫–ª–∞–¥: +380671234567</small>
            </div>

            <!-- Email -->
            <div class="form-group">
              {{ form.email.label_tag }}
              {{ form.email }}
              {% if form.email.errors %}
                <div class="form-errors">
                  {% for error in form.email.errors %}
                    <span class="error">{{ error }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>

          <!-- –¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏ -->
          <div class="form-section">
            <h3>{{ form.delivery_type.label }}</h3>
            
            <div class="form-group">
              <div class="delivery-type-options">
                {% for radio in form.delivery_type %}
                  <div class="delivery-type-option" data-value="{{ radio.choice_value }}">
                    {{ radio.tag }}
                    <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                  </div>
                {% endfor %}
              </div>
              {% if form.delivery_type.errors %}
                <div class="form-errors">
                  {% for error in form.delivery_type.errors %}
                    <span class="error">{{ error }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- –ü–æ–ª–µ –∞–¥—Ä–µ—Å–∏ (–∑–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º–µ) -->
            <div class="form-group" id="delivery-address-group">
              <label for="{{ form.delivery_address.id_for_label }}" id="delivery-address-label">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏ *</label>
              {{ form.delivery_address }}
              {% if form.delivery_address.errors %}
                <div class="form-errors">
                  {% for error in form.delivery_address.errors %}
                    <span class="error">{{ error }}</span>
                  {% endfor %}
                </div>
              {% endif %}
              <small class="form-help" id="delivery-address-help">–í–∫–∞–∂—ñ—Ç—å –∞–¥—Ä–µ—Å—É –∞–±–æ –Ω–æ–º–µ—Ä –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</small>
            </div>
          </div>

          <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä -->
          <div class="form-section">
            <h3>–ö–æ–º–µ–Ω—Ç–∞—Ä</h3>
            
            <div class="form-group">
              {{ form.comment.label_tag }}
              {{ form.comment }}
              <small class="form-help">–ó–∞ –±–∞–∂–∞–Ω–Ω—è–º</small>
            </div>
          </div>

          {% if form.non_field_errors %}
            <div class="form-errors">
              {% for error in form.non_field_errors %}
                <span class="error">{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}

          <div class="form-actions">
            <button type="submit" class="btn-primary">
              <span class="btn-icon">üì¶</span>
              –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
            </button>
          </div>
        </form>

        <div class="checkout-info">
          <h3>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É</h3>
          <p>üìû <strong>–ó–≤'—è–∑–æ–∫ –∑ –≤–∞–º–∏</strong> ‚Äî –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É—î –ø—Ä–æ—Ç—è–≥–æ–º 30 —Ö–≤–∏–ª–∏–Ω –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</p>
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deliveryTypeInputs = document.querySelectorAll('input[name="delivery_type"]');
    const deliveryAddressLabel = document.getElementById('delivery-address-label');
    const deliveryAddressHelp = document.getElementById('delivery-address-help');
    const deliveryOptions = document.querySelectorAll('.delivery-type-option');
    
    // –†–æ–±–∏–º–æ –≤—Å—é –∫–Ω–æ–ø–∫—É –∫–ª—ñ–∫–∞–±–µ–ª—å–Ω–æ—é
    deliveryOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            // –Ø–∫—â–æ –∫–ª—ñ–∫ –Ω–µ –ø–æ —Å–∞–º–æ–º—É radio-button, –∞–∫—Ç–∏–≤—É—î–º–æ –π–æ–≥–æ
            if (e.target.type !== 'radio') {
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    // –¢—Ä–∏–≥–µ—Ä–∏–º–æ –ø–æ–¥—ñ—é change
                    radio.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
        });
        
        // –î–æ–¥–∞—î–º–æ –∫—É—Ä—Å–æ—Ä pointer
        option.style.cursor = 'pointer';
    });
    
    function updateDeliveryAddressText() {
        const selectedDelivery = document.querySelector('input[name="delivery_type"]:checked');
        if (selectedDelivery) {
            if (selectedDelivery.value === 'nova_poshta') {
                deliveryAddressLabel.textContent = '–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏ *';
                deliveryAddressHelp.textContent = '–í–∫–∞–∂—ñ—Ç—å –∞–¥—Ä–µ—Å—É –∞–±–æ –Ω–æ–º–µ—Ä –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏';
            } else if (selectedDelivery.value === 'ukrposhta') {
                deliveryAddressLabel.textContent = '–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –£–∫—Ä–ø–æ—à—Ç–∏ *';
                deliveryAddressHelp.textContent = '–í–∫–∞–∂—ñ—Ç—å –∞–¥—Ä–µ—Å—É –∞–±–æ –Ω–æ–º–µ—Ä –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –£–∫—Ä–ø–æ—à—Ç–∏';
            }
        }
    }
    
    // –°–ª—É—Ö–∞—î–º–æ –∑–º—ñ–Ω–∏ —Ç–∏–ø—É –¥–æ—Å—Ç–∞–≤–∫–∏
    deliveryTypeInputs.forEach(input => {
        input.addEventListener('change', updateDeliveryAddressText);
    });
    
    // –ü–æ—á–∞—Ç–∫–æ–≤–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ù–æ–≤–∞ –ü–æ—à—Ç–∞)
    updateDeliveryAddressText();

    // –ú–∞—Å–∫–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—É
    const phoneInput = document.querySelector('input[name="phone"]');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.startsWith('380')) {
                value = '+' + value;
            } else if (value.startsWith('0')) {
                value = '+38' + value;
            } else if (value && !value.startsWith('+')) {
                value = '+380' + value;
            }
            
            if (value.length > 13) {
                value = value.slice(0, 13);
            }
            
            e.target.value = value;
        });
    }

    // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ñ–æ—Ä–º–∏
    const form = document.getElementById('checkout-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = form.querySelector('button[type="submit"]');
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è
            const fullName = form.querySelector('input[name="full_name"]').value.trim();
            const phone = form.querySelector('input[name="phone"]').value.trim();
            const email = form.querySelector('input[name="email"]').value.trim();
            const deliveryAddress = form.querySelector('textarea[name="delivery_address"]').value.trim();
            const deliveryType = form.querySelector('input[name="delivery_type"]:checked');
            
            if (!fullName) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª–µ –ü–Ü–ë');
                e.preventDefault();
                return;
            }
            
            if (!phone) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω');
                e.preventDefault();
                return;
            }
            
            if (!email) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª–µ email');
                e.preventDefault();
                return;
            }
            
            if (!deliveryAddress) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –∞–¥—Ä–µ—Å—É –¥–æ—Å—Ç–∞–≤–∫–∏');
                e.preventDefault();
                return;
            }
            
            if (!deliveryType) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏');
                e.preventDefault();
                return;
            }
            
            // –Ø–∫—â–æ –≤—Å–µ –û–ö - –ø–æ–∫–∞–∑—É—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é
            if (submitBtn) {
                submitBtn.innerHTML = '<span class="btn-icon">‚è≥</span> –û–±—Ä–æ–±–∫–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è...';
                submitBtn.disabled = true;
            }
        });
    }
});
</script>

<style>
/* –°—Ç–∏–ª—ñ –¥–ª—è —Ç–∏–ø—ñ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏ - –ü–û–í–ù–Ü–°–¢–Æ –ö–õ–Ü–ö–ê–ë–ï–õ–¨–ù–Ü */
.delivery-type-options {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin: 16px 0;
}

.delivery-type-option {
  display: flex;
  align-items: center;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  transition: border-color 0.3s ease;
  cursor: pointer !important; /* –í—Å—è –∫–Ω–æ–ø–∫–∞ –∫–ª—ñ–∫–∞–±–µ–ª—å–Ω–∞ */
  user-select: none; /* –ó–∞–±–æ—Ä–æ–Ω–∞ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –ø—Ä–∏ –∫–ª—ñ–∫–∞—Ö */
}

.delivery-type-option:hover {
  border-color: #0f6b38;
}

.delivery-type-option input[type="radio"] {
  margin-right: 12px;
  accent-color: #0f6b38;
  cursor: pointer;
}

.delivery-type-option input[type="radio"]:checked + label {
  font-weight: 600;
}

.delivery-type-option:has(input[type="radio"]:checked) {
  border-color: #0f6b38;
  background-color: #f8fdf9;
}

.delivery-type-option label {
  cursor: pointer;
  font-size: 1rem;
  color: #333;
  flex: 1; /* –ó–∞–π–º–∞—î –≤—Å—é —à–∏—Ä–∏–Ω—É */
  pointer-events: none; /* –ù–µ –±–ª–æ–∫—É—î –∫–ª—ñ–∫–∏ –Ω–∞ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –µ–ª–µ–º–µ–Ω—Ç */
}

/* –ü–æ–ª–µ –∫–æ–º–µ–Ω—Ç–∞—Ä—è */
.form-control {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 0.95rem;
  font-family: inherit;
  resize: vertical;
  transition: border-color 0.3s ease;
}

.form-control:focus {
  outline: none;
  border-color: #0f6b38;
  box-shadow: 0 0 0 3px rgba(15, 107, 56, 0.1);
}

/* –û–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è - —á–µ—Ä–≤–æ–Ω—ñ –ø–æ–º–∏–ª–∫–∏ */
.form-control:invalid {
  border-color: #d32f2f;
}

/* –¶–µ–Ω—Ç—Ä—É—î–º–æ –∫–Ω–æ–ø–∫—É */
.form-actions {
  text-align: center;
  margin-top: 32px;
}

.form-actions .btn-primary {
  min-width: 250px;
  padding: 14px 24px;
  font-size: 1.1rem;
  font-weight: 600;
  background: linear-gradient(135deg, #0f6b38 0%, #1a8f4a 100%);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.form-actions .btn-primary:hover {
  background: linear-gradient(135deg, #0d5a2f 0%, #168040 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(15, 107, 56, 0.3);
}

.form-actions .btn-primary:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

.btn-icon {
  font-size: 1.2em;
}

/* –°—Ç–∏–ª—ñ –¥–ª—è —Ñ–æ—Ä–º–∏ */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #333;
}

.form-errors {
  margin-top: 5px;
}

.form-errors .error {
  color: #d32f2f;
  font-size: 0.875rem;
}

.form-help {
  display: block;
  margin-top: 4px;
  font-size: 0.875rem;
  color: #666;
}

/* –°–µ–∫—Ü—ñ—ó —Ñ–æ—Ä–º–∏ */
.form-section {
  margin-bottom: 32px;
  padding-bottom: 24px;
  border-bottom: 1px solid #e0e0e0;
}

.form-section:last-of-type {
  border-bottom: none;
}

.form-section h3 {
  margin: 0 0 16px 0;
  color: #0f6b38;
  font-size: 1.2rem;
  font-weight: 600;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
@media (max-width: 768px) {
  .delivery-type-options {
    gap: 12px;
  }
  
  .delivery-type-option {
    padding: 10px;
  }
  
  .form-actions .btn-primary {
    min-width: 100%;
  }
}
</style>
{% endblock %}
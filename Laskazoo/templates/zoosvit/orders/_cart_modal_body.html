{% load static %}

<div class="cm-header">
  <h3>Кошик</h3>
  <button class="cm-close" aria-label="Закрити">×</button>
</div>

{# 1) Авторизований користувач з позиціями #}
{% if user.is_authenticated and order and order.items.all %}
  <ul class="cm-items">
    {% for item in order.items.all %}
      <li class="cm-row {% if item.variant and not item.variant.is_active or item.variant and item.variant.warehouse_quantity == 0 or not item.variant and not item.product.is_active or not item.variant and item.product.warehouse_quantity == 0 %}out-of-stock{% endif %}" data-item="{{ item.id }}">
        <div class="cm-thumb">
          {% if item.variant and item.variant.image %}
            <img src="{{ item.variant.image.url }}" alt="{{ item.product.name }}">
          {% elif item.product.image %}
            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
          {% else %}
            <img src="{% static 'zoosvit/img/placeholder.jpg' %}" alt="{{ item.product.name }}">
          {% endif %}
        </div>

        <div class="cm-info">
          <div class="cm-title">{{ item.product.name }}</div>
          {% if item.variant %}
            <div class="cm-meta">
              {% if item.variant.sku %}SKU: {{ item.variant.sku }}{% endif %}
              {% if item.variant.weight %} · {{ item.variant.weight }} г{% endif %}
              {% if item.variant.size %} · Розмір {{ item.variant.size }}{% endif %}
            </div>
          {% endif %}
          {% if item.variant and not item.variant.is_active or item.variant and item.variant.warehouse_quantity == 0 or not item.variant and not item.product.is_active or not item.variant and item.product.warehouse_quantity == 0 %}
            <div class="out-of-stock-label">Немає в наявності</div>
          {% endif %}
        </div>

        <div class="cm-qty">
          <a href="{% url 'orders:item_dec' item.id %}?ajax=1" class="cm-btn js-cart">−</a>
          <input
            type="number"
            class="cm-qty-input"
            value="{{ item.quantity }}"
            min="1"
            {% if item.variant and item.variant.warehouse_quantity %}max="{{ item.variant.warehouse_quantity }}"{% endif %}
            data-item="{{ item.id }}"
            inputmode="numeric"
          >
          <a href="{% url 'orders:item_inc' item.id %}?ajax=1" class="cm-btn js-cart">+</a>
        </div>

        <div class="cm-sum"><b>{{ item.line_total|floatformat:2 }} грн</b></div>
        <a href="{% url 'orders:item_remove' item.id %}?ajax=1" class="cm-remove js-cart" aria-label="Видалити">×</a>
      </li>
    {% endfor %}
  </ul>

  <div class="cm-footer">
    <div class="cm-total">Всього: <b>{{ total }} грн</b></div>
    <div class="cm-actions">
      <a href="{% url 'orders:checkout' %}" class="btn-green cm-checkout" id="checkout-btn">Оформити замовлення</a>
      <a href="{% url 'orders:clear' %}?ajax=1" class="btn-outline js-cart">Очистити кошик</a>
    </div>
  </div>
  
  <script>
  // Перевіряємо наявність ХОЧА Б ОДНОГО активного товару
  (function() {
    const checkoutBtn = document.getElementById('checkout-btn');
    if (!checkoutBtn) return;
    
    // Підраховуємо активні та неактивні товари
    const allItems = document.querySelectorAll('.cm-row');
    const inactiveItems = document.querySelectorAll('.cm-row.out-of-stock');
    const activeItemsCount = allItems.length - inactiveItems.length;
    
    console.log('Всього товарів:', allItems.length, ', Неактивних:', inactiveItems.length, ', Активних:', activeItemsCount);
    
    // Блокуємо кнопку ТІЛЬКИ якщо НЕМАЄ ЖОДНОГО активного товару
    if (activeItemsCount === 0) {
      checkoutBtn.style.opacity = '0.5';
      checkoutBtn.style.cursor = 'not-allowed';
      checkoutBtn.style.pointerEvents = 'none';
      checkoutBtn.style.background = '#ccc';
      
      // Додаємо повідомлення при спробі кліку
      checkoutBtn.addEventListener('click', function(e) {
        e.preventDefault();
        alert('У кошику немає доступних товарів для оформлення замовлення');
      });
    }
  })();
  </script>

{# 2) Авторизований користувач з порожнім кошиком #}
{% elif user.is_authenticated %}
  <div class="cm-empty">
    <p>Ваш кошик порожній.</p>
    <p><small>Додайте товари з каталогу, щоб оформити замовлення.</small></p>
  </div>

{# 3) ГІСТЬ з товарами в сесії - показуємо кнопки авторизації #}
{% elif sitems %}
  <ul class="cm-items">
    {% for it in sitems %}
      <li class="cm-row">
        <div class="cm-thumb">
          {% if it.thumb %}<img src="{{ it.thumb }}" alt="{{ it.name }}">
          {% else %}<img src="{% static 'zoosvit/img/placeholder.jpg' %}" alt="{{ it.name }}">{% endif %}
        </div>

        <div class="cm-info">
          <div class="cm-title">{{ it.name }}</div>
          <div class="cm-meta">
            {% if it.sku %}SKU: {{ it.sku }}{% endif %}
            {% if it.weight %} · {{ it.weight }} г{% endif %}
            {% if it.size %} · Розмір {{ it.size }}{% endif %}
          </div>
        </div>

        <div class="cm-qty">
          <a href="{% url 'orders:item_dec' it.sid %}?ajax=1&guest=1" class="cm-btn js-cart">−</a>
          <input
            type="number"
            class="cm-qty-input"
            value="{{ it.qty }}"
            min="1"
            data-item="{{ it.sid }}"
            inputmode="numeric">
          <a href="{% url 'orders:item_inc' it.sid %}?ajax=1&guest=1" class="cm-btn js-cart">+</a>
        </div>

        <div class="cm-sum"><b>{{ it.line|floatformat:2 }} грн</b></div>
        <a href="{% url 'orders:item_remove' it.sid %}?ajax=1&guest=1" class="cm-remove js-cart" aria-label="Видалити">×</a>
      </li>
    {% endfor %}
  </ul>

  <div class="cm-footer">
    <div class="cm-total">Всього: <b>{{ total|floatformat:2 }} грн</b></div>
    <div class="cm-actions">
      <a href="{% url 'orders:clear' %}?ajax=1&guest=1" class="btn-outline js-cart">
        Очистити кошик
      </a>
      <a href="#" class="btn-outline" onclick="openAuthModal('register'); return false;">
        Зареєструйтесь, щоб оформити
      </a>
      <a href="#" class="btn-green" onclick="openAuthModal('login'); return false;">
        Увійти
      </a>
    </div>
  </div>

{# 4) Порожній кошик для гостя #}
{% else %}
  <div class="cm-empty">
    <p>Ваш кошик порожній.</p>
    <p><small>Додайте товари з каталогу.</small></p>
  </div>
{% endif %}

<style>
.cm-actions{
  display:flex;
  align-items:center;
  justify-content:flex-end; /* вирівняти вправо */
  gap:14px;                 /* відступ між кнопками */
  flex-wrap:wrap;
}

.cm-actions .btn-green,
.cm-actions .btn-outline{
  height:40px;
  padding:0 16px;
  border-radius:10px;
  font-weight:600;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  cursor: pointer;
}

.btn-green{
  background:#28a745;
  color:#fff !important;
  border:none;
}

.btn-outline{
  border:1px solid #ccc;
  color:#333 !important;
  background:#fff;
}

/* Стилі для неактивних товарів в кошику */
.cm-row.out-of-stock {
  opacity: 0.6;
  background: #f5f5f5;
}
.cm-row.out-of-stock .cm-thumb img {
  filter: grayscale(100%);
}
.cm-row.out-of-stock .cm-title,
.cm-row.out-of-stock .cm-meta,
.cm-row.out-of-stock .cm-sum {
  color: #999;
}
.cm-row.out-of-stock .cm-btn {
  opacity: 0.5;
  pointer-events: none;
}
.out-of-stock-label {
  color: #d9534f;
  font-weight: bold;
  font-size: 0.85em;
  margin-top: 4px;
}
</style>

<script>
// Функція для відкриття модалки авторизації з корзини
function openAuthModal(type) {
  // Закриваємо модалку корзини
  const cartModal = document.getElementById('cart-modal');
  if (cartModal) {
    cartModal.classList.add('hidden');
    document.documentElement.classList.remove('no-scroll');
  }
  
  // Відкриваємо модалку авторизації
  const authModal = document.getElementById('auth-modal');
  if (authModal) {
    // Показуємо потрібну вкладку
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginTab = document.querySelector('[data-tab="login"]');
    const registerTab = document.querySelector('[data-tab="register"]');
    
    if (type === 'login') {
      if (loginForm) loginForm.style.display = 'block';
      if (registerForm) registerForm.style.display = 'none';
      if (loginTab) loginTab.classList.add('active');
      if (registerTab) registerTab.classList.remove('active');
    } else {
      if (loginForm) loginForm.style.display = 'none';
      if (registerForm) registerForm.style.display = 'block';
      if (loginTab) loginTab.classList.remove('active');
      if (registerTab) registerTab.classList.add('active');
    }
    
    authModal.classList.add('show');
  }
}
</script>

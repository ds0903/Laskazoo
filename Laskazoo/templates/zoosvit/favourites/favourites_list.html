{# Zoosvit_shop/Zoosvit/templates/zoosvit/favourites/list.html #}
{% extends 'zoosvit/core/base.html' %}
{% load static %}

{% block title %}Обране{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/users/profile.css' %}">
  <link rel="stylesheet" href="{% static 'zoosvit/css/styles.css' %}">
{% endblock %}

{% block content %}
<div class="profile-wrapper">

  <!-- Сайдбар -->
  <aside class="profile-sidebar">
    <ul class="profile-nav">
      <li><a href="{% url 'users:profile' %}">Особисті дані</a></li>
      <li><a href="{% url 'orders:list' %}">Замовлення</a></li>
      <li class="active"><a href="{% url 'favourites:list' %}">Обране</a></li>
    </ul>
  </aside>

  <!-- Основний контент -->
  <section class="profile-main favourites-page">
    <h1 class="profile-title">Моє обране</h1>

    {% if favs %}
      <div class="product-grid">
  {% for f in favs %}
    {% with product=f.product v=f.variant %}
    <div class="prod-card">
      <!-- FRONT -->
      <div class="card-front">
        <a href="{{ product.get_absolute_url|default:'#' }}">
          {% if v and v.image %}
            <img src="{{ v.image.url }}" alt="{{ product.name }}">
          {% elif product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
          {% else %}
            <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}">
          {% endif %}
        </a>

        <div class="card-article">Артикул: {{ v.sku|default:product.sku|default:'—' }}</div>

        <h3 class="card-title" data-base-title="{{ product.name }}">
          {{ product.name }}{% if v %}
            {% if v.weight %} — {{ v.weight|floatformat:0 }} кг{% elif v.size %} — {{ v.size }}{% endif %}
          {% endif %}
        </h3>

        <div class="card-price">₴ {{ v.retail_price|default:product.retail_price }}</div>
      </div>

      <!-- BACK (без пігулок, лише обраний варіант) -->
      <div class="card-back">
        <a href="{{ product.get_absolute_url|default:'#' }}">
          {% if v and v.image %}
            <img src="{{ v.image.url }}" alt="{{ product.name }}">
          {% elif product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
          {% else %}
            <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}">
          {% endif %}
          <div class="card-article">Артикул: {{ v.sku|default:product.sku|default:'—' }}</div>
          <h3 class="card-title" data-base-title="{{ product.name }}">
            {{ product.name }}{% if v %}
              {% if v.weight %} — {{ v.weight|floatformat:0 }} кг{% elif v.size %} — {{ v.size }}{% endif %}
            {% endif %}
          </h3>
        </a>

        <div class="card-price">₴ {{ v.retail_price|default:product.retail_price }}</div>

        <div class="card-actions">
          <a class="btn add-to-cart"
             href="{% url 'orders:add' product.id %}{% if v %}?variant={{ v.id }}{% endif %}">
            В кошик
          </a>
          <button class="btn-fav js-fav is-on"
                  data-url="{% url 'favourites:toggle' product.id %}"
                  data-variant="{% if v %}{{ v.id }}{% endif %}"
                  aria-pressed="true">❤️</button>
        </div>
      </div>
    </div>
    {% endwith %}
  {% empty %}
    <div class="product-grid is-empty">
      <p class="no-favourites">У вас поки що немає обраних товарів. ;(</p>
    </div>
  {% endfor %}
</div>

    {% else %}
    <div class="product-grid is-empty">
      <p class="no-favourites">У вас поки що немає обраних товарів. ;(</p>
    </div>
    {% endif %}
    <script>
(function () {
  'use strict';

  /* ---------- УТИЛІТИ ---------- */
  const log = (...a) => console.debug('[card-height]', ...a);
  const $all = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  function debounce(fn, ms = 120){ let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} }
  const rerun = debounce(() => requestAnimationFrame(recomputeCardHeights), 60);

  /* ---------- СЛАЙДЕР ТОВАРІВ ---------- */
  function initProductSlider() {
    const w = document.querySelector('.product-slider');
    if (!w) return;
    const slider   = w.querySelector('.grid-slider');
    const leftBtn  = w.querySelector('.slide-btn.left');
    const rightBtn = w.querySelector('.slide-btn.right');

    const cs   = getComputedStyle(document.documentElement);
    const cardW= parseInt(cs.getPropertyValue('--prod-card-width'),10);
    const gap  = parseInt(cs.getPropertyValue('--prod-gap'),10);
    const perV = parseInt(cs.getPropertyValue('--prod-per-page'),10);
    const perS = parseInt(cs.getPropertyValue('--prod-scroll'),10);
    const total= w.querySelectorAll('.prod-card').length;

    const maxPage = Math.max(0, Math.ceil((total - perV) / perS));
    let page = 0;

    function go(delta){
      page = Math.min(maxPage, Math.max(0, page + delta));
      slider.style.transform = `translateX(-${page * perS * (cardW + gap)}px)`;
      leftBtn.style.display  = page === 0 ? 'none' : 'block';
      rightBtn.style.display = page >= maxPage ? 'none' : 'block';
      requestAnimationFrame(recomputeCardHeights); // після зсуву — перерахувати
    }
    leftBtn?.addEventListener('click',  ()=>go(-1));
    rightBtn?.addEventListener('click', ()=>go(+1));
    // первинний стан
    leftBtn && (leftBtn.style.display = 'none');
    rightBtn && (rightBtn.style.display = maxPage ? 'block':'none');
  }

/* ---------- ВИМІР ВИСОТИ КАРТКИ ---------- */
function measureBack(back){
  // тимчасово робимо видимим для правильного виміру
  const keep = {
    display: back.style.display,
    position: back.style.position,
    opacity: back.style.opacity,
    pointerEvents: back.style.pointerEvents,
    visibility: back.style.visibility,
    height: back.style.height,
    maxHeight: back.style.maxHeight
  };
  back.style.display       = 'block';
  back.style.position      = 'static';
  back.style.opacity       = '0';
  back.style.pointerEvents = 'none';
  back.style.visibility    = 'hidden';
  back.style.height        = 'auto';
  back.style.maxHeight     = 'none';

  // scrollHeight зазвичай стабільніший на прихованих елементах
  const h = Math.ceil(back.scrollHeight);

  Object.assign(back.style, keep);
  return h;
}

function recomputeCardHeights(){
  const cs  = getComputedStyle(document.documentElement);
  const MIN = parseInt(cs.getPropertyValue('--prod-min-height')) || 320;
  const MAX = parseInt(cs.getPropertyValue('--prod-max-height')) || 520;

  document.querySelectorAll('.prod-card').forEach((card, idx) => {
    const back = card.querySelector('.card-back');
    if (!back) return;

    const desired  = measureBack(back);
    const adjusted = Math.max(0, desired - 10);   // мінус 10px
    const clamped  = Math.min(MAX, Math.max(MIN, adjusted));

    card.style.setProperty('--hover-height', clamped + 'px');
    // console.log(`card #${idx}: desired=${desired} → adjusted=${adjusted} → ${clamped}`);
  });
}

  /* ---------- ТРИГЕРИ ПЕРЕРАХУНКУ ---------- */
  function initCardHeightAutofit(){
    // 1) коли все завантажилось (включно з картинками)
    if (document.readyState === 'complete') rerun();
    else window.addEventListener('load', rerun, {once:true});

    // 2) коли підтягнуться шрифти (змінюється перенесення рядків)
    if (document.fonts?.ready) document.fonts.ready.then(rerun);

    // 3) коли дозавантажиться будь-яка картинка у картках
    $all('.prod-card img').forEach(img=>{
      if (!img.complete) {
        img.addEventListener('load',  rerun, {once:true});
        img.addEventListener('error', rerun, {once:true});
      }
    });

    // 4) на зміну розміру/орієнтації
    window.addEventListener('resize', rerun);
    window.addEventListener('orientationchange', rerun);

    // 5) реагуємо на пізні зміни контенту всередині .card-back
    if ('ResizeObserver' in window) {
      const ro = new ResizeObserver(rerun);
      $all('.prod-card .card-back').forEach(el => ro.observe(el));
    }

    // 6) перший прохід + невелика страховка
    rerun();
    setTimeout(rerun, 800);
  }

  /* ---------- ТОЧКА ВХОДУ ---------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    initProductSlider();
    initCardHeightAutofit();
  });
})();
</script>
  </section>
</div>
{% endblock %}




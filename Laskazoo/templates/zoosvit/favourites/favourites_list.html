{# Zoosvit_shop/Zoosvit/templates/zoosvit/favourites/list.html - ОПТИМІЗОВАНА ВЕРСІЯ #}
{% extends 'zoosvit/core/base.html' %}
{% load static %}

{% block title %}Обране{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/favourites/ favourites_list.css' %}">
  <link rel="stylesheet" href="{% static 'zoosvit/css/users/profile.css' %}">
  <link rel="stylesheet" href="{% static 'zoosvit/css/styles.css' %}">
  <script defer src="{% static 'zoosvit/js/fav.js' %}"></script>
  <script defer src="{% static 'zoosvit/js/product_cards.js' %}"></script>
  
  <style>
    /* Оптимізовані стилі для карток товарів в улюблених */
    .favourites-page .product-grid { 
      overflow: visible; 
      position: relative;
      contain: layout; 
    }
    
    .favourites-page .prod-card { 
      height: var(--prod-min-height, 320px); 
      overflow: visible; 
      position: relative; 
      background: transparent; 
      box-shadow: none;
      transform: translateZ(0);
      will-change: z-index;
    }
    
    .favourites-page .prod-card::before {
      content: "";
      position: absolute;
      inset: 0 auto auto 0;
      right: 0;
      height: var(--prod-min-height, 320px);
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      transition: height .25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow .25s ease;
      z-index: 0;
      will-change: height, box-shadow;
    }
    
    .favourites-page .prod-card:hover { 
      z-index: 30; 
    }
    
    .favourites-page .prod-card:hover::before {
      height: clamp(
        var(--prod-min-height, 320px),
        var(--hover-height, var(--prod-min-height, 320px)),
        var(--prod-max-height, 820px)
      );
      box-shadow: 0 12px 24px rgba(0,0,0,.18);
    }
    
    .favourites-page .prod-card .card-front,
    .favourites-page .prod-card .card-back { 
      position: absolute; 
      inset: 0; 
      z-index: 1;
      backface-visibility: hidden;
    }

    /* Стилі для недоступних товарів */
    .favourites-page .prod-card.out-of-stock {
      opacity: 0.7;
    }

    .favourites-page .prod-card.out-of-stock::before {
      background: #f5f5f5;
    }

    .favourites-page .prod-card.out-of-stock .card-front img,
    .favourites-page .prod-card.out-of-stock .card-back img {
      filter: grayscale(100%);
      opacity: 0.6;
    }

    .favourites-page .prod-card.out-of-stock .card-title,
    .favourites-page .prod-card.out-of-stock .card-price,
    .favourites-page .prod-card.out-of-stock .card-article {
      color: #999;
    }

    /* Бейдж "Очікується поставка" */
    .favourites-page .prod-card.out-of-stock .card-front::after,
    .favourites-page .prod-card.out-of-stock .card-back::after {
      content: 'Очікується \A поставка';
      white-space: pre;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      color: #666;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      z-index: 10;
      box-shadow: 0 2px 12px rgba(0,0,0,0.2);
      pointer-events: none;
    }

    /* Блокуємо кнопку "В кошик" для недоступних товарів */
    .favourites-page .prod-card.out-of-stock .add-to-cart {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
      background: #ccc;
    }
  </style>
{% endblock %}

{% block content %}
<div class="profile-wrapper">

  <!-- Сайдбар -->
  <aside class="profile-sidebar">
    <ul class="profile-nav">
      {% if user.is_authenticated %}
        <li><a href="{% url 'users:profile' %}">Особисті дані</a></li>
        <li><a href="{% url 'orders:list' %}">Замовлення</a></li>
      {% endif %}

      {# Обране – завжди #}
      <li class="active"><a href="{% url 'favourites:list' %}">Обране</a></li>
    </ul>
  </aside>

  <!-- Основний контент -->
  <section class="profile-main favourites-page">
    <h1 class="profile-title">Моє обране</h1>

    {% if favs %}
      <div class="product-grid">
  {% for f in favs %}
    {% with product=f.product v=f.variant %}
    {# Перевірка чи товар недоступний #}
    {% if v %}
      {% if not v.is_active or v.warehouse_quantity == 0 %}
        {% with is_unavailable=True %}{% endwith %}
      {% else %}
        {% with is_unavailable=False %}{% endwith %}
      {% endif %}
    {% else %}
      {% if not product.is_active or product.warehouse_quantity == 0 %}
        {% with is_unavailable=True %}{% endwith %}
      {% else %}
        {% with is_unavailable=False %}{% endwith %}
      {% endif %}
    {% endif %}
    
    <div class="prod-card {% if v and not v.is_active or v and v.warehouse_quantity == 0 or not v and not product.is_active or not v and product.warehouse_quantity == 0 %}out-of-stock{% endif %}" data-product-id="{{ product.id }}">
      <!-- FRONT -->
      <div class="card-front">
        <a href="{{ product.get_absolute_url|default:'#' }}">
          {% if v and v.image %}
            <img src="{{ v.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% elif product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% else %}
            <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% endif %}
        </a>

        <div class="card-article">Артикул: {{ v.sku|default:product.sku|default:'—' }}</div>

        <h3 class="card-title" data-base-title="{{ product.name }}">
          {{ product.name }}{% if v %}
            {% if v.weight %} — {{ v.weight|floatformat:0 }} кг{% elif v.size %} — {{ v.size }}{% endif %}
          {% endif %}
        </h3>

        <div class="card-price">₴ {{ v.retail_price|default:product.retail_price }}</div>
      </div>

      <!-- BACK (без пігулок, лише обраний варіант) -->
      <div class="card-back">
        <a href="{{ product.get_absolute_url|default:'#' }}">
          {% if v and v.image %}
            <img src="{{ v.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% elif product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% else %}
            <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
          {% endif %}
          <div class="card-article">Артикул: {{ v.sku|default:product.sku|default:'—' }}</div>
          <h3 class="card-title" data-base-title="{{ product.name }}">
            {{ product.name }}{% if v %}
              {% if v.weight %} — {{ v.weight|floatformat:0 }} кг{% elif v.size %} — {{ v.size }}{% endif %}
            {% endif %}
          </h3>
        </a>

        <div class="card-price">₴ {{ v.retail_price|default:product.retail_price }}</div>

        <div class="card-actions">
          <a class="btn add-to-cart"
             href="{% url 'orders:add' product.id %}{% if v %}?variant={{ v.id }}{% endif %}">
            В кошик
          </a>
          <button class="btn-fav js-fav is-on"
                  data-url="{% url 'favourites:toggle' product.id %}"
                  data-variant="{% if v %}{{ v.id }}{% endif %}"
                  aria-pressed="true">❤️</button>
        </div>
        <div class="card-info">
          Виробник:
          {% if product.brand %}
            <a class="info-link" href="{% url 'products:brand' product.brand.brand_slug %}">{{ product.brand.name }}</a>
          {% else %} — {% endif %}
        </div>
      </div>
    </div>
    {% endwith %}
  {% endfor %}
</div>

    {% else %}
    <div class="product-grid is-empty" style="display: flex; justify-content: center; align-items: center; min-height: 300px;">
      <p class="no-favourites" style="text-align: center; font-size: 1.2rem; color: #666;">У вас поки що немає обраних товарів. ;(</p>
    </div>
    {% endif %}

{% if favs %}
{{ fav_variant_ids|json_script:"fav-variant-ids" }}

  <script>
    window.__favVarSet = new Set(JSON.parse(
      document.getElementById('fav-variant-ids').textContent || '[]'
    ));

    // Оптимізація для favourites_list
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[FAVOURITES] Page loaded, product cards optimization active');
      
      window.onCardPreloadComplete = function() {
        console.log('[FAVOURITES] All product cards optimized');
      };
    });
  </script>
{% endif %}

  </section>
</div>
{% endblock %}

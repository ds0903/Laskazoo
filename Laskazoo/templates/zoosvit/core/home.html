{% extends 'zoosvit/core/base.html' %}
{% load static %}

{% block title %}Ласка - Інтернет-магазин товарів для котів та собак | Корм, ласощі, іграшки{% endblock %}

{% block description %}Інтернет-магазин Ласка: широкий вибір кормів для котів і собак, ласощів, іграшок та аксесуарів. ✓ Якісна продукція ✓ Вигідні ціни ✓ Доставка по всій Україні{% endblock %}

{% block keywords %}корм для котів київ, корм для собак київ, зоомагазин київ, ласощі для тварин, іграшки для котів, товари для собак, зоотовари онлайн, зоомагазин інтернет{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'zoosvit/css/styles.css' %}">
  <script defer src="{% static 'zoosvit/js/variant_pills.js' %}"></script>
  <script defer src="{% static 'zoosvit/js/home_sliders.js' %}"></script>
  <script defer src="{% static 'zoosvit/js/product_cards.js' %}"></script>
  <script defer src="{% static 'zoosvit/js/fav.js' %}"></script>
  
  <style>
    /* Оптимізовані стилі для карток товарів на головній сторінці */
    
    /* ✅ ПРИБИРАЄМО ГОРИЗОНТАЛЬНУ ПРОКРУТКУ */
    body, html {
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
    }
    
    .products .grid-slider { 
      overflow: visible; 
      position: relative;
      contain: layout;
      max-width: 100%;        /* ✅ Не виходити за межі */
    }
    
    .products .prod-card { 
      height: var(--prod-min-height, 320px); 
      overflow: visible; 
      position: relative; 
      background: transparent; 
      box-shadow: none;
      transform: translateZ(0);
      will-change: z-index;
    }
    
    .products .prod-card::before {
      content: "";
      position: absolute;
      inset: 0 auto auto 0;
      right: 0;
      height: var(--prod-min-height, 320px);
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      transition: height .25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow .25s ease;
      z-index: 0;
      will-change: height, box-shadow;
    }
    
    .products .prod-card:hover { 
      z-index: 30; 
    }
    
    .products .prod-card:hover::before {
      height: clamp(
        var(--prod-min-height, 320px),
        var(--hover-height, var(--prod-min-height, 320px)),
        var(--prod-max-height, 820px)
      );
      box-shadow: 0 12px 24px rgba(0,0,0,.18);
    }
    
    .products .prod-card .card-front,
    .products .prod-card .card-back { 
      position: absolute; 
      inset: 0; 
      z-index: 1;
      backface-visibility: hidden;
    }
  </style>
{% endblock %}

{% block content %}

<section class="hero-carousel">
{% for banner in banners %}
  <div class="carousel-slide"
       style="background-image: url({{ banner.image.url }});"{% if banner.link %} data-link="{{ banner.link }}"{% endif %}>
    {% if banner.title %}
      <div class="carousel-caption">
        <h2>{{ banner.title }}</h2>
      </div>
    {% endif %}
  </div>
{% empty %}
  {# Якщо банерів немає в базі, показуємо статичні #}
  <div class="carousel-slide"
       style="background-image: url({% static 'zoosvit/img/slider/slide-1.png' %});">
  </div>
  <div class="carousel-slide"
       style="background-image: url({% static 'zoosvit/img/slider/slide-2.png' %});">
  </div>
  <div class="carousel-slide"
       style="background-image: url({% static 'zoosvit/img/slider/slide-3.png' %});">
  </div>
  <div class="carousel-slide"
       style="background-image: url({% static 'zoosvit/img/slider/slide-4.png' %});">
  </div>
{% endfor %}

<div class="carousel-nav"></div>
</section>

<section id="categories" class="categories container">
  <h2>Популярні категорії</h2>

  <div class="category-slider">
    <button class="slide-btn left" aria-label="Назад">&lt;</button>

    <div class="slider-window">
      <div class="grid-slider">

        {% for pc in popular_cats %}
          <a href="{{ pc.url }}" class="cat-card">
            {% if pc.image %}
              <img src="{{ pc.image.url }}" alt="{{ pc.title }}" loading="lazy">
            {% else %}
              <img src="{% static 'zoosvit/img/category-populare/feed_for_cats.png' %}" alt="{{ pc.title }}" loading="lazy">
            {% endif %}
            <p class="cat-title">{{ pc.title }}</p>
          </a>
        {% empty %}
          <a href="#" class="cat-card">
            <img src="{% static 'zoosvit/img/category-populare/feed_for_cats.png' %}" alt="Категорія" loading="lazy">
            <p class="cat-title">В базі відсутні популярні категорії!</p>
          </a>
        {% endfor %}

      </div>
    </div>

    <button class="slide-btn right" aria-label="Вперед">&gt;</button>
  </div>
</section>

<section id="products" class="products container">
<h2>Хіти продаж</h2>
<div class="product-slider">
  <button class="slide-btn left">&lt;</button>
    <div class="slider-window">
  <div class="grid-slider">
  {% for pp in populars %}
    {% with product=pp.product %}
    <div class="prod-card" data-product-id="{{ product.id }}">
  {# ---- FRONT ---- #}
<div class="card-front">
  {% with v0=product.variants_for_card.0 %}
    <a href="{{ product.get_absolute_url|default:'#' }}">
      {% if v0 and v0.image %}
        <img src="{{ v0.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
      {% elif product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
      {% else %}
        <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
      {% endif %}
    </a>
    {% if v0.sku %}
      <div class="card-article">Артикул: {{ v0.sku|default:'—' }}</div>
    {% endif %}
    <h3 class="card-title" data-base-title="{{ product.name }}">
      {{ product.name }}
      {% if v0 %}
        {% if v0.weight or v0.size %}
          <span class="variant-suffix">
            {% if v0.weight %} — {{ v0.weight|floatformat:0 }} кг
            {% elif v0.size %} — {{ v0.size }}{% endif %}
          </span>
        {% endif %}
      {% endif %}
    </h3>
    <div class="card-price">₴ {{ v0.retail_price|default:product.retail_price }}</div>
  {% endwith %}
</div>

  {# ---- BACK ---- #}
  <div class="card-back">
  {% with v0=product.variants_for_card.0 %}
    <a href="{{ product.get_absolute_url|default:'#' }}">
      {% if v0 and v0.image %}
        <img src="{{ v0.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
      {% elif product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
      {% else %}
        <img src="{% static 'zoosvit/img/food1.jpg' %}" alt="{{ product.name }}" loading="lazy" width="200" height="200">
      {% endif %}
      {% if v0.sku %}
        <div class="card-article">Артикул: {{ v0.sku|default:'—' }}</div>
      {% endif %}
      <h3 class="card-title" data-base-title="{{ product.name }}">
        {{ product.name }}
        {% if v0 %}
          {% if v0.weight or v0.size %}
            <span class="variant-suffix">
              {% if v0.weight %} — {{ v0.weight|floatformat:0 }} кг
              {% elif v0.size %} — {{ v0.size }}{% endif %}
            </span>
          {% endif %}
        {% endif %}
      </h3>
    </a>

    <div class="card-price">₴ {{ v0.retail_price|default:product.retail_price }}</div>

    {# ПІГУЛКИ #}
    {% if product.variants_for_card|length > 1 %}
      {% with vfirst=product.variants_for_card.0 %}
        <div class="variant-group">
          <div class="variant-label">
            {% if vfirst.weight %}Фасування{% elif vfirst.size %}Розмір{% else %}Варіанти{% endif %}
          </div>
          <div class="variant-pills" role="group" aria-label="Варіанти">
            {% for v in product.variants_for_card|slice:":3" %}
              <button
                type="button"
                class="variant-pill {% if forloop.first %}active{% endif %}"
                data-vid="{{ v.id }}"
                data-price="{{ v.retail_price }}"
                data-sku="{{ v.sku }}"
                data-weight="{{ v.weight|default:'' }}"
                data-size="{{ v.size|default:'' }}"
                data-image="{% if v.image %}{{ v.image.url }}{% elif product.image %}{{ product.image.url }}{% else %}{% static 'zoosvit/img/food1.jpg' %}{% endif %}">
                {% if v.weight %}{{ v.weight|floatformat:0 }} кг
                {% elif v.size %}{{ v.size }}
                {% else %}SKU {{ v.sku }}{% endif %}
              </button>
            {% endfor %}
          </div>
        </div>
      {% endwith %}
    {% endif %}
  {% endwith %}

  <div class="card-actions">
    {% with v0=product.variants_for_card.0 %}
  <a class="btn add-to-cart"
     href="{% url 'orders:add' product.id %}{% if v0 %}?variant={{ v0.id }}{% endif %}"
     data-add-base="{% url 'orders:add' product.id %}">
    В кошик
  </a>

  <button
    class="btn-fav js-fav {% if v0 and v0.id in fav_variant_ids %}is-on{% endif %}"
    data-url="{% url 'favourites:toggle' product.id %}"
    data-variant="{% if v0 %}{{ v0.id }}{% endif %}"
    aria-pressed="{% if v0 and v0.id in fav_variant_ids %}true{% else %}false{% endif %}">
    ❤️
  </button>
{% endwith %}
  </div>
    
    <div class="card-info">
          Виробник:
          {% if product.brand %}
            <a class="info-link" href="{% url 'products:brand' product.brand.brand_slug %}">{{ product.brand.name }}</a>
          {% else %} — {% endif %}
    </div>
</div>
</div>
    {% endwith %}
  {% empty %}
    <p>Популярні товари ще не обрані.</p>
  {% endfor %}
</div>
  </div>
  <button class="slide-btn right">&gt;</button>
    </div>
</div>
</section>

<!-- Нова секція з 3 колонками замість 4 -->
<section class="why-us-bar">
  <div class="container why-us-inner">
    <div class="why-us-item">
      <img src="{% static 'zoosvit/img/other/delivery-icon.png' %}" alt="Швидка доставка" loading="lazy">
      <p>Швидка доставка</p>
    </div>
    <div class="why-us-item">
      <img src="{% static 'zoosvit/img/other/help-icon.png' %}" alt="Найкращий рівень сервісу" loading="lazy">
      <p>Найкращий рівень сервісу</p>
    </div>
    <div class="why-us-item">
      <img src="{% static 'zoosvit/img/other/happy-icon.png' %}" alt="100% задоволені клієнти та їх пухнасті" loading="lazy">
      <p>100% задоволені клієнти та їх пухнасті</p>
    </div>
  </div>
</section>

<section id="mega-categories" class="mega-categories container">
  <div class="category-col">
    <h3 class="category-title">
      <a href="{% url 'products:subcategory_list' 'shares' %}" class="category-link">
        <img src="{% static 'zoosvit/img/category-detailed/new-icon.png' %}" alt="Акції" loading="lazy">
        Акції
      </a>
    </h3>
  </div>

  <div class="category-col">
    <h3 class="category-title">
      <a href="{% url 'products:subcategory_list' 'dogs' %}" class="category-link">
        <img src="{% static 'zoosvit/img/category-detailed/dog-icon.png' %}" alt="Собаки" loading="lazy">
        Собаки
      </a>
    </h3>
    <ul>
      <li><a href="/categories/dogs/korm-dlya-sobak/">Корм для собак</a></li>
      <li><a href="/categories/dogs/lasoshhi-dlya-sobak/">Ласощі для собак</a></li>
    </ul>
    <a href="{% url 'products:subcategory_list' 'dogs' %}" class="btn-secondary">Всі категорії</a>
  </div>

  <div class="category-col">
    <h3 class="category-title">
      <a href="{% url 'products:subcategory_list' 'cats' %}" class="category-link">
        <img src="{% static 'zoosvit/img/category-detailed/cat-icon.png' %}" alt="Коти" loading="lazy">
        Коти
      </a>
    </h3>
    <ul>
      <li><a href="/categories/cats/korm-dlya-kotiv/">Корм для котів</a></li>
      <li><a href="/categories/cats/lasoshhi-dlya-kotiv/">Ласощі для котів</a></li>
    </ul>
    <a href="{% url 'products:subcategory_list' 'cats' %}" class="btn-secondary">Всі категорії</a>
  </div>
</section>

<section id="brands" class="brands container collapsed">
  <h2>Бренди</h2>

  <div class="brands-grid core">
    <div class="brand-item">
      <a href="/categories/categories/brand/club4paws/" title="club4paws.png">
        <img src="{% static 'zoosvit/img/brands/club4paws.png' %}" alt="club4paws.png" loading="lazy">
      </a>
    </div>
    <div class="brand-item">
      <a href="/categories/categories/brand/optimeal/" title="optimeal.png">
        <img src="{% static 'zoosvit/img/brands/optimeal.png' %}" alt="optimeal.png" loading="lazy">
      </a>
    </div>
    <div class="brand-item">
      <a href="/categories/categories/brand/delickcious/" title="delickcious_Logo.png">
        <img src="{% static 'zoosvit/img/brands/delickcious_Logo.png' %}" alt="delickcious_Logo.png" loading="lazy">
      </a>
    </div>
    <div class="brand-item">
      <a href="/categories/categories/brand/myau/" title="myau.png">
        <img src="{% static 'zoosvit/img/brands/myau.png' %}" alt="myau.png" loading="lazy">
      </a>
    </div>
    <div class="brand-item">
      <a href="/categories/categories/brand/gav/" title="gav.png">
        <img src="{% static 'zoosvit/img/brands/gav.png' %}" alt="gav.png" loading="lazy">
      </a>
    </div>
  </div>
</section>

{% endblock %}

{% block extra_js %}
{{ fav_variant_ids|json_script:"fav-variant-ids" }}
<script>
  (function () {
    try {
      const data = JSON.parse(document.getElementById('fav-variant-ids').textContent || '[]');
      window.__favVarSet = new Set((data || []).map(Number));
    } catch (e) { window.__favVarSet = new Set(); }
  })();

  // Оптимізація для home page
  document.addEventListener('DOMContentLoaded', function() {
    console.log('[HOME] Page loaded, product cards optimization active');
    
    window.onCardPreloadComplete = function() {
      console.log('[HOME] All product cards optimized');
    };
  });
</script>
{% endblock %}
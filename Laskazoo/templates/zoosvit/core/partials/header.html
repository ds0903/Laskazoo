{% load static %}
{% include 'zoosvit/users/modal.html' with form=form %}
{% include 'zoosvit/orders/modal.html' %}
<script src="{% static 'zoosvit/js/login_modal.js' %}"></script>

<header class="site-header">
    <div class="site-topbar">
      <div class="container topbar-inner">
        <nav class="topbar-nav">
          <a href="{% url 'stores_map' %}">–ú–∞–≥–∞–∑–∏–Ω–∏ –õ–∞—Å–∫–∞</a>
          <a href="#payment">–û–ø–ª–∞—Ç–∞ —Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∞</a>
          <a href="#exchange">–û–±–º—ñ–Ω —Ç–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è</a>
          <a href="#contact">–ö–æ–Ω—Ç–∞–∫—Ç–∏</a>
          <a href="{% url 'products:catalog' %}">–ö–∞—Ç–∞–ª–æ–≥</a>
        </nav>
      </div>
    </div>
    <div class="site-mainheader">
      <div class="container header-inner">
        <a class="logo" href="{% url 'home' %}">
          <img src="{% static 'zoosvit/img/laska_white3__.png' %}?v=4"
               alt="–õ–∞—Å–∫–∞" width="190" height="50" />
        </a>
        <form class="search-form">
          <input type="text" placeholder="–ø–æ—à—É–∫ —Ç–æ–≤–∞—Ä—ñ–≤">
          <button type="submit">üîç</button>
        </form>
        <div class="icon-btn phone-btn">
          <img src="{% static 'zoosvit/img/header_icons/phone-icon.png' %}" alt="–¢–µ–ª–µ—Ñ–æ–Ω">
          <div class="phone-dropdown">
            <div class="dropdown-title">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –º–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤</div>
            <div class="dropdown-contact">
              <img src="{% static 'zoosvit/img/header_icons/telagram-icon.png' %}" alt="Telegram">
              <a href="https://t.me/your_username">(067) 900 1022</a>
              <small>(Telegram)</small>
            </div>
            <div class="dropdown-schedule">
              <strong>–ì—Ä–∞—Ñ—ñ–∫ —Ä–æ–±–æ—Ç–∏:</strong> –ü–Ω‚Äì–ù–¥ 9:00‚Äì18:00
            </div>
            <div class="dropdown-chats">
              <a href="viber://chat?number=+380679001022">
                <img src="{% static 'zoosvit/img/header_icons/viber-icon.png' %}" alt="Viber">
              </a>
              <a href="https://t.me/your_username">
                <img src="{% static 'zoosvit/img/header_icons/telagram-icon.png' %}" alt="Telegram">
              </a>
              <a href="https://t.me/your_username"><img src="{% static 'zoosvit/img/header_icons/instagram-icon.png' %}" alt="INST"></a>
            </div>
          </div>
        </div>
        <div class="header-actions">
          {% if user.is_authenticated %}
            <div class="icon-btn login-btn">
              <img src="{% static 'zoosvit/img/header_icons/profile-icon.png' %}" alt="User">
              <div class="login-dropdown">
                <div class="dropdown-title">–í—ñ—Ç–∞—î–º–æ, {{ user.username }}!</div>
                <div class="dropdown-chats">
                  <a href="{% url 'orders:list' %}" class="dropdown-link">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</a>
                  <a href="{% url 'favourites:list' %}" class="dropdown-link">–û–±—Ä–∞–Ω–µ</a>
                  <a href="{% url 'users:profile' %}" class="dropdown-link">–û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ</a>
                  <a href="{% url 'users:logout' %}" class="dropdown-link">–í–∏–π—Ç–∏</a>
                </div>
              </div>
            </div>
          {% else %}
            <div class="icon-btn login-btn">
              <img src="{% static 'zoosvit/img/header_icons/profile-icon.png' %}" alt="User">
              <div class="login-dropdown">
                <div class="dropdown-title">–í—Ö—ñ–¥ / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</div>
                <div class="dropdown-chats">
                  <a href="#" class="dropdown-link" id="open-login-modal">–£–≤—ñ–π—Ç–∏</a>
                  <a href="#" class="dropdown-link" id="open-register-modal">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</a>
                </div>
              </div>
            </div>
          {% endif %}

          {# —É–ª—é–±–ª–µ–Ω—ñ #}
          <a href="{% url 'favourites:list' %}" class="icon-btn header-icon" id="fav-btn" aria-label="–û–±—Ä–∞–Ω–µ">
            <img src="{% static 'zoosvit/img/header_icons/heart-icon.png' %}" alt="–û–±—Ä–∞–Ω–µ">
            <span class="icon-badge js-fav-counter"
                  {% if fav_count|default:0 <= 0 %}hidden{% endif %}>
              {{ fav_count|default:0 }}
            </span>
          </a>

          {# –∫–æ—à–∏–∫: count + total –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è #}
          <a href="#cart" class="btn-cart" aria-label="–ú—ñ–π –∫–æ—à–∏–∫">
            <img src="{% static 'zoosvit/img/header_icons/cart-icon.png' %}" alt="Cart">
            <span class="cart-count">{{ cart_qty|default:0 }}</span>
            <span class="cart-text">–ú—ñ–π –∫–æ—à–∏–∫</span>
          </a>
          <span class="cart-total">{% if cart_total %}{{ cart_total }} –≥—Ä–Ω{% else %}0 –≥—Ä–Ω{% endif %}</span>
        </div>



      </div>
    </div>
    <div class="site-bottombar">
      <div class="container topbar-inner">
        <nav class="topbar-nav">
          <a href="{% url 'products:subcategory_list' 'super-vigodniye-propozicii' %}" >–°—É–ø–µ—Ä –≤–∏–≥—ñ–¥–Ω—ñ-–ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</a>
          <a href="{% url 'products:subcategory_list' 'shares' %}">–ê–∫—Ü—ñ—ó</a>
          <a href="{% url 'products:subcategory_list' 'dogs' %}">–°–æ–±–∞–∫–∏</a>
          <a href="{% url 'products:subcategory_list' 'cats' %}">–ö–æ—Ç–∏</a>
          <a href="{% url 'products:subcategory_list' 'birds' %}">–ü—Ç–∞—Ö–∏</a>
          <a href="{% url 'products:subcategory_list' 'rodents' %}">–ì—Ä–∏–∑—É–Ω–∏</a>
          <a href="{% url 'products:subcategory_list' 'aquarium' %}">–ê–∫–≤–∞—Ä—ñ—É–º</a>
          <a href="{% url 'products:subcategory_list' 'terrarium' %}">–¢–µ—Ä–∞—Ä—ñ—É–º</a>
          <a href="{% url 'products:subcategory_list' 'brands' %}">–ë—Ä–µ–Ω–¥–∏</a>
        </nav>
      </div>
    </div>
  </header>
<script>
document.addEventListener('DOMContentLoaded', () => {
  initPhoneDropdown();
  initLoginDropdown();
});

/**
 * –¢–µ–ª–µ—Ñ–æ–Ω–Ω–∏–π –¥—Ä–æ–ø–¥–∞—É–Ω
 */
function initPhoneDropdown() {
  const btn      = document.querySelector('.phone-btn');
  const dropdown = document.querySelector('.phone-dropdown');
  if (!btn || !dropdown) return;

  let hideTimer;
  const open = () => {
    clearTimeout(hideTimer);
    dropdown.classList.add('show');
  };
  const close = () => {
    hideTimer = setTimeout(() => dropdown.classList.remove('show'), 300);
  };

  btn.addEventListener('mouseenter', open);
  btn.addEventListener('mouseleave', close);
  dropdown.addEventListener('mouseenter', open);
  dropdown.addEventListener('mouseleave', close);
}

/**
 * –î—Ä–æ–ø–¥–∞—É–Ω ¬´–í—Ö—ñ–¥/–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è¬ª
 */
function initLoginDropdown() {
  const btn      = document.querySelector('.login-btn');
  const dropdown = document.querySelector('.login-dropdown');
  if (!btn || !dropdown) return;

  let hideTimer;
  const open = () => {
    clearTimeout(hideTimer);
    dropdown.classList.add('show');
  };
  const close = () => {
    hideTimer = setTimeout(() => dropdown.classList.remove('show'), 300);
  };

  btn.addEventListener('mouseenter', open);
  btn.addEventListener('mouseleave', close);
  dropdown.addEventListener('mouseenter', open);
  dropdown.addEventListener('mouseleave', close);
}
</script>

<script>
// —É—Ç–∏–ª—ñ—Ç–∞
function updateBadge(id, n) {
  const el = document.getElementById(id);
  if (!el) return;
  if (n > 0) {
    el.textContent = n;
    el.hidden = false;
  } else {
    el.hidden = true;
  }
}

// —ñ—Å–Ω—É—é—á–∏–π —Ö–µ–Ω–¥–ª–µ—Ä –∫–ª—ñ–∫—É –ø–æ .js-fav
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.js-fav');
  if (!btn) return;
  e.preventDefault();

  try {
    const res = await fetch(btn.dataset.url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    const data = await res.json();
    if (data.ok) {
      btn.classList.toggle('active', data.state === 'added');
      btn.setAttribute('aria-pressed', data.state === 'added' ? 'true' : 'false');
      updateBadge('fav-count', data.count); // ‚Üê –æ–Ω–æ–≤–ª—é—î–º–æ –±–µ–π–¥–∂ —Å–µ—Ä—Ü—è
    }
  } catch (err) {
    console.error(err);
  }
});

// —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–µ–π–¥–∂–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', () => {
  fetch('{% url "favourites:api_count" %}')
    .then(r => r.json())
    .then(({count}) => updateBadge('fav-count', count))
    .catch(console.error);
});

</script>



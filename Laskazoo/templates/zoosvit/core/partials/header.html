{% load static %}
{% include 'zoosvit/users/modal.html' with form=form %}
{% include 'zoosvit/orders/modal.html' %}
<script src="{% static 'zoosvit/js/login_modal.js' %}"></script>

<header class="site-header">
    <div class="site-topbar">
      <div class="container topbar-inner">
        <nav class="topbar-nav">
<!--          <a href="{% url 'stores_map' %}">–ú–∞–≥–∞–∑–∏–Ω–∏ –õ–∞—Å–∫–∞</a>-->
          <a href="{% url 'info_page' 'payment-delivery' %}">–û–ø–ª–∞—Ç–∞ —Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∞</a>
          <a href="{% url 'info_page' 'returns' %}">–û–±–º—ñ–Ω —Ç–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è</a>
          <a href="#page-footer">–ö–æ–Ω—Ç–∞–∫—Ç–∏</a>
          <a href="{% url 'products:catalog' %}">–ö–∞—Ç–∞–ª–æ–≥</a>
        </nav>
      </div>
    </div>
    <div class="site-mainheader">
      <div class="container header-inner">
        <a class="logo" href="{% url 'home' %}">
          <img src="{% static 'zoosvit/img/laska_white3_.png' %}?v=4"
               alt="–õ–∞—Å–∫–∞" width="190" height="50" />
        </a>
        <form id="main-search" class="search-form" method="get"
      action="{% url 'products:quick_search' %}"
      data-disable-inline-suggest>
  <input type="text" name="q" placeholder="–ø–æ—à—É–∫ —Ç–æ–≤–∞—Ä—ñ–≤" autocomplete="off" />
  <button type="submit" aria-label="–ü–æ—à—É–∫">üîç</button>
  <div class="search-suggest" id="search-suggest" hidden></div>
</form>




        <div class="icon-btn phone-btn">
          <img src="{% static 'zoosvit/img/header_icons/phone-icon.png' %}" alt="–¢–µ–ª–µ—Ñ–æ–Ω">
          <div class="phone-dropdown">
            <div class="dropdown-title">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –º–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤</div>
            <a href="https://t.me/ds0903">
            <div class="dropdown-contact">
              <b>+38 093 238 47 30</b>
              <img src="{% static 'zoosvit/img/header_icons/telagram-icon.png' %}" alt="Telegram"
              style="margin-left: 20px;  !important">
            </div>
              </a>
            <div class="dropdown-schedule">
              <strong>–ì—Ä–∞—Ñ—ñ–∫ —Ä–æ–±–æ—Ç–∏:</strong> –ü–Ω‚Äì–ù–¥<br/>9:00 ‚Äì 20:00
            </div>
<!--            <div class="dropdown-chats">-->
<!--              <a href="viber://chat?number=+380679001022">-->
<!--                <img src="{% static 'zoosvit/img/header_icons/viber-icon.png' %}" alt="Viber">-->
<!--              </a>-->
<!--              <a href="https://t.me/your_username">-->
<!--                <img src="{% static 'zoosvit/img/header_icons/telagram-icon.png' %}" alt="Telegram">-->
<!--              </a>-->
<!--              <a href="https://t.me/your_username"><img src="{% static 'zoosvit/img/header_icons/instagram-icon.png' %}" alt="INST"></a>-->
<!--            </div>-->
          </div>
        </div>
        <div class="header-actions">
          {% if user.is_authenticated %}
            <div class="icon-btn login-btn">
              <img src="{% static 'zoosvit/img/header_icons/profile-icon.png' %}" alt="User">
              <div class="login-dropdown">
                <div class="dropdown-title">–í—ñ—Ç–∞—î–º–æ, {{ user.username }}!</div>
                <div class="dropdown-chats">
                  <a href="{% url 'orders:list' %}" class="dropdown-link">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</a>
                  <a href="{% url 'favourites:list' %}" class="dropdown-link">–û–±—Ä–∞–Ω–µ</a>
                  <a href="{% url 'users:profile' %}" class="dropdown-link">–û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ</a>
                  <a href="{% url 'users:logout' %}" class="dropdown-link">–í–∏–π—Ç–∏</a>
                </div>
              </div>
            </div>
          {% else %}
            <div class="icon-btn login-btn">
              <img src="{% static 'zoosvit/img/header_icons/profile-icon.png' %}" alt="User">
              <div class="login-dropdown">
                <div class="dropdown-title">–í—Ö—ñ–¥ / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</div>
                <div class="dropdown-chats">
                  <a href="#" class="dropdown-link" id="open-login-modal">–£–≤—ñ–π—Ç–∏</a>
                  <a href="#" class="dropdown-link" id="open-register-modal">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</a>
                </div>
              </div>
            </div>
          {% endif %}

          {# —É–ª—é–±–ª–µ–Ω—ñ #}
          <a href="{% url 'favourites:list' %}" class="icon-btn header-icon" id="fav-btn" aria-label="–û–±—Ä–∞–Ω–µ">
  <img src="{% static 'zoosvit/img/header_icons/heart-icon.png' %}" alt="–û–±—Ä–∞–Ω–µ">
  <span id="fav-count"
        class="icon-badge js-fav-count"
        data-favs-count
        data-favs-live="server"
        {% if fav_count|default:0 <= 0 %}hidden{% endif %}>
    {{ fav_count|default:0 }}
  </span>
</a>


          {# –∫–æ—à–∏–∫: count + total –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è #}
          <a href="#cart" class="btn-cart" aria-label="–ú—ñ–π –∫–æ—à–∏–∫">
            <img src="{% static 'zoosvit/img/header_icons/cart-icon.png' %}" alt="Cart">
            <span class="cart-count">{{ cart_qty|default:0 }}</span>
            <span class="cart-text">–ú—ñ–π –∫–æ—à–∏–∫</span>
          </a>
          <span class="cart-total" id="cart-total">
            {% if cart_total|floatformat:2 != "0.00" %}
              {{ cart_total }} –≥—Ä–Ω
            {% endif %}
          </span>
        </div>
      </div>
    </div>
    <div class="site-bottombar">
      <div class="container topbar-inner">
        <nav class="topbar-nav">
          <a href="{% url 'products:subcategory_list' 'shares' %}">–ê–∫—Ü—ñ—ó</a>
          <a href="{% url 'products:subcategory_list' 'dogs' %}">–°–æ–±–∞–∫–∏</a>
          <a href="{% url 'products:subcategory_list' 'cats' %}">–ö–æ—Ç–∏</a>
<!--          <a href="{% url 'products:subcategory_list' 'birds' %}">–ü—Ç–∞—Ö–∏</a>-->
<!--          <a href="{% url 'products:subcategory_list' 'rodents' %}">–ì—Ä–∏–∑—É–Ω–∏</a>-->
<!--          <a href="{% url 'products:subcategory_list' 'aquarium' %}">–ê–∫–≤–∞—Ä—ñ—É–º</a>-->
          <a href="{% url 'products:subcategory_list' 'super-vigodniye-propozicii' %}" >–°—É–ø–µ—Ä –≤–∏–≥—ñ–¥–Ω—ñ-–ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</a>

<!--          <a href="{% url 'products:subcategory_list' 'terrarium' %}">–¢–µ—Ä–∞—Ä—ñ—É–º</a>-->
<!--          <a href="{% url 'products:subcategory_list' 'brands' %}">–ë—Ä–µ–Ω–¥–∏</a>-->
        </nav>
      </div>
    </div>
</header>

<!-- –ü–æ—Ä—Ç–∞–ª –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø–æ—à—É–∫—É (–ù–ï –≤ —Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ–æ—Ä–º–∏!) -->
<div id="search-portal" class="s-portal s-portal--inline" hidden>
  <div class="s-backdrop"></div>
  <div class="s-panel" role="dialog" aria-label="–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—à—É–∫—É">
    <button class="s-close" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
    <div class="s-head">
      <div class="s-query"><span id="sq"></span></div>
    </div>
    <div class="s-body" id="s-body">
      <!-- —Ç—É—Ç –º–∞–ª—é—î–º–æ –∑–Ω–∞–π–¥–µ–Ω—ñ —Ç–æ–≤–∞—Ä–∏ -->
    </div>
  </div>
</div>

<script>
(function(){
  const form  = document.querySelector('.search-form:not([data-disable-inline-suggest])');
  if (!form) return;

  const input = form.querySelector('input[name="q"]');
  const api   = "{% url 'products:search_suggest' %}";

  const portal = document.getElementById('search-portal');
  const bodyEl = document.getElementById('s-body');
  const qEl    = document.getElementById('sq');

  let items = [];
  let active = -1;

  const debounce = (fn, ms=200)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
  const money = n => (n!=null ? `‚Ç¥ ${Number(n).toFixed(2)}` : '');
  const esc = s => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function openPortal(q, list){
    qEl.textContent = q;

    if (!list.length){
      bodyEl.innerHTML = `<div class="s-card"><div class="s-empty">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div></div>`;
    } else {
      const rows = list.map((it,i)=>`
        <div class="s-row" data-i="${i}">
          <img class="s-img"
               src="${it.image||''}" alt=""
               width="64" height="64"
               loading="lazy" decoding="async" />
          <div class="s-title">${esc(it.name)}</div>
          <div class="s-price">${money(it.price)}</div>
        </div>
      `).join('');
      bodyEl.innerHTML = `<div class="s-card">${rows}</div>`;
    }

    portal.hidden = false;
    document.documentElement.classList.add('no-scroll');
    document.body.classList.add('no-scroll');
    active = -1;
  }

  function closePortal(){
    portal.hidden = true;
    document.documentElement.classList.remove('no-scroll');
    document.body.classList.remove('no-scroll');
    active = -1;
  }

  const fetchS = debounce(async (q)=>{
    q = q.trim();
    if (q.length < 2){ closePortal(); return; }
    try{
      const r = await fetch(`${api}?q=${encodeURIComponent(q)}`, {credentials:'same-origin'});
      const data = await r.json();
      items = data.items || [];
      openPortal(q, items);
    }catch(e){
      items = [];
      openPortal(q, items);
    }
  }, 180);

  input.addEventListener('input', ()=> fetchS(input.value));

  document.addEventListener('keydown', (e)=>{
    if (portal.hidden) return;
    if (e.key === 'Escape'){ closePortal(); return; }
    if (!items.length) return;

    const rows = [...bodyEl.querySelectorAll('.s-row')];
    if (e.key === 'ArrowDown'){ e.preventDefault(); move(1, rows); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); move(-1, rows); }
    else if (e.key === 'Enter'){
  if (active >= 0 && items[active]) {
    e.preventDefault();
    window.location.href = items[active].url;
  }
}
  });

  bodyEl.addEventListener('click', (e)=>{
    const row = e.target.closest('.s-row'); if (!row) return;
    const i = Number(row.dataset.i);
    if (items[i]) openQuickModal(items[i]);
  });

  portal.querySelector('.s-backdrop').onclick = closePortal;
  portal.querySelector('.s-close').onclick = closePortal;

  function move(dir, rows){
    const n = rows.length; if (!n) return;
    active = (active + dir + n) % n;
    rows.forEach((r,i)=> r.classList.toggle('is-active', i===active));
    rows[active]?.scrollIntoView({block:'nearest'});
  }

  function openQuickModal(item){
  if (item && item.url) {
    window.location.href = item.url;
  }
}

  form.addEventListener('submit', (e)=>{
    const q = (input.value || '').trim();
    if (!q) e.preventDefault();
  });

})();

</script>

<!--–∫–Ω–æ–ø–∫–∏ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('.phone-btn');
  const dd  = btn?.querySelector('.phone-dropdown');
  if (!btn || !dd) return;

  let t;
  const open  = () => { clearTimeout(t); dd.classList.add('show'); };
  const close = () => { t = setTimeout(() => dd.classList.remove('show'), 150); };

  btn.addEventListener('mouseenter', open);
  btn.addEventListener('mouseleave', close);
  dd .addEventListener('mouseenter', open);
  dd .addEventListener('mouseleave', close);
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('.login-btn');
  const dd  = btn?.querySelector('.login-dropdown');
  if (!btn || !dd) return;

  let t;
  const open  = () => { clearTimeout(t); dd.classList.add('show'); };
  const close = () => { t = setTimeout(() => dd.classList.remove('show'), 150); };

  btn.addEventListener('mouseenter', open);
  btn.addEventListener('mouseleave', close);
  dd .addEventListener('mouseenter', open);
  dd .addEventListener('mouseleave', close);
});
</script>
<!--–∫–Ω–æ–ø–∫–∏ -->


<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const f = document.querySelector('.search-form');
  if (!f) return;
  f.addEventListener('submit', e=>{
    const q = (f.querySelector('input[name="q"]')?.value || '').trim();
    if (!q) e.preventDefault();
  });
});
</script>


<script>
document.addEventListener('DOMContentLoaded', async () => {
  const badge = document.querySelector('[data-favs-count], .js-fav-count, .icon-badge.js-fav-counter');
  if (!badge) return;
  try {
    const r = await fetch('{% url "favourites:api_count" %}', {credentials:'same-origin'});
    if (!r.ok) return;
    const {count=0} = await r.json();
    badge.textContent = String(count);
    badge.hidden = count <= 0;
  } catch(e) {}
});
</script>

<script>
(function(){
  const form   = document.getElementById('main-search');
  if (!form) return;

  const input  = form.querySelector('input[name="q"]');
  const api    = "{% url 'products:search_suggest' %}";

  const portal = document.getElementById('search-portal');
  const panel  = portal.querySelector('.s-panel');
  const bodyEl = document.getElementById('s-body');

  let items = [];
  let active = -1;

  const debounce = (fn, ms=200)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
  const money = n => (n!=null ? `‚Ç¥ ${Number(n).toFixed(2)}` : '');
  const esc   = s => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // –ø–æ–∑–∏—Ü—ñ—é—î–º–æ –∫–∞—Ä—Ç–∫—É –ø—ñ–¥ –ø–æ–ª–µ–º –ø–æ—à—É–∫—É
  function positionPanel(){
    const r = form.getBoundingClientRect();
    const pad = 2; // –Ω–µ–≤–µ–ª–∏–∫–∏–π –≤—ñ–¥—Å—Ç—É–ø
    Object.assign(panel.style, {
      left:  (r.left) + 'px',
      top:   (r.bottom + pad) + 'px',
      width: (r.width) + 'px',
      maxWidth: Math.min(r.width, 760) + 'px'
    });
  }

  function openPortal(list){
    if (!list.length){
      bodyEl.innerHTML = `<div class="s-card"><div class="s-empty">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div></div>`;
    } else {
      const rows = list.map((it,i)=>`
        <div class="s-row" data-i="${i}">
          <img class="s-img" src="${it.image||''}" alt="" width="64" height="64" loading="lazy" decoding="async" />
          <div class="s-title">${esc(it.name)}</div>
          <div class="s-price">${money(it.price)}</div>
        </div>`).join('');
      bodyEl.innerHTML = rows;
    }
    portal.hidden = false;
    positionPanel();
    active = -1;
  }

  function closePortal(){
    portal.hidden = true;
    active = -1;
  }

  const fetchS = debounce(async (q)=>{
    q = q.trim();
    if (q.length < 2){ closePortal(); return; }
    try{
      const r = await fetch(`${api}?q=${encodeURIComponent(q)}`, {credentials:'same-origin'});
      const data = await r.json();
      items = data.items || [];
      openPortal(items);
    }catch(e){
      items = [];
      openPortal(items);
    }
  }, 180);

  input.addEventListener('input', ()=> fetchS(input.value));

  // –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞
  document.addEventListener('keydown', (e)=>{
    if (portal.hidden) return;
    if (e.key === 'Escape'){ closePortal(); return; }
    if (!items.length) return;

    const rows = [...bodyEl.querySelectorAll('.s-row')];
    if (e.key === 'ArrowDown'){ e.preventDefault(); move(1, rows); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); move(-1, rows); }
    else if (e.key === 'Enter'){
      if (active>=0 && items[active]?.url){ e.preventDefault(); window.location.href = items[active].url; }
    }
  });

  function move(dir, rows){
    const n = rows.length; if (!n) return;
    active = (active + dir + n) % n;
    rows.forEach((r,i)=> r.classList.toggle('is-active', i===active));
    rows[active]?.scrollIntoView({block:'nearest'});
  }

  // –∫–ª—ñ–∫ –ø–æ —Ä—è–¥–∫—É => –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É —Ç–æ–≤–∞—Ä—É
  bodyEl.addEventListener('click', (e)=>{
    const row = e.target.closest('.s-row'); if (!row) return;
    const i = Number(row.dataset.i);
    if (items[i]?.url) window.location.href = items[i].url;
  });

  // –∫–ª—ñ–∫ –ø–æ–∑–∞ –∫–∞—Ä—Ç–∫–æ—é –∞–±–æ –ø–æ —Ö—Ä–µ—Å—Ç–∏–∫—É ‚Äî –∑–∞–∫—Ä–∏—Ç–∏
  portal.querySelector('.s-close').onclick = closePortal;
  document.addEventListener('click', (e)=>{
    if (portal.hidden) return;
    if (!panel.contains(e.target) && !form.contains(e.target)) closePortal();
  });

  // —Ç—Ä–∏–º–∞—Ç–∏ –∫–∞—Ä—Ç–∫—É –ø—ñ–¥ –ø–æ–ª–µ–º –ø—Ä–∏ —Å–∫—Ä–æ–ª—ñ/—Ä–µ—Å–∞–π–∑—ñ
  window.addEventListener('resize', positionPanel, {passive:true});
  window.addEventListener('scroll', positionPanel, {passive:true});

  // —Å–∞–±–º—ñ—Ç –±–µ–∑ –ø–æ—Ä–æ–∂–Ω—å–æ–≥–æ –∑–∞–ø–∏—Ç—É
  form.addEventListener('submit', (e)=>{
    const q = (input.value || '').trim();
    if (!q) e.preventDefault();
  });
})();
</script>


<script>
// —É—Ç–∏–ª—ñ—Ç–∞
function updateBadge(id, n) {
  const el = document.getElementById(id);
  if (!el) return;
  if (n > 0) {
    el.textContent = n;
    el.hidden = false;
  } else {
    el.hidden = true;
  }
}


// —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–µ–π–¥–∂–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', () => {
  fetch('{% url "favourites:api_count" %}')
    .then(r => r.json())
    .then(({count}) => updateBadge('fav-count', count))
    .catch(console.error);
});

</script>
<!--—Å–∫—Ä–∏–ø—Ç —è–∫–∏–π –ø—ñ–¥—Ç—è–≥—É—é –æ–±—Ä–∞–Ω–µ -->
{{ fav_variant_ids|json_script:"fav-variant-ids" }}
{{ fav_product_ids|json_script:"fav-product-ids" }}
<script>
(function(){
  try {
    const v = JSON.parse(document.getElementById('fav-variant-ids')?.textContent || '[]').map(Number);
    const p = JSON.parse(document.getElementById('fav-product-ids')?.textContent || '[]').map(Number);
    window.__favVarSet  = new Set(v);
    window.__favProdSet = new Set(p);
  } catch(e) {
    window.__favVarSet  = window.__favVarSet  || new Set();
    window.__favProdSet = window.__favProdSet || new Set();
  }
})();
</script>

<!--–ø–æ—à—É–∫ -->

<div id="quick-modal" class="qm" hidden>
  <div class="qm__backdrop"></div>
  <div class="qm__dialog">
    <button class="qm__close" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
    <div class="qm__body" id="quick-modal-body">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
  </div>
</div>
<style>.qm[hidden]{ display:none; }
.qm__backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.4); }
.qm__dialog{ position:fixed; inset:auto 0 0 0; margin:auto; top:10vh; width:min(720px, 92vw);
  background:#fff; border-radius:16px; box-shadow:0 24px 60px rgba(0,0,0,.25); padding:16px; z-index:3000; }
.qm__close{ position:absolute; right:10px; top:8px; font-size:22px; background:transparent; border:0; cursor:pointer; }
</style>
<script>
function openModal(item){
  const m = document.getElementById('quick-modal');
  const b = document.getElementById('quick-modal-body');
  m.hidden = false;
  // –Ω–∞–π–ø—Ä–æ—Å—Ç—ñ—à–µ ‚Äî –≤–±—É–¥—É–≤–∞—Ç–∏ –º—ñ–Ω—ñ-–∫–∞—Ä—Ç–∫—É –∑ —Ç–æ–≥–æ —â–æ —î
  b.innerHTML = `
    <div style="display:grid;grid-template-columns:120px 1fr;gap:16px;align-items:start">
      <img src="${item.image||''}" alt="" style="width:120px;height:120px;object-fit:cover;border-radius:12px;background:#eee">
      <div>
        <h3 style="margin:0 0 6px 0">${item.name}</h3>
        <div style="font-weight:700;margin-bottom:12px">${item.price!=null?('‚Ç¥ '+Number(item.price).toFixed(2)):''}</div>
        <a class="btn" href="${item.url}">–í—ñ–¥–∫—Ä–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É —Ç–æ–≤–∞—Ä—É</a>
      </div>
    </div>`;
  const close = ()=> m.hidden = true;
  m.querySelector('.qm__backdrop').onclick = close;
  m.querySelector('.qm__close').onclick = close;
}
</script>


{% extends 'manager/base.html' %}

{% block manager_content %}
<div class="manager-header">
  <h1>‚≠ê –•—ñ—Ç–∏ –ø—Ä–æ–¥–∞–∂</h1>
  <button onclick="document.getElementById('add-modal').style.display='flex'" 
          style="padding: 10px 20px; background: var(--color-primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
    + –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä
  </button>
</div>

<p style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
  üí° <strong>–ü—ñ–¥–∫–∞–∑–∫–∞:</strong> –ü–µ—Ä–µ—Ç—è–≥—É–π—Ç–µ —Ä—è–¥–∫–∏ –º–∏—à–∫–æ—é –¥–ª—è –∑–º—ñ–Ω–∏ –ø–æ—Ä—è–¥–∫—É –ø–æ–∫–∞–∑—É
</p>

<table style="width: 100%; border-collapse: collapse;">
  <thead>
    <tr style="background: #f8f9fa;">
      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; width: 60px;">‚Ññ</th>
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">–¢–æ–≤–∞—Ä</th>
      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">–®—Ç—Ä–∏—Ö-–∫–æ–¥</th>
      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">–°—Ç–∞—Ç—É—Å</th>
      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">–î—ñ—ó</th>
    </tr>
  </thead>
  <tbody id="products-list">
    {% for item in popular_products %}
    <tr class="product-row" data-id="{{ item.id }}" draggable="true" style="border-bottom: 1px solid #dee2e6; cursor: move;">
      <td style="padding: 12px; text-align: center;">
        <span style="background: var(--color-primary); color: white; padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 1.1rem;">
          {{ forloop.counter }}
        </span>
      </td>
      <td style="padding: 12px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          {% if item.product.image %}
            <img src="{{ item.product.image.url }}" alt="" style="width: 50px; height: 50px; object-fit: contain; border-radius: 4px;">
          {% endif %}
          <strong>{{ item.product.name }}</strong>
        </div>
      </td>
      <td style="padding: 12px; font-family: monospace; font-size: 0.95rem;">{{ item.product.barcode|default:"‚Äî" }}</td>
      <td style="padding: 12px; text-align: center;">
        {% if item.is_active %}
          <span style="color: #28a745; font-weight: 600;">‚úì –ê–∫—Ç–∏–≤–Ω–∏–π</span>
        {% else %}
          <span style="color: #dc3545; font-weight: 600;">‚úó –ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π</span>
        {% endif %}
      </td>
      <td style="padding: 12px; text-align: center;">
        <button onclick="editItem({{ item.id }}, {{ item.is_active|lower }})" 
                style="padding: 6px 12px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
          –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
        </button>
        <button onclick="deleteItem({{ item.id }})" 
                style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
          –í–∏–¥–∞–ª–∏—Ç–∏
        </button>
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="5" style="padding: 30px; text-align: center; color: #666;">
        –ü–æ–ø—É–ª—è—Ä–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤ —â–µ –Ω–µ–º–∞—î. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à–∏–π!
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∑ AJAX –ø–æ—à—É–∫–æ–º -->
<div id="add-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
  <div style="background: white; padding: 30px; border-radius: 10px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
    <h3 style="margin-top: 0;">–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä –≤ –¢–û–ü</h3>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">–ü–æ—à—É–∫ —Ç–æ–≤–∞—Ä—É:</label>
      <input type="text" id="search-product" 
             placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É, –∞—Ä—Ç–∏–∫—É–ª –∞–±–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥..." 
             style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      <div id="search-loader" style="display: none; margin-top: 10px; color: #6c757d; text-align: center;">
        üîç –®—É–∫–∞—î–º–æ —Ç–æ–≤–∞—Ä–∏...
      </div>
    </div>
    
    <form id="add-form">
      {% csrf_token %}
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">–¢–æ–≤–∞—Ä:</label>
        <select name="product_id" id="product-select" required size="12" 
                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
          <option value="">–ü–æ—á–Ω—ñ—Ç—å –ø–æ—à—É–∫...</option>
        </select>
        <div style="margin-top: 8px; color: #6c757d; font-size: 0.85rem;">
          üí° –í–≤–µ–¥—ñ—Ç—å –º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏ –¥–ª—è –ø–æ—à—É–∫—É
        </div>
      </div>
      <div style="display: flex; gap: 10px;">
        <button type="submit" style="flex: 1; padding: 10px; background: var(--color-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
          –î–æ–¥–∞—Ç–∏
        </button>
        <button type="button" onclick="closeAddModal()" 
                style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
          –°–∫–∞—Å—É–≤–∞—Ç–∏
        </button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è -->
<div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
  <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
    <h3 style="margin-top: 0;">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</h3>
    <form id="edit-form">
      {% csrf_token %}
      <input type="hidden" id="edit-id">
      <div style="margin-bottom: 15px;">
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="checkbox" id="edit-is-active" name="is_active" style="margin-right: 8px;">
          <span>–ê–∫—Ç–∏–≤–Ω–∏–π</span>
        </label>
      </div>
      <div style="display: flex; gap: 10px;">
        <button type="submit" style="flex: 1; padding: 10px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer;">
          –ó–±–µ—Ä–µ–≥—Ç–∏
        </button>
        <button type="button" onclick="document.getElementById('edit-modal').style.display='none'" 
                style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
          –°–∫–∞—Å—É–≤–∞—Ç–∏
        </button>
      </div>
    </form>
  </div>
</div>

<script>
let searchTimeout = null;

// AJAX –ø–æ—à—É–∫ —Ç–æ–≤–∞—Ä—ñ–≤
document.getElementById('search-product')?.addEventListener('input', (e) => {
  const query = e.target.value.trim();
  
  if (searchTimeout) {
    clearTimeout(searchTimeout);
  }
  
  if (query.length < 2) {
    document.getElementById('product-select').innerHTML = '<option value="">–í–≤–µ–¥—ñ—Ç—å –º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏...</option>';
    return;
  }
  
  document.getElementById('search-loader').style.display = 'block';
  
  searchTimeout = setTimeout(async () => {
    try {
      const response = await fetch(`/manager/api/search-products/?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      const select = document.getElementById('product-select');
      
      if (data.products && data.products.length > 0) {
        let html = '';
        data.products.forEach(product => {
          html += `<option value="${product.id}">`;
          html += `${product.name}`;
          if (product.barcode) html += ` (${product.barcode})`;
          if (product.sku) html += ` [${product.sku}]`;
          html += `</option>`;
        });
        select.innerHTML = html;
      } else {
        select.innerHTML = '<option value="">–¢–æ–≤–∞—Ä–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</option>';
      }
    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É:', error);
      document.getElementById('product-select').innerHTML = '<option value="">–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É</option>';
    } finally {
      document.getElementById('search-loader').style.display = 'none';
    }
  }, 500); // –ó–∞—Ç—Ä–∏–º–∫–∞ 500–º—Å –¥–ª—è –∑–º–µ–Ω—à–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∑–∞–ø–∏—Ç—ñ–≤
});

function closeAddModal() {
  document.getElementById('add-modal').style.display='none';
  document.getElementById('search-product').value = '';
  document.getElementById('product-select').innerHTML = '<option value="">–ü–æ—á–Ω—ñ—Ç—å –ø–æ—à—É–∫...</option>';
}

// Drag & Drop
let draggedElement = null;

document.addEventListener('DOMContentLoaded', () => {
  const rows = document.querySelectorAll('.product-row');
  
  rows.forEach(row => {
    row.addEventListener('dragstart', handleDragStart);
    row.addEventListener('dragover', handleDragOver);
    row.addEventListener('drop', handleDrop);
    row.addEventListener('dragend', handleDragEnd);
  });
});

function handleDragStart(e) {
  draggedElement = this;
  this.style.opacity = '0.4';
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  
  if (draggedElement !== this) {
    const tbody = document.getElementById('products-list');
    const allRows = [...tbody.querySelectorAll('.product-row')];
    const draggedIndex = allRows.indexOf(draggedElement);
    const targetIndex = allRows.indexOf(this);
    
    if (draggedIndex < targetIndex) {
      this.parentNode.insertBefore(draggedElement, this.nextSibling);
    } else {
      this.parentNode.insertBefore(draggedElement, this);
    }
    
    updatePositions();
  }
  
  return false;
}

function handleDragEnd(e) {
  this.style.opacity = '1';
}

async function updatePositions() {
  const tbody = document.getElementById('products-list');
  const rows = tbody.querySelectorAll('.product-row');
  const order = [];
  
  rows.forEach((row, index) => {
    order.push({
      id: parseInt(row.dataset.id),
      position: index
    });
    
    const badge = row.querySelector('span');
    if (badge) {
      badge.textContent = index + 1;
    }
  });
  
  try {
    const response = await fetch('/manager/api/reorder-popular-products/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ order: order })
    });
    
    const data = await response.json();
    
    if (!data.success) {
      alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –ø–æ—Ä—è–¥–∫—É');
      location.reload();
    }
  } catch (error) {
    console.error('–ü–æ–º–∏–ª–∫–∞:', error);
  }
}

document.getElementById('add-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  
  const tbody = document.getElementById('products-list');
  const currentCount = tbody.querySelectorAll('.product-row').length;
  formData.append('position', currentCount);
  
  try {
    const response = await fetch("{% url 'manager:popular_product_add' %}", {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('–¢–æ–≤–∞—Ä –¥–æ–¥–∞–Ω–æ –≤ –¢–û–ü!');
      location.reload();
    } else {
      alert('–ü–æ–º–∏–ª–∫–∞: ' + (data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
    }
  } catch (error) {
    alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
  }
});

document.getElementById('edit-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('edit-id').value;
  const formData = new FormData(e.target);
  
  if (document.getElementById('edit-is-active').checked) {
    formData.append('is_active', 'true');
  } else {
    formData.append('is_active', 'false');
  }
  
  try {
    const response = await fetch(`/manager/popular-products/${id}/update/`, {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('–¢–æ–≤–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ!');
      location.reload();
    } else {
      alert('–ü–æ–º–∏–ª–∫–∞: ' + (data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
    }
  } catch (error) {
    alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
  }
});

function editItem(id, isActive) {
  document.getElementById('edit-id').value = id;
  document.getElementById('edit-is-active').checked = isActive;
  document.getElementById('edit-modal').style.display = 'flex';
}

async function deleteItem(id) {
  if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç–æ–≤–∞—Ä –∑ –¢–û–ü?')) return;
  
  try {
    const response = await fetch(`/manager/popular-products/${id}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('–¢–æ–≤–∞—Ä –≤–∏–¥–∞–ª–µ–Ω–æ –∑ –¢–û–ü!');
      location.reload();
    } else {
      alert('–ü–æ–º–∏–ª–∫–∞: ' + (data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
    }
  } catch (error) {
    alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
  }
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

<style>
.product-row {
  transition: opacity 0.3s ease, background-color 0.2s ease;
}

.product-row:hover {
  background-color: #f8f9fa;
}
</style>
{% endblock %}
